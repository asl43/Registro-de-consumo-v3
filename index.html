<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Registro de Consumo v4.0</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }
    
    :root {
        --primary: #1e88e5;
        --secondary: #26a69a;
        --accent: #ff6f00;
        --success: #43a047;
        --error: #e53935;
        --warning: #fb8c00;
        --dark: #212121;
        --light: #f5f5f5;
        --border: #e0e0e0;
        --shadow: 0 2px 8px rgba(0,0,0,0.1);
        --shadow-lg: 0 4px 16px rgba(0,0,0,0.15);
        --bg-gradient-start: #667eea;
        --bg-gradient-end: #764ba2;
        --card-bg: #ffffff;
        --text-color: #212121;
        --text-secondary: #666;
    }

    [data-theme="dark"] {
        --dark: #f5f5f5;
        --light: #2a2a2a;
        --border: #444;
        --card-bg: #1e1e1e;
        --text-color: #e0e0e0;
        --text-secondary: #aaa;
        --bg-gradient-start: #2c3e50;
        --bg-gradient-end: #1a1a2e;
    }
    
    body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
        min-height: 100vh;
        padding: 20px;
        color: var(--text-color);
        transition: all 0.3s ease;
    }
    
    .container {
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
        animation: fadeInDown 0.6s ease;
        position: relative;
    }
    
    .header h1 {
        font-size: clamp(28px, 5vw, 42px);
        font-weight: 700;
        margin-bottom: 8px;
        text-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    
    .header p {
        font-size: 16px;
        opacity: 0.95;
    }

    .theme-toggle {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        background: var(--card-bg);
        border: 2px solid var(--border);
        border-radius: 50px;
        padding: 10px 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: var(--shadow-lg);
        transition: all 0.3s;
    }

    .theme-toggle:hover {
        transform: scale(1.05);
    }

    .theme-toggle .material-icons {
        font-size: 24px;
        color: var(--primary);
    }
    
    .status-bar {
        background: var(--card-bg);
        padding: 15px 25px;
        border-radius: 12px;
        box-shadow: var(--shadow-lg);
        margin-bottom: 25px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 15px;
        animation: fadeIn 0.6s ease;
    }
    
    .status-item {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .status-item .material-icons {
        font-size: 24px;
        color: var(--primary);
    }
    
    .status-text {
        font-size: 14px;
        color: var(--text-secondary);
    }
    
    .status-value {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-color);
    }
    
    .card {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 25px;
        box-shadow: var(--shadow);
        margin-bottom: 25px;
        animation: fadeInUp 0.6s ease;
    }
    
    .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--light);
    }

    .card-title {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .card-header .material-icons {
        font-size: 28px;
        color: var(--primary);
    }
    
    .card-header h2 {
        font-size: 20px;
        font-weight: 600;
        color: var(--text-color);
    }

    .card-actions {
        display: flex;
        gap: 10px;
    }
    
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
    }
    
    .form-group {
        margin-bottom: 18px;
    }
    
    .form-group label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        color: var(--text-color);
        margin-bottom: 8px;
    }
    
    .form-group input,
    .form-group select {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid var(--border);
        border-radius: 8px;
        font-size: 15px;
        font-family: inherit;
        transition: all 0.3s;
        background: var(--card-bg);
        color: var(--text-color);
    }
    
    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.1);
    }
    
    .form-group input:read-only {
        background: var(--light);
        color: var(--text-secondary);
        font-weight: 600;
        cursor: not-allowed;
    }
    
    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        text-decoration: none;
        white-space: nowrap;
    }
    
    .btn-primary {
        background: var(--primary);
        color: white;
        box-shadow: 0 4px 12px rgba(30, 136, 229, 0.3);
    }
    
    .btn-primary:hover:not(:disabled) {
        background: #1976d2;
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(30, 136, 229, 0.4);
    }
    
    .btn-primary:disabled {
        background: #bdbdbd;
        cursor: not-allowed;
        transform: none;
    }
    
    .btn-secondary {
        background: var(--secondary);
        color: white;
    }
    
    .btn-secondary:hover:not(:disabled) {
        background: #00897b;
        transform: translateY(-2px);
    }

    .btn-warning {
        background: var(--warning);
        color: white;
    }
    
    .btn-warning:hover:not(:disabled) {
        background: #f9a825;
        transform: translateY(-2px);
    }

    .btn-danger {
        background: var(--error);
        color: white;
        padding: 8px 16px;
        font-size: 14px;
    }
    
    .btn-danger:hover:not(:disabled) {
        background: #c62828;
        transform: translateY(-1px);
    }

    .btn-edit {
        background: var(--primary);
        color: white;
        padding: 8px 16px;
        font-size: 14px;
        margin-right: 8px;
    }
    
    .btn-edit:hover:not(:disabled) {
        background: #1976d2;
        transform: translateY(-1px);
    }

    .btn-icon {
        padding: 8px;
        width: 40px;
        height: 40px;
        border-radius: 8px;
    }
    
    .btn-full {
        width: 100%;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: var(--card-bg);
        padding: 25px;
        border-radius: 12px;
        box-shadow: var(--shadow);
        text-align: center;
        position: relative;
        overflow: hidden;
        transition: all 0.3s;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }
    
    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary), var(--secondary));
    }
    
    .stat-icon {
        font-size: 48px;
        margin-bottom: 10px;
    }
    
    .stat-label {
        font-size: 13px;
        color: var(--text-secondary);
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .stat-value {
        font-size: 32px;
        font-weight: 700;
        color: var(--text-color);
    }
    
    .stat-value-currency {
        font-size: 32px;
        font-weight: 700;
        color: var(--success);
    }

    .trend-indicator {
        display: inline-flex;
        align-items: center;
        font-size: 14px;
        margin-top: 8px;
        padding: 4px 12px;
        border-radius: 20px;
        font-weight: 500;
    }

    .trend-up {
        background: #ffebee;
        color: var(--error);
    }

    .trend-down {
        background: #e8f5e9;
        color: var(--success);
    }

    .trend-neutral {
        background: var(--light);
        color: var(--text-secondary);
    }

    .chart-container {
        position: relative;
        height: 400px;
        margin-top: 20px;
    }

    .chart-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 2px solid var(--border);
    }

    .chart-tab {
        padding: 12px 24px;
        background: transparent;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        font-weight: 600;
        color: var(--text-secondary);
        transition: all 0.3s;
    }

    .chart-tab.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
    }

    .chart-tab:hover {
        color: var(--primary);
    }
    
    .filter-container {
        background: var(--light);
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 2px solid var(--border);
    }
    
    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        align-items: end;
    }
    
    .filter-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 15px;
    }

    .search-box {
        position: relative;
        margin-bottom: 15px;
    }

    .search-box input {
        width: 100%;
        padding: 12px 15px 12px 45px;
        border: 2px solid var(--border);
        border-radius: 8px;
        font-size: 15px;
        background: var(--card-bg);
        color: var(--text-color);
    }

    .search-box .material-icons {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
    }
    
    .table-container {
        overflow-x: auto;
        border-radius: 8px;
        border: 1px solid var(--border);
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
        min-width: 800px;
    }
    
    table thead {
        background: var(--dark);
        color: white;
    }
    
    table thead th {
        padding: 14px 16px;
        font-size: 13px;
        font-weight: 600;
        text-align: left;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        cursor: pointer;
        user-select: none;
    }

    table thead th:hover {
        background: rgba(255,255,255,0.1);
    }

    table thead th .sort-icon {
        font-size: 16px;
        vertical-align: middle;
        margin-left: 5px;
        opacity: 0.5;
    }

    table thead th.sorted .sort-icon {
        opacity: 1;
    }
    
    table tbody tr {
        border-bottom: 1px solid var(--border);
        transition: background 0.2s;
    }
    
    table tbody tr:hover {
        background: var(--light);
    }
    
    table tbody td {
        padding: 14px 16px;
        font-size: 14px;
        color: var(--text-color);
    }

    table tbody tr.offline-row {
        background: #fff8e1;
        font-weight: 500;
    }

    [data-theme="dark"] table tbody tr.offline-row {
        background: #3e2723;
    }
    
    .badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .badge-agua {
        background: #e3f2fd;
        color: #1976d2;
    }
    
    .badge-energia {
        background: #fff3e0;
        color: #f57c00;
    }

    .badge-offline {
        background: #ffecb3;
        color: #ffa000;
    }
    
    .alert {
        padding: 14px 18px;
        border-radius: 8px;
        margin-top: 15px;
        display: none;
        align-items: center;
        gap: 10px;
        font-size: 14px;
        font-weight: 500;
    }
    
    .alert.show {
        display: flex;
    }
    
    .alert-success {
        background: #e8f5e9;
        color: #2e7d32;
        border-left: 4px solid var(--success);
    }
    
    .alert-error {
        background: #ffebee;
        color: #c62828;
        border-left: 4px solid var(--error);
    }
    
    .alert-warning {
        background: #fffde7;
        color: #f57f17;
        border-left: 4px solid var(--warning);
    }
    
    .loading {
        display: inline-block;
        width: 18px;
        height: 18px;
        border: 3px solid rgba(255,255,255,0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.5);
        padding-top: 60px;
    }

    .modal-content {
        background-color: var(--card-bg);
        margin: 5% auto;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        width: 90%;
        max-width: 700px;
        position: relative;
        animation: fadeIn 0.3s;
    }

    .close-btn {
        color: var(--text-secondary);
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .close-btn:hover,
    .close-btn:focus {
        color: var(--text-color);
        text-decoration: none;
    }
    
    .consumption-display {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-top: 15px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    
    .consumption-display h3 {
        font-size: 16px;
        margin-bottom: 10px;
        opacity: 0.9;
    }
    
    .consumption-value {
        font-size: 36px;
        font-weight: 700;
        text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .daily-consumption-table {
        margin-top: 20px;
    }

    .daily-consumption-table table {
        min-width: 400px;
    }

    .autocomplete-items {
        position: absolute;
        border: 1px solid var(--border);
        border-top: none;
        z-index: 99;
        top: 100%;
        left: 0;
        right: 0;
        max-height: 200px;
        overflow-y: auto;
        background: var(--card-bg);
        border-radius: 0 0 8px 8px;
        box-shadow: var(--shadow);
    }

    .autocomplete-items div {
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid var(--border);
        color: var(--text-color);
    }

    .autocomplete-items div:hover {
        background: var(--light);
    }

    .keyboard-shortcuts {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--card-bg);
        padding: 15px;
        border-radius: 8px;
        box-shadow: var(--shadow-lg);
        font-size: 12px;
        display: none;
        z-index: 999;
    }

    .keyboard-shortcuts.show {
        display: block;
    }

    .keyboard-shortcuts h4 {
        margin-bottom: 10px;
        color: var(--text-color);
    }

    .keyboard-shortcuts kbd {
        background: var(--light);
        border: 1px solid var(--border);
        border-radius: 4px;
        padding: 2px 6px;
        font-family: monospace;
        color: var(--text-color);
    }

    .formula-card {
        transition: all 0.3s;
    }

    .formula-card:has(input:checked) {
        border-color: var(--primary) !important;
        box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.1);
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    @keyframes fadeInDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    @media print {
        .btn, .filter-container, .card-header, .theme-toggle {
            display: none !important;
        }
        
        body {
            background: white;
        }
        
        .card {
            box-shadow: none;
            border: 1px solid #000;
        }
    }

    @media (max-width: 768px) {
        body {
            padding: 15px;
        }
        
        .card {
            padding: 20px;
        }
        
        .form-grid {
            grid-template-columns: 1fr;
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .status-bar {
            flex-direction: column;
            align-items: flex-start;
        }

        .filter-grid {
            grid-template-columns: 1fr;
        }

        table {
             min-width: 600px;
        }

        .theme-toggle {
            top: 10px;
            right: 10px;
            padding: 8px 12px;
        }

        .chart-container {
            height: 300px;
        }
    }
</style>
</head>

<body>

<div class="theme-toggle" onclick="toggleTheme()">
    <span class="material-icons" id="themeIcon">dark_mode</span>
    <span id="themeText">Escuro</span>
</div>

<div class="keyboard-shortcuts" id="keyboardShortcuts">
    <h4>‚å®Ô∏è Atalhos de Teclado</h4>
    <p><kbd>Ctrl</kbd> + <kbd>S</kbd> - Salvar configura√ß√£o</p>
    <p><kbd>Esc</kbd> - Fechar modal</p>
    <p><kbd>?</kbd> - Mostrar/ocultar atalhos</p>
</div>

<div class="container">
    <div class="header">
        <h1>üíß‚ö° Sistema de Registro de Consumo v4.0</h1>
        <p>Controle inteligente com gr√°ficos, modo escuro e edi√ß√£o online</p>
    </div>
    
    <div class="status-bar">
        <div class="status-item">
            <span class="material-icons">cloud</span>
            <div>
                <div class="status-text">Status da Conex√£o</div>
                <div class="status-value" id="connectionStatus">Verificando...</div>
            </div>
        </div>
        <div class="status-item">
            <span class="material-icons">update</span>
            <div>
                <div class="status-text">√öltima Atualiza√ß√£o</div>
                <div class="status-value" id="lastUpdate">--:--</div>
            </div>
        </div>
        <div class="status-item">
            <span class="material-icons">storage</span>
            <div>
                <div class="status-text">Total de Registros</div>
                <div class="status-value" id="totalRecords">0</div>
            </div>
        </div>
        <div class="status-item">
            <span class="material-icons" style="color: var(--warning);">save</span>
            <div>
                <div class="status-text">Pendentes (Offline)</div>
                <div class="status-value" id="pendingRecordsCount">0</div>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <span class="material-icons">settings</span>
                <h2>Configura√ß√£o do Sistema</h2>
            </div>
        </div>
        
        <div class="form-grid">
            <div class="form-group">
                <label>üîó URL do Google Apps Script</label>
                <input type="url" id="scriptURL" placeholder="https://script.google.com/macros/s/.../exec">
            </div>
            <div class="form-group">
                <label>üìä ID da Planilha Google Sheets</label>
                <input type="text" id="sheetID" placeholder="ID da planilha (encontrado na URL)">
            </div>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
            <button class="btn btn-primary" onclick="salvarConfiguracao()">
                <span class="material-icons" style="font-size: 18px;">save</span>
                Salvar Configura√ß√£o
            </button>
            <button class="btn btn-secondary" onclick="testarConexao()">
                <span class="material-icons" style="font-size: 18px;">sync</span>
                Testar Conex√£o
            </button>
        </div>
        
        <div class="alert" id="configAlert"></div>
    </div>
    
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">üíß</div>
            <div class="stat-label">Leitura Atual √Ågua</div>
            <div class="stat-value" id="totalAgua">0.00 m¬≥</div>
            <div class="trend-indicator trend-neutral" id="trendAgua">
                <span class="material-icons" style="font-size: 16px;">remove</span>
                Est√°vel
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">‚ö°</div>
            <div class="stat-label">Leitura Atual Energia</div>
            <div class="stat-value" id="totalEnergia">0.00 kWh</div>
            <div class="trend-indicator trend-neutral" id="trendEnergia">
                <span class="material-icons" style="font-size: 16px;">remove</span>
                Est√°vel
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="color: var(--secondary);">üíß</div>
            <div class="stat-label">Consumo Hoje - √Ågua</div>
            <div class="stat-value" id="consumoHojeAgua">0.00 m¬≥</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="color: var(--accent);">‚ö°</div>
            <div class="stat-label">Consumo Hoje - Energia</div>
            <div class="stat-value" id="consumoHojeEnergia">0.00 kWh</div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <span class="material-icons" style="color: var(--success);">paid</span>
                <h2>Estimativa de Custo de Consumo (Tarifas Manaus/AM)</h2>
            </div>
            <div class="card-actions">
                <button class="btn btn-secondary" onclick="salvarFormulaEscolhida()">
                    <span class="material-icons">save</span>
                    Salvar F√≥rmula
                </button>
            </div>
        </div>

        <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
            <div class="form-group">
                <label>Tipo de C√°lculo</label>
                <select id="tipoCalculo" onchange="alterarTipoCalculo()">
                    <option value="dias">Por Dias</option>
                    <option value="mes">Por M√™s Espec√≠fico</option>
                </select>
            </div>
            <div class="form-group" id="seletorMes" style="display: none;">
                <label>Selecione o M√™s</label>
                <input type="month" id="mesEscolhido" onchange="calcularCustoEstimado()">
            </div>
            <div class="form-group" id="seletorPeriodo">
                <label>Per√≠odo de C√°lculo</label>
                <select id="periodoCalculo" onchange="calcularCustoEstimado()">
                    <option value="today">Di√°rio (Consumo Hoje)</option>
                    <option value="7">Semanal (√öltimos 7 dias)</option>
                    <option value="30" selected>Mensal (√öltimos 30 dias)</option>
                    <option value="all">Total Acumulado</option>
                </select>
            </div>
        </div>

        <div style="background: var(--light); padding: 20px; border-radius: 8px; margin: 20px 0;">
            <h3 style="font-size: 16px; margin-bottom: 15px; color: var(--text-color);">
                <span class="material-icons" style="vertical-align: middle;">calculate</span>
                Escolha a F√≥rmula de C√°lculo
            </h3>
            
            <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                <div class="formula-card" style="background: var(--card-bg); padding: 15px; border-radius: 8px; border: 2px solid var(--border);">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="radio" name="formulaEscolhida" value="simples" checked onchange="calcularCustoEstimado()" style="margin-right: 10px;">
                        <div>
                            <strong>F√≥rmula Simplificada</strong>
                            <p style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                                üíß √Ågua: (Consumo √ó Tarifa) + Taxa Esgoto<br>
                                ‚ö° Energia: (Consumo √ó Tarifa) + Impostos
                            </p>
                        </div>
                    </label>
                </div>

                <div class="formula-card" style="background: var(--card-bg); padding: 15px; border-radius: 8px; border: 2px solid var(--border);">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="radio" name="formulaEscolhida" value="detalhada" onchange="calcularCustoEstimado()" style="margin-right: 10px;">
                        <div>
                            <strong>F√≥rmula Detalhada</strong>
                            <p style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                                Inclui todas as taxas adicionais e encargos setoriais
                            </p>
                        </div>
                    </label>
                </div>
            </div>
        </div>

        <div id="parametrosDetalhados" style="display: none; background: #fff3e0; padding: 20px; border-radius: 8px; margin: 20px 0;">
            <h3 style="font-size: 16px; margin-bottom: 15px; color: var(--text-color);">
                <span class="material-icons" style="vertical-align: middle;">tune</span>
                Par√¢metros Detalhados
            </h3>
            
            <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                <div class="form-group">
                    <label title="Valor cobrado por m¬≥ na faixa mais comum">üíß Tarifa Base √Ågua (R$/m¬≥)</label>
                    <input type="number" id="tarifaAgua" step="0.01" value="4.50" oninput="calcularCustoEstimado()">
                </div>
                <div class="form-group">
                    <label title="Taxa de esgoto sobre o valor da √°gua">üíß Taxa Esgoto (%)</label>
                    <input type="number" id="taxaEsgoto" step="0.01" value="80" oninput="calcularCustoEstimado()">
                </div>
                <div class="form-group">
                    <label title="Taxa de disponibilidade m√≠nima">üíß Taxa Disponibilidade (R$)</label>
                    <input type="number" id="taxaDisponibilidadeAgua" step="0.01" value="25.00" oninput="calcularCustoEstimado()">
                </div>
                <div class="form-group">
                    <label title="PIS sobre √°gua">üíß PIS √Ågua (%)</label>
                    <input type="number" id="pisAgua" step="0.01" value="1.65" oninput="calcularCustoEstimado()">
                </div>
                <div class="form-group">
                    <label title="COFINS sobre √°gua">üíß COFINS √Ågua (%)</label>
                    <input type="number" id="cofinsAgua" step="0.01" value="7.60" oninput="calcularCustoEstimado()">
                </div>
            </div>

            <hr style="margin: 20px 0; border: 1px solid var(--border);">

            <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                <div class="form-group">
                    <label title="Valor cobrado por kWh">‚ö° Tarifa Base Energia (R$/kWh)</label>
                    <input type="number" id="tarifaEnergia" step="0.01" value="0.80" oninput="calcularCustoEstimado()">
                </div>
                <div class="form-group">
                    <label title="Tarifa de uso do sistema de distribui√ß√£o">‚ö° TUSD (R$/kWh)</label>
                    <input type="number" id="tusd" step="0.01" value="0.35" oninput="calcularCustoEstimado()">
                </div>
                <div class="form-group">
                    <label title="Tarifa de uso do sistema de transmiss√£o">‚ö° TUST (R$/kWh)</label>
                    <input type="number" id="tust" step="0.01" value="0.05" oninput="calcularCustoEstimado()">
                </div>
                <div class="form-group">
                    <label title="Bandeira tarif√°ria adicional">‚ö° Bandeira Tarif√°ria (R$/kWh)</label>
                    <input type="number" id="bandeiraTarifaria" step="0.01" value="0.00" oninput="calcularCustoEstimado()">
                </div>
                <div class="form-group">
                    <label title="ICMS sobre energia">‚ö° ICMS (%)</label>
                    <input type="number" id="icmsEnergia" step="0.01" value="18.00" oninput="calcularCustoEstimado()">
                </div>
                <div class="form-group">
                    <label title="PIS sobre energia">‚ö° PIS Energia (%)</label>
                    <input type="number" id="pisEnergia" step="0.01" value="1.65" oninput="calcularCustoEstimado()">
                </div>
                <div class="form-group">
                    <label title="COFINS sobre energia">‚ö° COFINS Energia (%)</label>
                    <input type="number" id="cofinsEnergia" step="0.01" value="7.60" oninput="calcularCustoEstimado()">
                </div>
                <div class="form-group">
                    <label title="Contribui√ß√£o de Ilumina√ß√£o P√∫blica">‚ö° CIP (R$)</label>
                    <input type="number" id="cipEnergia" step="0.01" value="15.00" oninput="calcularCustoEstimado()">
                </div>
            </div>
        </div>

        <div class="stats-grid" style="margin-top: 20px;">
            <div class="stat-card" style="background: var(--light);">
                <div class="stat-label">Consumo no Per√≠odo - √Ågua</div>
                <div class="stat-value" id="custoConsumoAgua">0.00 m¬≥</div>
            </div>
            <div class="stat-card" style="background: var(--light);">
                <div class="stat-label">Consumo no Per√≠odo - Energia</div>
                <div class="stat-value" id="custoConsumoEnergia">0.00 kWh</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="color: var(--primary);">üíß</div>
                <div class="stat-label">Custo Estimado √Ågua</div>
                <div class="stat-value-currency" id="custoEstimadoAgua">R$ 0,00</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="color: var(--accent);">‚ö°</div>
                <div class="stat-label">Custo Estimado Energia</div>
                <div class="stat-value-currency" id="custoEstimadoEnergia">R$ 0,00</div>
            </div>
        </div>

        <div id="detalhamentoCalculo" style="background: var(--light); padding: 20px; border-radius: 8px; margin-top: 20px;">
            <h3 style="font-size: 16px; margin-bottom: 15px; color: var(--text-color);">
                <span class="material-icons" style="vertical-align: middle;">receipt_long</span>
                Detalhamento do C√°lculo
            </h3>
            <div id="breakdownAgua" style="margin-bottom: 20px;"></div>
            <div id="breakdownEnergia"></div>
        </div>

        <div class="alert alert-warning show" style="display: flex; margin-top: 20px; font-size: 13px;">
            <span class="material-icons">info</span>
            ‚ö†Ô∏è **Importante:** Este √© um **C√°lculo de Custo Estimado**. Os valores reais podem variar conforme faixas de consumo, ajustes tarif√°rios e bandeiras. Este c√°lculo n√£o substitui a fatura oficial da concession√°ria (√Åguas de Manaus/Amazonas Energia).
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <span class="material-icons">bar_chart</span>
                <h2>Gr√°ficos de Consumo</h2>
            </div>
            <div class="card-actions">
                <button class="btn btn-icon btn-secondary" onclick="exportarGrafico()" title="Exportar Gr√°fico">
                    <span class="material-icons">download</span>
                </button>
            </div>
        </div>

        <div class="chart-tabs">
            <button class="chart-tab active" onclick="trocarGrafico('line')">Evolu√ß√£o</button>
            <button class="chart-tab" onclick="trocarGrafico('bar')">Comparativo</button>
            <button class="chart-tab" onclick="trocarGrafico('pie')">Distribui√ß√£o</button>
        </div>

        <div class="chart-container">
            <canvas id="consumptionChart"></canvas>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <span class="material-icons">summarize</span>
                <h2>Relat√≥rios Personalizados</h2>
            </div>
            <div class="card-actions">
                <button class="btn btn-primary" onclick="gerarRelatorioPDF()">
                    <span class="material-icons">picture_as_pdf</span>
                    Exportar PDF
                </button>
                <button class="btn btn-secondary" onclick="exportarCSV()">
                    <span class="material-icons">table_chart</span>
                    Exportar CSV
                </button>
            </div>
        </div>

        <div class="form-grid">
            <div class="form-group">
                <label>Per√≠odo do Relat√≥rio</label>
                <select id="relatorioPeriodo" onchange="atualizarRelatorio()">
                    <option value="7">√öltimos 7 dias</option>
                    <option value="30" selected>√öltimos 30 dias</option>
                    <option value="90">√öltimos 90 dias</option>
                    <option value="all">Todos os registros</option>
                </select>
            </div>
        </div>

        <div id="relatorioResumo" style="margin-top: 20px;">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total √Ågua no Per√≠odo</div>
                    <div class="stat-value" id="relatorioTotalAgua">0.00 m¬≥</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Energia no Per√≠odo</div>
                    <div class="stat-value" id="relatorioTotalEnergia">0.00 kWh</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">M√©dia Di√°ria √Ågua</div>
                    <div class="stat-value" id="relatorioMediaAgua">0.00 m¬≥/dia</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">M√©dia Di√°ria Energia</div>
                    <div class="stat-value" id="relatorioMediaEnergia">0.00 kWh/dia</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <span class="material-icons">water_drop</span>
                <h2>Registro de Consumo de √Ågua</h2>
            </div>
        </div>
        
        <form id="aguaForm" onsubmit="handleSubmit(event, 'agua')">
            <div class="form-grid">
                <div class="form-group">
                    <label>Nome Completo *</label>
                    <input type="text" name="nome" id="nomeAgua" required placeholder="Digite o nome completo" autocomplete="off">
                    <div class="autocomplete-items" id="autocompleteNomeAgua"></div>
                </div>
                <div class="form-group">
                    <label>Matr√≠cula Residencial *</label>
                    <input type="text" name="matricula" id="matriculaAgua" required placeholder="Digite a matr√≠cula" autocomplete="off">
                    <div class="autocomplete-items" id="autocompleteMatriculaAgua"></div>
                </div>
                <div class="form-group">
                    <label>Data e Hora *</label>
                    <input type="datetime-local" name="dataHora" id="dataHoraAgua" required>
                </div>
                <div class="form-group">
                    <label>Leitura Anterior (m¬≥)</label>
                    <input type="number" id="leituraAnteriorAgua" step="0.01" readonly>
                </div>
                <div class="form-group">
                    <label>Leitura Atual do Medidor (m¬≥) *</label>
                    <input type="number" name="leituraAtual" id="leituraAtualAgua" step="0.01" required placeholder="0.00" oninput="calcularConsumo('agua')">
                </div>
                <div class="form-group">
                    <label>Consumo Total Calculado (m¬≥)</label>
                    <input type="number" name="consumoTotal" id="consumoTotalAgua" step="0.01" readonly>
                </div>
                <div class="form-group">
                    <label>Extra 1 (Opcional)</label>
                    <input type="text" name="extra1" placeholder="Campo adicional 1">
                </div>
                <div class="form-group">
                    <label>Extra 2 (Opcional)</label>
                    <input type="text" name="extra2" placeholder="Campo adicional 2">
                </div>
                <div class="form-group">
                    <label>Extra 3 (Opcional)</label>
                    <input type="text" name="extra3" placeholder="Campo adicional 3">
                </div>
            </div>
            
            <div class="consumption-display" id="consumptionDisplayAgua" style="display: none;">
                <h3>üíß Consumo Calculado de √Ågua</h3>
                <div class="consumption-value" id="consumptionValueAgua">0.00 m¬≥</div>
            </div>
            
            <button type="submit" class="btn btn-primary btn-full" style="margin-top: 20px;">
                <span class="material-icons">send</span>
                Registrar Consumo de √Ågua
            </button>
            
            <div class="alert" id="alertAgua"></div>
        </form>
    </div>
    
    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <span class="material-icons">bolt</span>
                <h2>Registro de Consumo de Energia</h2>
            </div>
        </div>
        
        <form id="energiaForm" onsubmit="handleSubmit(event, 'energia')">
            <div class="form-grid">
                <div class="form-group">
                    <label>Nome Completo *</label>
                    <input type="text" name="nome" id="nomeEnergia" required placeholder="Digite o nome completo" autocomplete="off">
                    <div class="autocomplete-items" id="autocompleteNomeEnergia"></div>
                </div>
                <div class="form-group">
                    <label>Matr√≠cula Residencial *</label>
                    <input type="text" name="matricula" id="matriculaEnergia" required placeholder="Digite a matr√≠cula" autocomplete="off">
                    <div class="autocomplete-items" id="autocompleteMatriculaEnergia"></div>
                </div>
                <div class="form-group">
                    <label>Data e Hora *</label>
                    <input type="datetime-local" name="dataHora" id="dataHoraEnergia" required>
                </div>
                <div class="form-group">
                    <label>Leitura Anterior (kWh)</label>
                    <input type="number" id="leituraAnteriorEnergia" step="0.01" readonly>
                </div>
                <div class="form-group">
                    <label>Leitura Atual do Medidor (kWh) *</label>
                    <input type="number" name="leituraAtual" id="leituraAtualEnergia" step="0.01" required placeholder="0.00" oninput="calcularConsumo('energia')">
                </div>
                <div class="form-group">
                    <label>Consumo Total Calculado (kWh)</label>
                    <input type="number" name="consumoTotal" id="consumoTotalEnergia" step="0.01" readonly>
                </div>
                <div class="form-group">
                    <label>Extra 1 (Opcional)</label>
                    <input type="text" name="extra1" placeholder="Campo adicional 1">
                </div>
                <div class="form-group">
                    <label>Extra 2 (Opcional)</label>
                    <input type="text" name="extra2" placeholder="Campo adicional 2">
                </div>
                <div class="form-group">
                    <label>Extra 3 (Opcional)</label>
                    <input type="text" name="extra3" placeholder="Campo adicional 3">
                </div>
            </div>
            
            <div class="consumption-display" id="consumptionDisplayEnergia" style="display: none;">
                <h3>‚ö° Consumo Calculado de Energia</h3>
                <div class="consumption-value" id="consumptionValueEnergia">0.00 kWh</div>
            </div>
            
            <button type="submit" class="btn btn-primary btn-full" style="margin-top: 20px; background: var(--accent);">
                <span class="material-icons">send</span>
                Registrar Consumo de Energia
            </button>
            
            <div class="alert" id="alertEnergia"></div>
        </form>
    </div>

    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <span class="material-icons">calendar_today</span>
                <h2>Visualiza√ß√£o do Consumo Di√°rio</h2>
            </div>
        </div>

        <div class="filter-container">
            <h3 style="margin-bottom: 15px; font-size: 16px; color: var(--text-color);">
                <span class="material-icons" style="vertical-align: middle; font-size: 20px;">date_range</span>
                Selecione o Per√≠odo
            </h3>
            <div class="filter-grid">
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Data In√≠cio *</label>
                    <input type="date" id="dailyDataInicio" required>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Data Fim *</label>
                    <input type="date" id="dailyDataFim" required>
                </div>
            </div>
            <div class="filter-buttons">
                <button class="btn btn-primary" onclick="calcularConsumoDiario()">
                    <span class="material-icons">visibility</span>
                    Ver Consumo Di√°rio
                </button>
            </div>
        </div>

        <div class="table-container daily-consumption-table">
            <table>
                <thead>
                    <tr>
                        <th>Dia</th>
                        <th style="text-align: right;">üíß Consumo √Ågua</th>
                        <th style="text-align: right;">‚ö° Consumo Energia</th>
                    </tr>
                </thead>
                <tbody id="consumoDiarioBody">
                    <tr>
                        <td colspan="3" style="text-align: center; padding: 40px; color: #999;">
                            Selecione um per√≠odo e clique em "Ver Consumo Di√°rio".
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="card" id="pendingRecordsCard" style="display: none;">
        <div class="card-header" style="border-bottom-color: var(--warning);">
            <div class="card-title">
                <span class="material-icons" style="color: var(--warning);">warning</span>
                <h2>Registros Pendentes (Offline) <span id="pendingCountBadge" class="badge badge-offline">0</span></h2>
            </div>
        </div>

        <div class="filter-container">
            <h3 style="margin-bottom: 15px; font-size: 16px; color: var(--text-color);">
                <span class="material-icons" style="vertical-align: middle; font-size: 20px;">filter_list</span>
                Filtros de Pesquisa
            </h3>
            <div class="filter-grid">
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Tipo de Registro</label>
                    <select id="filtroTipoOffline">
                        <option value="all">Todos os Tipos</option>
                        <option value="agua">Apenas √Ågua</option>
                        <option value="energia">Apenas Energia</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Per√≠odo</label>
                    <select id="filtroPeriodoOffline" onchange="toggleCustomDateOffline()">
                        <option value="all">Todos os Registros</option>
                        <option value="today">Dia Atual</option>
                        <option value="custom">Per√≠odo Personalizado</option>
                    </select>
                </div>
                <div class="form-group" id="dataInicioGroupOffline" style="margin-bottom: 0; display: none;">
                    <label>Data In√≠cio</label>
                    <input type="date" id="dataInicioOffline">
                </div>
                <div class="form-group" id="dataFimGroupOffline" style="margin-bottom: 0; display: none;">
                    <label>Data Fim</label>
                    <input type="date" id="dataFimOffline">
                </div>
            </div>
            <div class="filter-buttons">
                <button class="btn btn-secondary" onclick="aplicarFiltrosOffline()">
                    <span class="material-icons">search</span>
                    Aplicar Filtros
                </button>
                <button class="btn btn-primary" onclick="limparFiltrosOffline()">
                    <span class="material-icons">clear</span>
                    Limpar Filtros
                </button>
            </div>
        </div>

        <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
            <button class="btn btn-warning" onclick="sincronizarRegistrosPendentes()">
                <span class="material-icons">cloud_upload</span>
                Sincronizar Registros Pendentes
            </button>
            <button class="btn btn-danger" onclick="limparTodosRegistrosOffline()">
                <span class="material-icons">delete_forever</span>
                Limpar Todos os Registros Offline
            </button>
        </div>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Tipo</th>
                        <th>Data/Hora</th>
                        <th>Nome</th>
                        <th>Matr√≠cula</th>
                        <th style="text-align: right;">Leitura Atual</th>
                        <th style="text-align: right;">Consumo</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="registrosPendentesBody">
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                            Nenhum registro offline pendente.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="alert" id="syncAlert"></div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <span class="material-icons">history</span>
                <h2>Hist√≥rico de Registros (Online)</h2>
            </div>
            <div class="card-actions">
                <button class="btn btn-icon btn-secondary" onclick="window.print()" title="Imprimir">
                    <span class="material-icons">print</span>
                </button>
            </div>
        </div>

        <div class="search-box">
            <span class="material-icons">search</span>
            <input type="text" id="searchInput" placeholder="Buscar por nome ou matr√≠cula..." oninput="buscarRegistros()">
        </div>
        
        <div class="filter-container">
            <h3 style="margin-bottom: 15px; font-size: 16px; color: var(--text-color);">
                <span class="material-icons" style="vertical-align: middle; font-size: 20px;">filter_list</span>
                Filtros de Pesquisa
            </h3>
            <div class="filter-grid">
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Tipo de Registro</label>
                    <select id="filtroTipo">
                        <option value="all">Todos os Tipos</option>
                        <option value="agua">Apenas √Ågua</option>
                        <option value="energia">Apenas Energia</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Per√≠odo</label>
                    <select id="filtroPeriodo" onchange="toggleCustomDate()">
                        <option value="all">Todos os Registros</option>
                        <option value="today">Dia Atual</option>
                        <option value="custom">Per√≠odo Personalizado</option>
                    </select>
                </div>
                <div class="form-group" id="dataInicioGroup" style="margin-bottom: 0; display: none;">
                    <label>Data In√≠cio</label>
                    <input type="date" id="dataInicio">
                </div>
                <div class="form-group" id="dataFimGroup" style="margin-bottom: 0; display: none;">
                    <label>Data Fim</label>
                    <input type="date" id="dataFim">
                </div>
            </div>
            <div class="filter-buttons">
                <button class="btn btn-secondary" onclick="aplicarFiltros()">
                    <span class="material-icons">search</span>
                    Aplicar Filtros
                </button>
                <button class="btn btn-primary" onclick="limparFiltros()">
                    <span class="material-icons">clear</span>
                    Limpar Filtros
                </button>
            </div>
        </div>
        
        <div class="table-container">
            <table id="historicoTable">
                <thead>
                    <tr>
                        <th onclick="ordenarTabela(0)">Tipo <span class="sort-icon material-icons">unfold_more</span></th>
                        <th onclick="ordenarTabela(1)">Data/Hora <span class="sort-icon material-icons">unfold_more</span></th>
                        <th onclick="ordenarTabela(2)">Nome <span class="sort-icon material-icons">unfold_more</span></th>
                        <th onclick="ordenarTabela(3)">Matr√≠cula <span class="sort-icon material-icons">unfold_more</span></th>
                        <th onclick="ordenarTabela(4)" style="text-align: right;">Leitura Anterior <span class="sort-icon material-icons">unfold_more</span></th>
                        <th onclick="ordenarTabela(5)" style="text-align: right;">Leitura Atual <span class="sort-icon material-icons">unfold_more</span></th>
                        <th onclick="ordenarTabela(6)" style="text-align: right;">Consumo <span class="sort-icon material-icons">unfold_more</span></th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="historicoBody">
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #999;">
                            Nenhum registro encontrado. Fa√ßa o primeiro registro!
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="editOnlineModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="fecharModalEditOnline()">&times;</span>
        <h2>Editar Registro Online</h2>
        <form id="editOnlineForm" onsubmit="salvarEdicaoOnline(event)">
            <input type="hidden" id="editOnlineRowId">
            <input type="hidden" id="editOnlineTipo">
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Nome Completo *</label>
                    <input type="text" id="editOnlineNome" required>
                </div>
                <div class="form-group">
                    <label>Matr√≠cula Residencial *</label>
                    <input type="text" id="editOnlineMatricula" required>
                </div>
                <div class="form-group">
                    <label>Data e Hora *</label>
                    <input type="datetime-local" id="editOnlineDataHora" required>
                </div>
                <div class="form-group">
                    <label id="labelEditOnlineLeituraAnterior">Leitura Anterior (m¬≥)</label>
                    <input type="number" id="editOnlineLeituraAnterior" step="0.01" readonly>
                </div>
                <div class="form-group">
                    <label id="labelEditOnlineLeituraAtual">Leitura Atual do Medidor (m¬≥) *</label>
                    <input type="number" id="editOnlineLeituraAtual" step="0.01" required oninput="calcularConsumoModalOnline()">
                </div>
                <div class="form-group">
                    <label id="labelEditOnlineConsumoTotal">Consumo Total Calculado (m¬≥)</label>
                    <input type="number" id="editOnlineConsumoTotal" step="0.01" readonly>
                </div>
                <div class="form-group">
                    <label>Extra 1 (Opcional)</label>
                    <input type="text" id="editOnlineExtra1">
                </div>
                <div class="form-group">
                    <label>Extra 2 (Opcional)</label>
                    <input type="text" id="editOnlineExtra2">
                </div>
                <div class="form-group">
                    <label>Extra 3 (Opcional)</label>
                    <input type="text" id="editOnlineExtra3">
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary btn-full" style="margin-top: 20px;">
                <span class="material-icons">save</span>
                Salvar Altera√ß√µes
            </button>
            <div class="alert" id="alertEditOnlineModal"></div>
        </form>
    </div>
</div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="fecharModal()">&times;</span>
        <h2>Editar Registro Offline</h2>
        <form id="editForm" onsubmit="salvarEdicao(event)">
            <input type="hidden" id="editIndex">
            <input type="hidden" id="editTipo">
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Nome Completo *</label>
                    <input type="text" id="editNome" required>
                </div>
                <div class="form-group">
                    <label>Matr√≠cula Residencial *</label>
                    <input type="text" id="editMatricula" required>
                </div>
                <div class="form-group">
                    <label>Data e Hora *</label>
                    <input type="datetime-local" id="editDataHora" required>
                </div>
                <div class="form-group">
                    <label id="labelLeituraAnterior">Leitura Anterior (m¬≥)</label>
                    <input type="number" id="editLeituraAnterior" step="0.01" readonly>
                </div>
                <div class="form-group">
                    <label id="labelLeituraAtual">Leitura Atual do Medidor (m¬≥) *</label>
                    <input type="number" id="editLeituraAtual" step="0.01" required oninput="calcularConsumoModal()">
                </div>
                <div class="form-group">
                    <label id="labelConsumoTotal">Consumo Total Calculado (m¬≥)</label>
                    <input type="number" id="editConsumoTotal" step="0.01" readonly>
                </div>
                <div class="form-group">
                    <label>Extra 1 (Opcional)</label>
                    <input type="text" id="editExtra1">
                </div>
                <div class="form-group">
                    <label>Extra 2 (Opcional)</label>
                    <input type="text" id="editExtra2">
                </div>
                <div class="form-group">
                    <label>Extra 3 (Opcional)</label>
                    <input type="text" id="editExtra3">
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary btn-full" style="margin-top: 20px;">
                <span class="material-icons">save</span>
                Salvar Edi√ß√£o
            </button>
            <div class="alert" id="alertEditModal"></div>
        </form>
    </div>
</div>

<script>
let scriptURL = '';
let sheetID = '';
let leituraAnteriorAgua = 0;
let leituraAnteriorEnergia = 0;
let isProcessing = false;
let todosRegistrosOnline = [];
let todosRegistrosOffline = [];
let currentChart = null;
let currentChartType = 'line';
let sortDirection = {};
let nomesUnicos = new Set();
let matriculasUnicas = new Set();
let nomeMatriculaMap = new Map(); 

window.onload = function() {
    carregarConfiguracao();
    setDataHoraAtual();
    setInterval(atualizarRelogio, 1000);
    carregarTema();
    carregarFormulasSalvas();
    
    const nomeInputs = document.querySelectorAll('input[name="nome"]');
    const matriculaInputs = document.querySelectorAll('input[name="matricula"]');
    
    const ultimoNome = localStorage.getItem('ultimoNome') || '';
    const ultimaMatricula = localStorage.getItem('ultimaMatricula') || '';
    
    nomeInputs.forEach(input => {
        if (!input.id.includes('Online') && !input.id.includes('edit')) {
            input.value = ultimoNome;
        }
    });
    matriculaInputs.forEach(input => {
        if (!input.id.includes('Online') && !input.id.includes('edit')) {
            input.value = ultimaMatricula;
        }
    });
    
    const now = new Date();
    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
    const today = now.toISOString().split('T')[0];
    const mesAtual = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    
    document.getElementById('dailyDataInicio').value = firstDay;
    document.getElementById('dailyDataFim').value = today;
    document.getElementById('mesEscolhido').value = mesAtual;

    if (scriptURL && sheetID) {
        carregarDados();
    }

    carregarRegistrosPendentes();
    setupKeyboardShortcuts();
    calcularCustoEstimado(); 
    
    document.querySelectorAll('input[name="formulaEscolhida"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const detalhados = document.getElementById('parametrosDetalhados');
            detalhados.style.display = this.value === 'detalhada' ? 'block' : 'none';
        });
    });
};

function toggleTheme() {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    
    document.documentElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    
    const icon = document.getElementById('themeIcon');
    const text = document.getElementById('themeText');
    
    if (newTheme === 'dark') {
        icon.textContent = 'light_mode';
        text.textContent = 'Claro';
    } else {
        icon.textContent = 'dark_mode';
        text.textContent = 'Escuro';
    }
    
    if (currentChart) {
        atualizarGrafico();
    }
}

function carregarTema() {
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    
    const icon = document.getElementById('themeIcon');
    const text = document.getElementById('themeText');
    
    if (savedTheme === 'dark') {
        icon.textContent = 'light_mode';
        text.textContent = 'Claro';
    } else {
        icon.textContent = 'dark_mode';
        text.textContent = 'Escuro';
    }
}

function setupKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            salvarConfiguracao();
        }
        
        if (e.key === 'Escape') {
            fecharModal();
            fecharModalEditOnline();
        }
        
        if (e.key === '?') {
            const shortcuts = document.getElementById('keyboardShortcuts');
            shortcuts.classList.toggle('show');
        }
    });
}

function inicializarAutocomplete() {
    const inputsNome = ['nomeAgua', 'nomeEnergia'];
    const inputsMatricula = ['matriculaAgua', 'matriculaEnergia'];
    
    inputsNome.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('input', function() {
                const tipo = id.includes('Agua') ? 'Agua' : 'Energia';
                mostrarAutocomplete(this.value, 'nome', 'autocompleteNome' + tipo, id, 'matricula' + tipo);
            });
        }
    });
    
    inputsMatricula.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('input', function() {
                const tipo = id.includes('Agua') ? 'Agua' : 'Energia';
                mostrarAutocomplete(this.value, 'matricula', 'autocompleteMatricula' + tipo, id);
            });
        }
    });
}

function mostrarAutocomplete(valor, tipo, autocompleteId, inputId, relatedInputId) {
    const autocompleteDiv = document.getElementById(autocompleteId);
    if (!autocompleteDiv) return;
    
    autocompleteDiv.innerHTML = '';
    
    if (!valor) {
        return;
    }
    
    const dados = tipo === 'nome' ? Array.from(nomesUnicos) : Array.from(matriculasUnicas);
    const filtrados = dados.filter(item => 
        item.toLowerCase().includes(valor.toLowerCase())
    ).slice(0, 5);
    
    filtrados.forEach(item => {
        const div = document.createElement('div');
        div.textContent = item;
        
        if (tipo === 'nome' && relatedInputId && nomeMatriculaMap.has(item)) {
            div.innerHTML += ` <small style="color: var(--primary); opacity: 0.7;">(${nomeMatriculaMap.get(item)})</small>`;
        }
        
        div.onclick = function() {
            document.getElementById(inputId).value = item;
            autocompleteDiv.innerHTML = '';
            
            if (tipo === 'nome' && relatedInputId && nomeMatriculaMap.has(item)) {
                const matriculaInput = document.getElementById(relatedInputId);
                if (matriculaInput) {
                    matriculaInput.value = nomeMatriculaMap.get(item);
                }
            }
        };
        autocompleteDiv.appendChild(div);
    });
}

function atualizarAutocomplete() {
    nomesUnicos.clear();
    matriculasUnicas.clear();
    nomeMatriculaMap.clear();

    todosRegistrosOnline.forEach(reg => {
        if (reg.nome) nomesUnicos.add(reg.nome);
        if (reg.matricula) matriculasUnicas.add(reg.matricula);

        if (reg.nome && reg.matricula) {
            nomeMatriculaMap.set(reg.nome, reg.matricula);
        }
    });
    
    inicializarAutocomplete();
}

function setDataHoraAtual() {
    const now = new Date();
    const localDate = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
    document.getElementById('dataHoraAgua').value = localDate;
    document.getElementById('dataHoraEnergia').value = localDate;
}

function atualizarRelogio() {
    const now = new Date();
    document.getElementById('lastUpdate').textContent = now.toLocaleTimeString('pt-BR');
}

function carregarConfiguracao() {
    scriptURL = localStorage.getItem('scriptURL') || '';
    sheetID = localStorage.getItem('sheetID') || '';
    
    document.getElementById('scriptURL').value = scriptURL;
    document.getElementById('sheetID').value = sheetID;
    
    if (scriptURL && sheetID) {
        document.getElementById('connectionStatus').textContent = 'Conectado';
        document.getElementById('connectionStatus').style.color = 'var(--success)';
    } else {
        document.getElementById('connectionStatus').textContent = 'N√£o Configurado';
        document.getElementById('connectionStatus').style.color = 'var(--error)';
    }
}

function salvarConfiguracao() {
    const urlInput = document.getElementById('scriptURL').value.trim();
    const idInput = document.getElementById('sheetID').value.trim();
    
    if (!urlInput || !idInput) {
        mostrarAlerta('configAlert', 'Por favor, preencha todos os campos de configura√ß√£o!', 'error');
        return;
    }
    
    if (!urlInput.includes('/exec')) {
        mostrarAlerta('configAlert', 'A URL do Apps Script deve terminar com /exec', 'error');
        return;
    }
    
    localStorage.setItem('scriptURL', urlInput);
    localStorage.setItem('sheetID', idInput);
    
    scriptURL = urlInput;
    sheetID = idInput;
    
    document.getElementById('connectionStatus').textContent = 'Conectado';
    document.getElementById('connectionStatus').style.color = 'var(--success)';
    
    mostrarAlerta('configAlert', 'Configura√ß√£o salva com sucesso!', 'success');

    if (scriptURL && sheetID) {
        carregarDados();
    }
}

async function testarConexao() {
    if (!scriptURL || !sheetID) {
        mostrarAlerta('configAlert', 'Configure primeiro o sistema!', 'error');
        return;
    }
    
    try {
        document.getElementById('connectionStatus').textContent = 'Testando...';
        
        const response = await fetch(`${scriptURL}?action=test&sheetId=${sheetID}`);
        const data = await response.json();
        
        if (data.status === 'success') {
            mostrarAlerta('configAlert', 'Conex√£o estabelecida com sucesso!', 'success');
            document.getElementById('connectionStatus').textContent = 'Conectado';
            document.getElementById('connectionStatus').style.color = 'var(--success)';
            carregarDados();
        } else {
            throw new Error(data.message || 'Erro na conex√£o');
        }
    } catch (error) {
        mostrarAlerta('configAlert', 'Erro ao conectar: ' + error.message, 'error');
        document.getElementById('connectionStatus').textContent = 'Erro';
        document.getElementById('connectionStatus').style.color = 'var(--error)';
    }
}

async function carregarDados() {
    await carregarHistorico();
    calcularEstatisticasGerais();
    atualizarAutocomplete();
    atualizarGrafico();
    atualizarRelatorio();
    calcularCustoEstimado();
}

function calcularEstatisticasGerais() {
    let totalAguaLeitura = 0;
    let totalEnergiaLeitura = 0;

    if (todosRegistrosOnline.length === 0) {
        leituraAnteriorAgua = 0;
        leituraAnteriorEnergia = 0;
        document.getElementById('leituraAnteriorAgua').value = '0.00';
        document.getElementById('leituraAnteriorEnergia').value = '0.00';
        document.getElementById('leituraAtualAgua').value = '0.00';
        document.getElementById('leituraAtualEnergia').value = '0.00';
        document.getElementById('totalAgua').textContent = '0.00 m¬≥';
        document.getElementById('totalEnergia').textContent = '0.00 kWh';
        document.getElementById('consumoHojeAgua').textContent = '0.00 m¬≥';
        document.getElementById('consumoHojeEnergia').textContent = '0.00 kWh';
        return;
    }

    const registrosAgua = todosRegistrosOnline.filter(r => r.tipo === 'agua').sort((a, b) => new Date(a.dataHora) - new Date(b.dataHora));
    const registrosEnergia = todosRegistrosOnline.filter(r => r.tipo === 'energia').sort((a, b) => new Date(a.dataHora) - new Date(b.dataHora));

    if (registrosAgua.length > 0) {
        const ultimoAgua = registrosAgua[registrosAgua.length - 1];
        totalAguaLeitura = parseFloat(ultimoAgua.leituraAtual || 0);
    }
    
    if (registrosEnergia.length > 0) {
        const ultimoEnergia = registrosEnergia[registrosEnergia.length - 1];
        totalEnergiaLeitura = parseFloat(ultimoEnergia.leituraAtual || 0);
    }

    leituraAnteriorAgua = totalAguaLeitura;
    leituraAnteriorEnergia = totalEnergiaLeitura;

    document.getElementById('leituraAnteriorAgua').value = totalAguaLeitura.toFixed(2);
    document.getElementById('leituraAnteriorEnergia').value = totalEnergiaLeitura.toFixed(2);
    document.getElementById('leituraAtualAgua').value = totalAguaLeitura.toFixed(2);
    document.getElementById('leituraAtualEnergia').value = totalEnergiaLeitura.toFixed(2);

    document.getElementById('totalAgua').textContent = totalAguaLeitura.toFixed(2) + ' m¬≥';
    document.getElementById('totalEnergia').textContent = totalEnergiaLeitura.toFixed(2) + ' kWh';

    const consumoHoje = calcularConsumoDiarioPorData(new Date().toISOString().split('T')[0]);
    document.getElementById('consumoHojeAgua').textContent = (consumoHoje.agua || 0).toFixed(2) + ' m¬≥';
    document.getElementById('consumoHojeEnergia').textContent = (consumoHoje.energia || 0).toFixed(2) + ' kWh';

    calcularTendencia();
    calcularConsumo('agua');
    calcularConsumo('energia');
}

function calcularTendencia() {
    const hoje = new Date().toISOString().split('T')[0];
    const ontem = new Date(Date.now() - 86400000).toISOString().split('T')[0];
    
    const consumoHoje = calcularConsumoDiarioPorData(hoje);
    const consumoOntem = calcularConsumoDiarioPorData(ontem);
    
    atualizarTrendIndicator('trendAgua', consumoHoje.agua, consumoOntem.agua, 'm¬≥');
    atualizarTrendIndicator('trendEnergia', consumoHoje.energia, consumoOntem.energia, 'kWh');
}

function atualizarTrendIndicator(elementId, hoje, ontem, unidade) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    if (ontem === 0 || !ontem) {
        element.className = 'trend-indicator trend-neutral';
        element.innerHTML = '<span class="material-icons" style="font-size: 16px;">remove</span> Sem dados';
        return;
    }
    
    const diferenca = hoje - ontem;
    const percentual = ((diferenca / ontem) * 100).toFixed(1);
    
    if (diferenca > 0) {
        element.className = 'trend-indicator trend-up';
        element.innerHTML = `<span class="material-icons" style="font-size: 16px;">trending_up</span> +${percentual}%`;
    } else if (diferenca < 0) {
        element.className = 'trend-indicator trend-down';
        element.innerHTML = `<span class="material-icons" style="font-size: 16px;">trending_down</span> ${percentual}%`;
    } else {
        element.className = 'trend-indicator trend-neutral';
        element.innerHTML = '<span class="material-icons" style="font-size: 16px;">remove</span> Est√°vel';
    }
}

function toYYYYMMDD(date) {
    const d = new Date(date);
    d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
    return d.toISOString().split('T')[0];
}

function calcularConsumoDiarioPorData(dataString) {
    const registrosDoDia = todosRegistrosOnline
        .filter(r => toYYYYMMDD(r.dataHora) === dataString)
        .sort((a, b) => new Date(a.dataHora) - new Date(b.dataHora));

    let consumoAgua = 0;
    let consumoEnergia = 0;

    const regAgua = registrosDoDia.filter(r => r.tipo === 'agua');
    const regEnergia = registrosDoDia.filter(r => r.tipo === 'energia');

    if (regAgua.length > 0) {
        // Encontrar a primeira leitura anterior do dia e a √∫ltima leitura atual
        const primeiraLeituraAnterior = parseFloat(regAgua[0].leituraAnterior || 0);
        const ultimaLeituraAtual = parseFloat(regAgua[regAgua.length - 1].leituraAtual || 0);
        consumoAgua = Math.max(0, ultimaLeituraAtual - primeiraLeituraAnterior);
    }
    
    if (regEnergia.length > 0) {
        const primeiraLeituraAnterior = parseFloat(regEnergia[0].leituraAnterior || 0);
        const ultimaLeituraAtual = parseFloat(regEnergia[regEnergia.length - 1].leituraAtual || 0);
        consumoEnergia = Math.max(0, ultimaLeituraAtual - primeiraLeituraAnterior);
    }

    return { agua: consumoAgua, energia: consumoEnergia };
}

function calcularConsumoDiario() {
    const dataInicioStr = document.getElementById('dailyDataInicio').value;
    const dataFimStr = document.getElementById('dailyDataFim').value;
    const tbody = document.getElementById('consumoDiarioBody');

    if (!dataInicioStr || !dataFimStr) {
        tbody.innerHTML = `<tr><td colspan="3" style="text-align: center; padding: 20px; color: var(--error);">Selecione as duas datas!</td></tr>`;
        return;
    }

    const dataInicio = new Date(dataInicioStr);
    const dataFim = new Date(dataFimStr);

    if (dataInicio > dataFim) {
        tbody.innerHTML = `<tr><td colspan="3" style="text-align: center; padding: 20px; color: var(--error);">A Data In√≠cio n√£o pode ser maior que a Data Fim!</td></tr>`;
        return;
    }
    
    tbody.innerHTML = '';
    let registroEncontrado = false;

    for (let d = new Date(dataInicio); d <= dataFim; d.setDate(d.getDate() + 1)) {
        const dataAtualStr = toYYYYMMDD(d);
        const consumo = calcularConsumoDiarioPorData(dataAtualStr);

        if (consumo.agua > 0 || consumo.energia > 0) {
            registroEncontrado = true;
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${new Date(dataAtualStr).toLocaleDateString('pt-BR')}</td>
                <td style="text-align: right;">${consumo.agua.toFixed(2)} m¬≥</td>
                <td style="text-align: right;">${consumo.energia.toFixed(2)} kWh</td>
            `;
        }
    }

    if (!registroEncontrado) {
        tbody.innerHTML = `<tr><td colspan="3" style="text-align: center; padding: 40px; color: #999;">
            Nenhum consumo registrado no per√≠odo selecionado.
        </td></tr>`;
    }
}

async function carregarHistorico() {
    if (!scriptURL || !sheetID) {
        console.warn('Configura√ß√£o ausente.');
        document.getElementById('totalRecords').textContent = '0';
        calcularEstatisticasGerais();
        return;
    }
    
    try {
        const response = await fetch(`${scriptURL}?action=getHistory&sheetId=${sheetID}&tipo=all`);
        const data = await response.json();
        
        if (data.status === 'success' && data.registros && data.registros.length > 0) {
            todosRegistrosOnline = data.registros.sort((a, b) => new Date(a.dataHora) - new Date(b.dataHora));
            aplicarFiltros();
        } else {
            todosRegistrosOnline = [];
            renderizarHistorico([]);
        }
    } catch (error) {
        console.error('Erro ao carregar hist√≥rico:', error);
        document.getElementById('historicoBody').innerHTML = `
            <tr>
                <td colspan="8" style="text-align: center; padding: 40px; color: var(--error);">
                    ‚ùå Erro ao carregar hist√≥rico. Verifique a conex√£o e configura√ß√£o.
                </td>
            </tr>
        `;
    }
}

function renderizarHistorico(registros) {
    const tbody = document.getElementById('historicoBody');
    
    if (registros.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" style="text-align: center; padding: 40px; color: #999;">
                    Nenhum registro encontrado com os filtros aplicados.
                </td>
            </tr>
        `;
        document.getElementById('totalRecords').textContent = todosRegistrosOnline.length.toString();
        return;
    }
    
    let html = '';
    registros.forEach(registro => {
        const badgeClass = registro.tipo === 'agua' ? 'badge-agua' : 'badge-energia';
        const unidade = registro.tipo === 'agua' ? 'm¬≥' : 'kWh';

        // O rowId √© o identificador da linha na planilha, essencial para edi√ß√£o/exclus√£o online
        const rowId = registro.rowId || 'N/A'; 

        html += `
            <tr data-row-id="${rowId}" data-tipo="${registro.tipo}">
                <td><span class="badge ${badgeClass}">${registro.tipo.toUpperCase()}</span></td>
                <td>${new Date(registro.dataHora).toLocaleDateString('pt-BR')} ${new Date(registro.dataHora).toLocaleTimeString('pt-BR').substring(0, 5)}</td>
                <td>${registro.nome || 'N/A'}</td>
                <td>${registro.matricula || 'N/A'}</td>
                <td style="text-align: right;">${parseFloat(registro.leituraAnterior).toFixed(2)} ${unidade}</td>
                <td style="text-align: right;">${parseFloat(registro.leituraAtual).toFixed(2)} ${unidade}</td>
                <td style="text-align: right;">${parseFloat(registro.consumoTotal).toFixed(2)} ${unidade}</td>
                <td>
                    <button class="btn btn-edit" onclick="abrirModalEditOnline('${rowId}', '${registro.tipo}')" title="Editar Online">
                        <span class="material-icons" style="font-size: 16px;">edit</span>
                    </button>
                    <button class="btn btn-danger" onclick="deletarRegistroOnline('${rowId}', '${registro.tipo}')" title="Excluir Online">
                        <span class="material-icons" style="font-size: 16px;">delete</span>
                    </button>
                </td>
            </tr>
        `;
    });

    tbody.innerHTML = html;
    document.getElementById('totalRecords').textContent = todosRegistrosOnline.length.toString();
}

function toggleCustomDate() {
    const periodo = document.getElementById('filtroPeriodo').value;
    const inicio = document.getElementById('dataInicioGroup');
    const fim = document.getElementById('dataFimGroup');
    
    if (periodo === 'custom') {
        inicio.style.display = 'block';
        fim.style.display = 'block';
    } else {
        inicio.style.display = 'none';
        fim.style.display = 'none';
    }
}

function aplicarFiltros() {
    const tipo = document.getElementById('filtroTipo').value;
    const periodo = document.getElementById('filtroPeriodo').value;
    const dataInicioStr = document.getElementById('dataInicio').value;
    const dataFimStr = document.getElementById('dataFim').value;
    const termoBusca = document.getElementById('searchInput').value.toLowerCase().trim();

    let registrosFiltrados = todosRegistrosOnline;

    // 1. Filtrar por Tipo
    if (tipo !== 'all') {
        registrosFiltrados = registrosFiltrados.filter(r => r.tipo === tipo);
    }

    // 2. Filtrar por Per√≠odo
    const hoje = new Date();
    let dataLimite = null;

    if (periodo === 'today') {
        dataLimite = new Date(hoje.setHours(0, 0, 0, 0));
    } else if (periodo === 'custom' && dataInicioStr && dataFimStr) {
        const dI = new Date(dataInicioStr);
        const dF = new Date(dataFimStr);
        registrosFiltrados = registrosFiltrados.filter(r => {
            const rDate = new Date(r.dataHora);
            return rDate >= dI && rDate <= dF;
        });
    } else if (periodo !== 'all' && periodo !== 'custom') {
        const dias = parseInt(periodo, 10);
        dataLimite = new Date(hoje.setDate(hoje.getDate() - dias));
    }

    if (dataLimite) {
        registrosFiltrados = registrosFiltrados.filter(r => new Date(r.dataHora) >= dataLimite);
    }

    // 3. Filtrar por Busca (Nome/Matr√≠cula)
    if (termoBusca) {
        registrosFiltrados = registrosFiltrados.filter(r => 
            (r.nome && r.nome.toLowerCase().includes(termoBusca)) ||
            (r.matricula && r.matricula.toLowerCase().includes(termoBusca))
        );
    }

    renderizarHistorico(registrosFiltrados);
}

function buscarRegistros() {
    // A fun√ß√£o buscarRegistros apenas chama aplicarFiltros para que a busca em tempo real funcione
    // em conjunto com os filtros de Tipo e Per√≠odo j√° selecionados.
    aplicarFiltros();
}

function limparFiltros() {
    document.getElementById('filtroTipo').value = 'all';
    document.getElementById('filtroPeriodo').value = 'all';
    document.getElementById('dataInicio').value = '';
    document.getElementById('dataFim').value = '';
    document.getElementById('searchInput').value = '';
    toggleCustomDate();
    aplicarFiltros();
}

function ordenarTabela(colIndex) {
    const tabela = document.getElementById('historicoTable');
    const th = tabela.tHead.rows[0].cells[colIndex];
    const tbody = tabela.tBodies[0];
    const linhas = Array.from(tbody.rows);
    const tipoAtual = th.getAttribute('data-tipo') || 'string';

    const dir = sortDirection[colIndex] === 'asc' ? 'desc' : 'asc';
    sortDirection = {}; // Limpa as outras ordena√ß√µes
    sortDirection[colIndex] = dir;

    // Atualiza √≠cones de ordena√ß√£o
    tabela.querySelectorAll('th').forEach((header, index) => {
        const icon = header.querySelector('.sort-icon');
        header.classList.remove('sorted');
        icon.textContent = 'unfold_more';
        if (index === colIndex) {
            header.classList.add('sorted');
            icon.textContent = dir === 'asc' ? 'arrow_drop_up' : 'arrow_drop_down';
        }
    });

    // Fun√ß√£o de compara√ß√£o
    const comparador = (a, b) => {
        let aVal = a.cells[colIndex].textContent.trim();
        let bVal = b.cells[colIndex].textContent.trim();
        
        // Trata a coluna Data/Hora (√≠ndice 1) para ordena√ß√£o correta
        if (colIndex === 1) {
             aVal = new Date(aVal.replace(/(\d{2})\/(\d{2})\/(\d{4}) (\d{2}):(\d{2})/, '$3-$2-$1T$4:$5')).getTime();
             bVal = new Date(bVal.replace(/(\d{2})\/(\d{2})\/(\d{4}) (\d{2}):(\d{2})/, '$3-$2-$1T$4:$5')).getTime();
             if (isNaN(aVal)) aVal = -Infinity; // Coloca datas inv√°lidas no final
             if (isNaN(bVal)) bVal = -Infinity;
        } 
        
        // Trata colunas de Leitura/Consumo (√≠ndices 4, 5, 6) para ordena√ß√£o num√©rica
        else if (colIndex >= 4 && colIndex <= 6) {
             // Remove a unidade (m¬≥ ou kWh) e converte para float
             aVal = parseFloat(aVal.split(' ')[0]) || 0;
             bVal = parseFloat(bVal.split(' ')[0]) || 0;
        }

        let comparison = 0;
        if (aVal > bVal) comparison = 1;
        else if (aVal < bVal) comparison = -1;

        return dir === 'asc' ? comparison : comparison * -1;
    };

    // Ordena as linhas
    linhas.sort(comparador);

    // Reinsere as linhas na tabela
    linhas.forEach(row => tbody.appendChild(row));
}

// Fun√ß√µes para Modals e Edi√ß√£o Online (Implementa√ß√£o de base)

function abrirModalEditOnline(rowId, tipo) {
    const registro = todosRegistrosOnline.find(r => r.rowId === rowId && r.tipo === tipo);
    if (!registro) {
        mostrarAlerta('configAlert', 'Registro n√£o encontrado!', 'error');
        return;
    }

    // Preencher campos
    document.getElementById('editOnlineRowId').value = rowId;
    document.getElementById('editOnlineTipo').value = tipo;
    document.getElementById('editOnlineNome').value = registro.nome;
    document.getElementById('editOnlineMatricula').value = registro.matricula;
    
    // Converter a data para o formato datetime-local
    const date = new Date(registro.dataHora);
    const localDate = new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
    document.getElementById('editOnlineDataHora').value = localDate;
    
    const unidade = tipo === 'agua' ? 'm¬≥' : 'kWh';
    document.getElementById('labelEditOnlineLeituraAnterior').textContent = `Leitura Anterior (${unidade})`;
    document.getElementById('labelEditOnlineLeituraAtual').textContent = `Leitura Atual do Medidor (${unidade}) *`;
    document.getElementById('labelEditOnlineConsumoTotal').textContent = `Consumo Total Calculado (${unidade})`;

    document.getElementById('editOnlineLeituraAnterior').value = parseFloat(registro.leituraAnterior).toFixed(2);
    document.getElementById('editOnlineLeituraAtual').value = parseFloat(registro.leituraAtual).toFixed(2);
    document.getElementById('editOnlineConsumoTotal').value = parseFloat(registro.consumoTotal).toFixed(2);
    document.getElementById('editOnlineExtra1').value = registro.extra1 || '';
    document.getElementById('editOnlineExtra2').value = registro.extra2 || '';
    document.getElementById('editOnlineExtra3').value = registro.extra3 || '';

    document.getElementById('editOnlineModal').style.display = 'block';
    mostrarAlerta('alertEditOnlineModal', '', ''); // Limpa alertas anteriores
}

function fecharModalEditOnline() {
    document.getElementById('editOnlineModal').style.display = 'none';
}

function calcularConsumoModalOnline() {
    const tipo = document.getElementById('editOnlineTipo').value;
    const leituraAtualInput = document.getElementById('editOnlineLeituraAtual');
    const leituraAnteriorInput = document.getElementById('editOnlineLeituraAnterior');
    const consumoTotalInput = document.getElementById('editOnlineConsumoTotal');
    
    const leituraAtual = parseFloat(leituraAtualInput.value) || 0;
    const leituraAnterior = parseFloat(leituraAnteriorInput.value) || 0;
    
    const consumo = Math.max(0, leituraAtual - leituraAnterior);
    consumoTotalInput.value = consumo.toFixed(2);
}

async function salvarEdicaoOnline(event) {
    event.preventDefault();
    if (isProcessing || !scriptURL || !sheetID) return;

    const btn = event.target.querySelector('button[type="submit"]');
    btn.disabled = true;
    btn.innerHTML = '<span class="loading"></span> Salvando...';
    isProcessing = true;
    mostrarAlerta('alertEditOnlineModal', '', '');

    const rowId = document.getElementById('editOnlineRowId').value;
    const tipo = document.getElementById('editOnlineTipo').value;
    const form = new FormData(event.target);
    const dados = {
        action: 'editRecord',
        sheetId: sheetID,
        rowId: rowId,
        tipo: tipo,
        nome: form.get('nome'),
        matricula: form.get('matricula'),
        dataHora: form.get('dataHora'),
        leituraAtual: form.get('leituraAtual'),
        consumoTotal: form.get('consumoTotal'),
        leituraAnterior: document.getElementById('editOnlineLeituraAnterior').value, // Pegar valor do readonly
        extra1: form.get('extra1'),
        extra2: form.get('extra2'),
        extra3: form.get('extra3')
    };

    try {
        const response = await fetch(scriptURL, {
            method: 'POST',
            body: new URLSearchParams(dados)
        });
        const data = await response.json();

        if (data.status === 'success') {
            mostrarAlerta('alertEditOnlineModal', 'Edi√ß√£o salva com sucesso! Atualizando hist√≥rico...', 'success');
            await carregarDados(); // Recarrega todos os dados e hist√≥rico
            fecharModalEditOnline();
        } else {
            mostrarAlerta('alertEditOnlineModal', 'Erro ao salvar: ' + (data.message || 'Erro desconhecido.'), 'error');
        }
    } catch (error) {
        mostrarAlerta('alertEditOnlineModal', 'Erro de conex√£o: ' + error.message, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<span class="material-icons">save</span> Salvar Altera√ß√µes';
        isProcessing = false;
    }
}

async function deletarRegistroOnline(rowId, tipo) {
    if (!confirm(`Tem certeza que deseja excluir o registro ${rowId} de ${tipo.toUpperCase()}? Esta a√ß√£o √© irrevers√≠vel!`)) {
        return;
    }
    if (isProcessing || !scriptURL || !sheetID) return;
    isProcessing = true;

    try {
        mostrarAlerta('configAlert', 'Excluindo registro...', 'warning');
        
        const dados = {
            action: 'deleteRecord',
            sheetId: sheetID,
            rowId: rowId,
            tipo: tipo
        };

        const response = await fetch(scriptURL, {
            method: 'POST',
            body: new URLSearchParams(dados)
        });
        const data = await response.json();

        if (data.status === 'success') {
            mostrarAlerta('configAlert', 'Registro exclu√≠do com sucesso! Recarregando hist√≥rico...', 'success');
            await carregarDados(); 
        } else {
            mostrarAlerta('configAlert', 'Erro ao excluir: ' + (data.message || 'Erro desconhecido.'), 'error');
        }
    } catch (error) {
        mostrarAlerta('configAlert', 'Erro de conex√£o: ' + error.message, 'error');
    } finally {
        isProcessing = false;
    }
}


// --- Fun√ß√µes Auxiliares (Completa√ß√µes de L√≥gica) ---

function mostrarAlerta(id, mensagem, tipo) {
    const alertElement = document.getElementById(id);
    if (!alertElement) return;

    alertElement.className = 'alert';
    alertElement.textContent = '';

    if (mensagem && tipo) {
        alertElement.classList.add('show', `alert-${tipo}`);
        alertElement.innerHTML = `<span class="material-icons">${tipo === 'success' ? 'check_circle' : (tipo === 'error' ? 'cancel' : 'warning')}</span> ${mensagem}`;
    }
}

function calcularConsumo(tipo) {
    const leituraAtualInput = document.getElementById(`leituraAtual${tipo === 'agua' ? 'Agua' : 'Energia'}`);
    const leituraAnteriorInput = document.getElementById(`leituraAnterior${tipo === 'agua' ? 'Agua' : 'Energia'}`);
    const consumoTotalInput = document.getElementById(`consumoTotal${tipo === 'agua' ? 'Agua' : 'Energia'}`);
    const consumptionValueDiv = document.getElementById(`consumptionValue${tipo === 'agua' ? 'Agua' : 'Energia'}`);
    const consumptionDisplay = document.getElementById(`consumptionDisplay${tipo === 'agua' ? 'Agua' : 'Energia'}`);

    const leituraAtual = parseFloat(leituraAtualInput.value) || 0;
    const leituraAnterior = parseFloat(leituraAnteriorInput.value) || 0;
    
    const consumo = Math.max(0, leituraAtual - leituraAnterior);
    consumoTotalInput.value = consumo.toFixed(2);
    consumptionValueDiv.textContent = consumo.toFixed(2) + (tipo === 'agua' ? ' m¬≥' : ' kWh');

    if (consumo > 0) {
        consumptionDisplay.style.display = 'block';
    } else {
        consumptionDisplay.style.display = 'none';
    }

    // Chama a fun√ß√£o de c√°lculo de custo para atualizar em tempo real a estimativa
    calcularCustoEstimado(); 
}

// Fun√ß√µes de Offline e Submiss√£o (Necessitam de l√≥gica de Apps Script/Sheet ID para funcionar plenamente)

function carregarRegistrosPendentes() {
    // L√≥gica para carregar do localStorage 'offlineRecords' e popular a tabela de pendentes
    const offlineRecords = JSON.parse(localStorage.getItem('offlineRecords') || '[]');
    todosRegistrosOffline = offlineRecords;
    document.getElementById('pendingRecordsCount').textContent = offlineRecords.length.toString();
    
    const pendingCard = document.getElementById('pendingRecordsCard');
    if (offlineRecords.length > 0) {
        pendingCard.style.display = 'block';
    } else {
        pendingCard.style.display = 'none';
    }
    aplicarFiltrosOffline();
}

function aplicarFiltrosOffline() {
    // Implementa√ß√£o b√°sica de filtragem offline
    let registros = todosRegistrosOffline;
    const tipo = document.getElementById('filtroTipoOffline').value;

    if (tipo !== 'all') {
        registros = registros.filter(r => r.tipo === tipo);
    }
    
    // Renderizar na tabela de pendentes
    const tbody = document.getElementById('registrosPendentesBody');
    if (registros.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">Nenhum registro offline encontrado com os filtros.</td></tr>`;
        return;
    }
    
    let html = '';
    registros.forEach((reg, index) => {
        const badgeClass = reg.tipo === 'agua' ? 'badge-agua' : 'badge-energia';
        const unidade = reg.tipo === 'agua' ? 'm¬≥' : 'kWh';
        html += `
            <tr class="offline-row">
                <td><span class="badge ${badgeClass}">${reg.tipo.toUpperCase()}</span></td>
                <td>${new Date(reg.dataHora).toLocaleDateString('pt-BR')} ${new Date(reg.dataHora).toLocaleTimeString('pt-BR').substring(0, 5)}</td>
                <td>${reg.nome}</td>
                <td>${reg.matricula}</td>
                <td style="text-align: right;">${parseFloat(reg.leituraAtual).toFixed(2)} ${unidade}</td>
                <td style="text-align: right;">${parseFloat(reg.consumoTotal).toFixed(2)} ${unidade}</td>
                <td>
                    <button class="btn btn-edit" onclick="abrirModalEdicaoOffline(${index})" title="Editar Offline">
                        <span class="material-icons" style="font-size: 16px;">edit</span>
                    </button>
                    <button class="btn btn-danger" onclick="deletarRegistroOffline(${index})" title="Excluir Offline">
                        <span class="material-icons" style="font-size: 16px;">delete</span>
                    </button>
                </td>
            </tr>
        `;
    });
    tbody.innerHTML = html;
}

function abrirModalEdicaoOffline(index) {
    const reg = todosRegistrosOffline[index];
    if (!reg) return;

    document.getElementById('editIndex').value = index;
    document.getElementById('editTipo').value = reg.tipo;
    document.getElementById('editNome').value = reg.nome;
    document.getElementById('editMatricula').value = reg.matricula;
    
    const date = new Date(reg.dataHora);
    const localDate = new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
    document.getElementById('editDataHora').value = localDate;

    const unidade = reg.tipo === 'agua' ? 'm¬≥' : 'kWh';
    document.getElementById('labelLeituraAnterior').textContent = `Leitura Anterior (${unidade})`;
    document.getElementById('labelLeituraAtual').textContent = `Leitura Atual do Medidor (${unidade}) *`;
    document.getElementById('labelConsumoTotal').textContent = `Consumo Total Calculado (${unidade})`;

    document.getElementById('editLeituraAnterior').value = parseFloat(reg.leituraAnterior).toFixed(2);
    document.getElementById('editLeituraAtual').value = parseFloat(reg.leituraAtual).toFixed(2);
    document.getElementById('editConsumoTotal').value = parseFloat(reg.consumoTotal).toFixed(2);
    document.getElementById('editExtra1').value = reg.extra1 || '';
    document.getElementById('editExtra2').value = reg.extra2 || '';
    document.getElementById('editExtra3').value = reg.extra3 || '';

    document.getElementById('editModal').style.display = 'block';
    mostrarAlerta('alertEditModal', '', ''); 
}

function fecharModal() {
    document.getElementById('editModal').style.display = 'none';
}

function calcularConsumoModal() {
    const tipo = document.getElementById('editTipo').value;
    const leituraAtualInput = document.getElementById('editLeituraAtual');
    const leituraAnteriorInput = document.getElementById('editLeituraAnterior');
    const consumoTotalInput = document.getElementById('editConsumoTotal');
    
    const leituraAtual = parseFloat(leituraAtualInput.value) || 0;
    const leituraAnterior = parseFloat(leituraAnteriorInput.value) || 0;
    
    const consumo = Math.max(0, leituraAtual - leituraAnterior);
    consumoTotalInput.value = consumo.toFixed(2);
}

function salvarEdicao(event) {
    event.preventDefault();

    const index = parseInt(document.getElementById('editIndex').value, 10);
    const form = new FormData(event.target);
    const btn = event.target.querySelector('button[type="submit"]');

    if (index >= 0 && index < todosRegistrosOffline.length) {
        todosRegistrosOffline[index] = {
            ...todosRegistrosOffline[index],
            nome: form.get('nome'),
            matricula: form.get('matricula'),
            dataHora: form.get('dataHora'),
            leituraAnterior: document.getElementById('editLeituraAnterior').value,
            leituraAtual: form.get('leituraAtual'),
            consumoTotal: form.get('consumoTotal'),
            extra1: form.get('extra1'),
            extra2: form.get('extra2'),
            extra3: form.get('extra3')
        };
        localStorage.setItem('offlineRecords', JSON.stringify(todosRegistrosOffline));
        
        mostrarAlerta('alertEditModal', 'Edi√ß√£o salva no modo offline!', 'success');
        btn.innerHTML = '<span class="material-icons">save</span> Salvo!';
        setTimeout(() => {
            fecharModal();
            carregarRegistrosPendentes();
            btn.innerHTML = '<span class="material-icons">save</span> Salvar Edi√ß√£o';
        }, 1000);
    } else {
        mostrarAlerta('alertEditModal', 'Erro ao encontrar o registro.', 'error');
    }
}

function deletarRegistroOffline(index) {
    if (confirm("Tem certeza que deseja remover este registro offline?")) {
        todosRegistrosOffline.splice(index, 1);
        localStorage.setItem('offlineRecords', JSON.stringify(todosRegistrosOffline));
        carregarRegistrosPendentes();
    }
}

async function sincronizarRegistrosPendentes() {
    if (!scriptURL || !sheetID || todosRegistrosOffline.length === 0) {
        mostrarAlerta('syncAlert', 'Nenhum registro para sincronizar ou configura√ß√£o ausente.', 'warning');
        return;
    }
    
    if (isProcessing) return;
    isProcessing = true;
    mostrarAlerta('syncAlert', `Sincronizando ${todosRegistrosOffline.length} registro(s)...`, 'warning');

    const registrosParaEnviar = todosRegistrosOffline;
    let sucesso = 0;
    let falha = 0;
    
    for (const reg of registrosParaEnviar) {
        try {
            const dados = {
                action: 'addRecord',
                sheetId: sheetID,
                tipo: reg.tipo,
                nome: reg.nome,
                matricula: reg.matricula,
                dataHora: reg.dataHora,
                leituraAtual: reg.leituraAtual,
                leituraAnterior: reg.leituraAnterior,
                consumoTotal: reg.consumoTotal,
                extra1: reg.extra1,
                extra2: reg.extra2,
                extra3: reg.extra3
            };
            
            const response = await fetch(scriptURL, {
                method: 'POST',
                body: new URLSearchParams(dados)
            });
            const data = await response.json();

            if (data.status === 'success') {
                sucesso++;
                todosRegistrosOffline = todosRegistrosOffline.filter(r => r !== reg); // Remove o registro enviado com sucesso
            } else {
                falha++;
                console.error('Falha ao enviar registro:', reg, data.message);
            }
        } catch (error) {
            falha++;
            console.error('Erro de rede ao enviar registro:', reg, error);
        }
    }

    localStorage.setItem('offlineRecords', JSON.stringify(todosRegistrosOffline));
    
    if (falha === 0) {
        mostrarAlerta('syncAlert', `‚úÖ Sincroniza√ß√£o completa! ${sucesso} registro(s) enviados.`, 'success');
    } else {
        mostrarAlerta('syncAlert', `‚ö†Ô∏è Sincroniza√ß√£o parcial. ${sucesso} enviados, ${falha} falharam.`, 'error');
    }
    
    isProcessing = false;
    carregarRegistrosPendentes();
    await carregarDados(); // Recarrega o hist√≥rico online e estat√≠sticas
}

function limparTodosRegistrosOffline() {
    if (confirm("ATEN√á√ÉO: Voc√™ tem certeza que deseja APAGAR TODOS os registros offline? Esta a√ß√£o √© irrevers√≠vel e pode causar perda de dados n√£o sincronizados!")) {
        localStorage.removeItem('offlineRecords');
        carregarRegistrosPendentes();
        mostrarAlerta('syncAlert', 'Todos os registros offline foram removidos.', 'success');
    }
}

async function handleSubmit(event, tipo) {
    event.preventDefault();
    if (isProcessing) return;

    const form = document.getElementById(`${tipo}Form`);
    const btn = form.querySelector('button[type="submit"]');
    const alertId = `alert${tipo === 'agua' ? 'Agua' : 'Energia'}`;

    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    btn.disabled = true;
    btn.innerHTML = '<span class="loading"></span> Processando...';
    isProcessing = true;
    mostrarAlerta(alertId, '', '');

    const dados = {
        action: 'addRecord',
        sheetId: sheetID,
        tipo: tipo,
        nome: document.getElementById(`nome${tipo === 'agua' ? 'Agua' : 'Energia'}`).value,
        matricula: document.getElementById(`matricula${tipo === 'agua' ? 'Agua' : 'Energia'}`).value,
        dataHora: document.getElementById(`dataHora${tipo === 'agua' ? 'Agua' : 'Energia'}`).value,
        leituraAtual: document.getElementById(`leituraAtual${tipo === 'agua' ? 'Agua' : 'Energia'}`).value,
        leituraAnterior: document.getElementById(`leituraAnterior${tipo === 'agua' ? 'Agua' : 'Energia'}`).value,
        consumoTotal: document.getElementById(`consumoTotal${tipo === 'agua' ? 'Agua' : 'Energia'}`).value,
        extra1: form.elements['extra1'].value,
        extra2: form.elements['extra2'].value,
        extra3: form.elements['extra3'].value
    };

    localStorage.setItem('ultimoNome', dados.nome);
    localStorage.setItem('ultimaMatricula', dados.matricula);

    if (!scriptURL || !sheetID) {
        // Modo Offline
        salvarRegistroOffline(dados, btn, alertId);
        return;
    }

    // Modo Online
    try {
        const response = await fetch(scriptURL, {
            method: 'POST',
            body: new URLSearchParams(dados)
        });
        const data = await response.json();

        if (data.status === 'success') {
            mostrarAlerta(alertId, `‚úÖ Registro de ${tipo} enviado com sucesso!`, 'success');
            form.reset();
            setDataHoraAtual();
            await carregarDados(); // Recarrega dados ap√≥s sucesso
        } else {
            throw new Error(data.message || 'Erro desconhecido');
        }
    } catch (error) {
        console.error('Erro de rede ou Apps Script:', error);
        mostrarAlerta(alertId, `‚ö†Ô∏è Erro de rede. Salvando offline. ${error.message}`, 'error');
        salvarRegistroOffline(dados, btn, alertId);
    } finally {
        btn.disabled = false;
        btn.innerHTML = `<span class="material-icons">send</span> Registrar Consumo de ${tipo === 'agua' ? '√Ågua' : 'Energia'}`;
        isProcessing = false;
    }
}

function salvarRegistroOffline(dados, btn, alertId) {
    const offlineRecords = JSON.parse(localStorage.getItem('offlineRecords') || '[]');
    offlineRecords.push(dados);
    localStorage.setItem('offlineRecords', JSON.stringify(offlineRecords));
    
    mostrarAlerta(alertId, `üíæ Registro salvo localmente (Offline). Sincronize quando houver conex√£o.`, 'warning');
    
    btn.disabled = false;
    btn.innerHTML = `<span class="material-icons">send</span> Registrar Consumo de ${dados.tipo === 'agua' ? '√Ågua' : 'Energia'}`;
    isProcessing = false;
    
    document.getElementById(`${dados.tipo}Form`).reset();
    setDataHoraAtual();
    carregarRegistrosPendentes();
}

// Fun√ß√µes de Gr√°fico (Implementa√ß√£o de base)

function trocarGrafico(tipo) {
    currentChartType = tipo;
    document.querySelectorAll('.chart-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelector(`.chart-tab[onclick="trocarGrafico('${tipo}')"]`).classList.add('active');
    atualizarGrafico();
}

function atualizarGrafico() {
    if (!todosRegistrosOnline.length) {
        document.getElementById('consumptionChart').innerHTML = '';
        if (currentChart) currentChart.destroy();
        return;
    }
    
    const ctx = document.getElementById('consumptionChart').getContext('2d');
    if (currentChart) currentChart.destroy();
    
    // Agrupamento por dia (para visualiza√ß√£o de evolu√ß√£o/compara√ß√£o)
    const dadosAgrupados = todosRegistrosOnline.reduce((acc, reg) => {
        const data = toYYYYMMDD(reg.dataHora);
        if (!acc[data]) {
            acc[data] = { agua: 0, energia: 0 };
        }
        acc[data][reg.tipo] += parseFloat(reg.consumoTotal) || 0;
        return acc;
    }, {});

    const datas = Object.keys(dadosAgrupados).sort();
    const consumoAgua = datas.map(d => dadosAgrupados[d].agua);
    const consumoEnergia = datas.map(d => dadosAgrupados[d].energia);
    
    const labels = datas.map(d => new Date(d).toLocaleDateString('pt-BR').substring(0, 5));
    
    const colors = [
        document.documentElement.getAttribute('data-theme') === 'dark' ? '#64b5f6' : 'rgba(30, 136, 229, 0.8)', // Primary (√Ågua)
        document.documentElement.getAttribute('data-theme') === 'dark' ? '#ffb74d' : 'rgba(255, 111, 0, 0.8)'  // Accent (Energia)
    ];
    
    if (currentChartType === 'line' || currentChartType === 'bar') {
        currentChart = new Chart(ctx, {
            type: currentChartType,
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Consumo √Ågua (m¬≥)',
                        data: consumoAgua,
                        borderColor: colors[0],
                        backgroundColor: currentChartType === 'bar' ? colors[0] : 'transparent',
                        tension: 0.3,
                        fill: currentChartType === 'line' ? true : false,
                    },
                    {
                        label: 'Consumo Energia (kWh)',
                        data: consumoEnergia,
                        borderColor: colors[1],
                        backgroundColor: currentChartType === 'bar' ? colors[1] : 'transparent',
                        tension: 0.3,
                        fill: currentChartType === 'line' ? true : false,
                        yAxisID: 'y1' 
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: '√Ågua (m¬≥)', color: colors[0] },
                        position: 'left',
                        grid: { color: document.documentElement.getAttribute('data-theme') === 'dark' ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)' }
                    },
                    y1: {
                        beginAtZero: true,
                        title: { display: true, text: 'Energia (kWh)', color: colors[1] },
                        position: 'right',
                        grid: { drawOnChartArea: false }
                    },
                    x: {
                        grid: { color: document.documentElement.getAttribute('data-theme') === 'dark' ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)' }
                    }
                },
                plugins: {
                    legend: {
                        labels: { color: document.documentElement.getAttribute('data-theme') === 'dark' ? 'white' : 'black' }
                    }
                }
            }
        });
    } else if (currentChartType === 'pie') {
        const totalAgua = consumoAgua.reduce((sum, val) => sum + val, 0);
        const totalEnergia = consumoEnergia.reduce((sum, val) => sum + val, 0);
        
        currentChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Consumo Total √Ågua', 'Consumo Total Energia'],
                datasets: [{
                    data: [totalAgua, totalEnergia],
                    backgroundColor: [colors[0], colors[1]],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: { color: document.documentElement.getAttribute('data-theme') === 'dark' ? 'white' : 'black' }
                    }
                }
            }
        });
    }
}

function exportarGrafico() {
    if (!currentChart) {
        mostrarAlerta('configAlert', 'Nenhum gr√°fico para exportar!', 'error');
        return;
    }
    const canvas = document.getElementById('consumptionChart');
    const image = canvas.toDataURL('image/png');
    const a = document.createElement('a');
    a.href = image;
    a.download = `relatorio_consumo_${currentChartType}_${new Date().toISOString().split('T')[0]}.png`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}


// Fun√ß√µes de Relat√≥rio/Exporta√ß√£o (Implementa√ß√£o de base)

function atualizarRelatorio() {
    const periodo = document.getElementById('relatorioPeriodo').value;
    let registrosFiltrados = todosRegistrosOnline;

    if (periodo !== 'all') {
        const dias = parseInt(periodo, 10);
        const dataLimite = new Date(Date.now() - dias * 24 * 60 * 60 * 1000);
        registrosFiltrados = todosRegistrosOnline.filter(r => new Date(r.dataHora) >= dataLimite);
    }

    // Calcula Consumo Total no Per√≠odo
    let totalConsumoAgua = 0;
    let totalConsumoEnergia = 0;

    // Agrupa por tipo e encontra a maior e menor leitura no per√≠odo
    const leiturasAgua = registrosFiltrados.filter(r => r.tipo === 'agua').map(r => parseFloat(r.leituraAtual)).filter(l => !isNaN(l));
    const leiturasEnergia = registrosFiltrados.filter(r => r.tipo === 'energia').map(r => parseFloat(r.leituraAtual)).filter(l => !isNaN(l));
    
    // Se n√£o houver registros, use 0
    if (leiturasAgua.length > 0) {
        const minAgua = Math.min(...leiturasAgua);
        const maxAgua = Math.max(...leiturasAgua);
        totalConsumoAgua = maxAgua - minAgua;
    }

    if (leiturasEnergia.length > 0) {
        const minEnergia = Math.min(...leiturasEnergia);
        const maxEnergia = Math.max(...leiturasEnergia);
        totalConsumoEnergia = maxEnergia - minEnergia;
    }

    // Calcula M√©dia Di√°ria
    let diasNoPeriodo = 0;
    if (registrosFiltrados.length > 0 && periodo !== 'all') {
        const dataMaisAntiga = new Date(registrosFiltrados[0].dataHora);
        const dataMaisRecente = new Date(registrosFiltrados[registrosFiltrados.length - 1].dataHora);
        diasNoPeriodo = Math.ceil((dataMaisRecente - dataMaisAntiga) / (1000 * 60 * 60 * 24)) || 1; 
    } else if (periodo !== 'all') {
        diasNoPeriodo = parseInt(periodo, 10);
    }
    
    const mediaAgua = diasNoPeriodo > 0 ? totalConsumoAgua / diasNoPeriodo : 0;
    const mediaEnergia = diasNoPeriodo > 0 ? totalConsumoEnergia / diasNoPeriodo : 0;

    document.getElementById('relatorioTotalAgua').textContent = totalConsumoAgua.toFixed(2) + ' m¬≥';
    document.getElementById('relatorioTotalEnergia').textContent = totalConsumoEnergia.toFixed(2) + ' kWh';
    document.getElementById('relatorioMediaAgua').textContent = mediaAgua.toFixed(2) + ' m¬≥/dia';
    document.getElementById('relatorioMediaEnergia').textContent = mediaEnergia.toFixed(2) + ' kWh/dia';
}

function exportarCSV() {
    // Cabe√ßalho da tabela de hist√≥rico
    const header = ["Tipo", "Data/Hora", "Nome", "Matr√≠cula", "Leitura Anterior", "Leitura Atual", "Consumo", "Extra 1", "Extra 2", "Extra 3"];
    
    let csvContent = header.join(";") + "\n";

    todosRegistrosOnline.forEach(reg => {
        const row = [
            reg.tipo,
            new Date(reg.dataHora).toLocaleString('pt-BR'),
            reg.nome,
            reg.matricula,
            parseFloat(reg.leituraAnterior).toFixed(2),
            parseFloat(reg.leituraAtual).toFixed(2),
            parseFloat(reg.consumoTotal).toFixed(2),
            reg.extra1 || '',
            reg.extra2 || '',
            reg.extra3 || ''
        ].map(item => `"${item}"`).join(";"); // Envolve em aspas e usa ; como separador
        csvContent += row + "\n";
    });

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.setAttribute('href', url);
    link.setAttribute('download', `historico_consumo_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

function gerarRelatorioPDF() {
    // Adapta√ß√£o da l√≥gica de exporta√ß√£o de PDF (requer as bibliotecas jspdf e html2canvas)
    const { jsPDF } = window.jspdf;
    
    window.scrollTo(0, 0); // Rola para o topo antes de capturar

    const input = document.querySelector('.container');
    html2canvas(input, { scale: 2 }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF('p', 'mm', 'a4');
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save(`relatorio_consumo_${new Date().toISOString().split('T')[0]}.pdf`);
    });
}

// Fun√ß√µes de C√°lculo de Custo (Implementa√ß√£o de base)

function carregarFormulasSalvas() {
    const formulaSalva = localStorage.getItem('formulaEscolhida') || 'simples';
    document.querySelector(`input[name="formulaEscolhida"][value="${formulaSalva}"]`).checked = true;
    
    // Carregar par√¢metros detalhados
    document.getElementById('tarifaAgua').value = localStorage.getItem('tarifaAgua') || '4.50';
    document.getElementById('taxaEsgoto').value = localStorage.getItem('taxaEsgoto') || '80';
    document.getElementById('taxaDisponibilidadeAgua').value = localStorage.getItem('taxaDisponibilidadeAgua') || '25.00';
    document.getElementById('pisAgua').value = localStorage.getItem('pisAgua') || '1.65';
    document.getElementById('cofinsAgua').value = localStorage.getItem('cofinsAgua') || '7.60';
    
    document.getElementById('tarifaEnergia').value = localStorage.getItem('tarifaEnergia') || '0.80';
    document.getElementById('tusd').value = localStorage.getItem('tusd') || '0.35';
    document.getElementById('tust').value = localStorage.getItem('tust') || '0.05';
    document.getElementById('bandeiraTarifaria').value = localStorage.getItem('bandeiraTarifaria') || '0.00';
    document.getElementById('icmsEnergia').value = localStorage.getItem('icmsEnergia') || '18.00';
    document.getElementById('pisEnergia').value = localStorage.getItem('pisEnergia') || '1.65';
    document.getElementById('cofinsEnergia').value = localStorage.getItem('cofinsEnergia') || '7.60';
    document.getElementById('cipEnergia').value = localStorage.getItem('cipEnergia') || '15.00';

    if (formulaSalva === 'detalhada') {
         document.getElementById('parametrosDetalhados').style.display = 'block';
    } else {
        document.getElementById('parametrosDetalhados').style.display = 'none';
    }
}

function salvarFormulaEscolhida() {
    const formula = document.querySelector('input[name="formulaEscolhida"]:checked').value;
    localStorage.setItem('formulaEscolhida', formula);

    localStorage.setItem('tarifaAgua', document.getElementById('tarifaAgua').value);
    localStorage.setItem('taxaEsgoto', document.getElementById('taxaEsgoto').value);
    localStorage.setItem('taxaDisponibilidadeAgua', document.getElementById('taxaDisponibilidadeAgua').value);
    localStorage.setItem('pisAgua', document.getElementById('pisAgua').value);
    localStorage.setItem('cofinsAgua', document.getElementById('cofinsAgua').value);
    
    localStorage.setItem('tarifaEnergia', document.getElementById('tarifaEnergia').value);
    localStorage.setItem('tusd', document.getElementById('tusd').value);
    localStorage.setItem('tust', document.getElementById('tust').value);
    localStorage.setItem('bandeiraTarifaria', document.getElementById('bandeiraTarifaria').value);
    localStorage.setItem('icmsEnergia', document.getElementById('icmsEnergia').value);
    localStorage.setItem('pisEnergia', document.getElementById('pisEnergia').value);
    localStorage.setItem('cofinsEnergia', document.getElementById('cofinsEnergia').value);
    localStorage.setItem('cipEnergia', document.getElementById('cipEnergia').value);

    mostrarAlerta('configAlert', 'F√≥rmulas e Par√¢metros salvos com sucesso!', 'success');
}

function alterarTipoCalculo() {
    const tipo = document.getElementById('tipoCalculo').value;
    document.getElementById('seletorPeriodo').style.display = tipo === 'dias' ? 'block' : 'none';
    document.getElementById('seletorMes').style.display = tipo === 'mes' ? 'block' : 'none';
    calcularCustoEstimado();
}

function calcularConsumoNoPeriodo(periodo) {
    // Usa a mesma l√≥gica do atualizarRelatorio, mas para um √∫nico per√≠odo
    let registrosFiltrados = todosRegistrosOnline;
    let diasNoPeriodo = 0;
    let dataInicio = null;
    let dataFim = new Date();
    
    if (periodo === 'today') {
        diasNoPeriodo = 1;
        dataInicio = new Date(dataFim.setHours(0, 0, 0, 0));
    } else if (periodo === 'all') {
        // Nenhuma filtragem, usa todos
    } else {
        const dias = parseInt(periodo, 10);
        diasNoPeriodo = dias;
        dataInicio = new Date(dataFim.setDate(dataFim.getDate() - dias));
    }

    if (dataInicio) {
        registrosFiltrados = todosRegistrosOnline.filter(r => new Date(r.dataHora) >= dataInicio);
    }

    let totalConsumoAgua = 0;
    let totalConsumoEnergia = 0;
    
    const leiturasAgua = registrosFiltrados.filter(r => r.tipo === 'agua').map(r => parseFloat(r.leituraAtual)).filter(l => !isNaN(l));
    const leiturasEnergia = registrosFiltrados.filter(r => r.tipo === 'energia').map(r => parseFloat(r.leituraAtual)).filter(l => !isNaN(l));

    if (leiturasAgua.length > 0) {
        const minAgua = Math.min(...leiturasAgua);
        const maxAgua = Math.max(...leiturasAgua);
        totalConsumoAgua = Math.max(0, maxAgua - minAgua);
    }
    if (leiturasEnergia.length > 0) {
        const minEnergia = Math.min(...leiturasEnergia);
        const maxEnergia = Math.max(...leiturasEnergia);
        totalConsumoEnergia = Math.max(0, maxEnergia - minEnergia);
    }
    
    return { agua: totalConsumoAgua, energia: totalConsumoEnergia, dias: diasNoPeriodo };
}

function calcularCustoEstimado() {
    const tipoCalculo = document.getElementById('tipoCalculo').value;
    const formula = document.querySelector('input[name="formulaEscolhida"]:checked').value;
    let consumoAgua = 0;
    let consumoEnergia = 0;
    
    if (tipoCalculo === 'dias') {
        const periodo = document.getElementById('periodoCalculo').value;
        const consumoPeriodo = calcularConsumoNoPeriodo(periodo);
        consumoAgua = consumoPeriodo.agua;
        consumoEnergia = consumoPeriodo.energia;
    } else if (tipoCalculo === 'mes') {
        // L√≥gica de c√°lculo de consumo por m√™s (mais complexo, requer agrupamento por ciclo de fatura)
        // Por simplifica√ß√£o, vamos assumir o consumo do √∫ltimo m√™s fechado ou buscar no servidor.
        // Aqui, ser√° usado um valor fixo apenas para demonstra√ß√£o da l√≥gica do custo.
        // Em um sistema real, esta fun√ß√£o buscaria no DB o consumo do m√™s escolhido.
        consumoAgua = 15.00; // Exemplo para o m√™s
        consumoEnergia = 250.00; // Exemplo para o m√™s
    }

    document.getElementById('custoConsumoAgua').textContent = consumoAgua.toFixed(2) + ' m¬≥';
    document.getElementById('custoConsumoEnergia').textContent = consumoEnergia.toFixed(2) + ' kWh';

    let custoAgua = 0;
    let custoEnergia = 0;
    let breakdownAgua = '';
    let breakdownEnergia = '';
    
    const BRL = (valor) => `R$ ${valor.toFixed(2).replace('.', ',')}`;

    // --- C√ÅLCULO √ÅGUA ---
    const tarifaAgua = parseFloat(document.getElementById('tarifaAgua').value) || 0;
    const taxaEsgotoPct = parseFloat(document.getElementById('taxaEsgoto').value) || 0;
    
    if (formula === 'simples') {
        custoAgua = consumoAgua * tarifaAgua;
        const esgoto = custoAgua * (taxaEsgotoPct / 100);
        custoAgua += esgoto;
        
        breakdownAgua = `
            <p>Consumo (${consumoAgua.toFixed(2)} m¬≥ @ ${BRL(tarifaAgua)}/m¬≥): ${BRL(consumoAgua * tarifaAgua)}</p>
            <p>Taxa de Esgoto (${taxaEsgotoPct}%): ${BRL(esgoto)}</p>
            <p><strong>Total Estimado: ${BRL(custoAgua)}</strong></p>
        `;
    } else { // Detalhada
        const baseAgua = consumoAgua * tarifaAgua;
        const dispAgua = parseFloat(document.getElementById('taxaDisponibilidadeAgua').value) || 0;
        const esgoto = baseAgua * (taxaEsgotoPct / 100);
        const pisAguaPct = (parseFloat(document.getElementById('pisAgua').value) || 0) / 100;
        const cofinsAguaPct = (parseFloat(document.getElementById('cofinsAgua').value) || 0) / 100;

        let subtotal = baseAgua + dispAgua + esgoto;
        const pis = subtotal * pisAguaPct;
        const cofins = subtotal * cofinsAguaPct;
        
        custoAgua = subtotal + pis + cofins;

        breakdownAgua = `
            <p>Tarifa Base: ${BRL(baseAgua)}</p>
            <p>Taxa de Esgoto (${taxaEsgotoPct}%): ${BRL(esgoto)}</p>
            <p>Taxa de Disponibilidade: ${BRL(dispAgua)}</p>
            <p>PIS (${(pisAguaPct * 100).toFixed(2)}%): ${BRL(pis)}</p>
            <p>COFINS (${(cofinsAguaPct * 100).toFixed(2)}%): ${BRL(cofins)}</p>
            <p><strong>Total Estimado: ${BRL(custoAgua)}</strong></p>
        `;
    }

    // --- C√ÅLCULO ENERGIA ---
    const tarifaEnergia = parseFloat(document.getElementById('tarifaEnergia').value) || 0;
    
    if (formula === 'simples') {
        const icmsEnergiaPct = (parseFloat(document.getElementById('icmsEnergia').value) || 0) / 100;
        custoEnergia = consumoEnergia * tarifaEnergia;
        const impostos = custoEnergia * icmsEnergiaPct;
        custoEnergia += impostos;
        
        breakdownEnergia = `
            <p>Consumo (${consumoEnergia.toFixed(2)} kWh @ ${BRL(tarifaEnergia)}/kWh): ${BRL(consumoEnergia * tarifaEnergia)}</p>
            <p>Impostos (ICMS - ${(icmsEnergiaPct * 100).toFixed(2)}%): ${BRL(impostos)}</p>
            <p><strong>Total Estimado: ${BRL(custoEnergia)}</strong></p>
        `;
    } else { // Detalhada
        const tusd = parseFloat(document.getElementById('tusd').value) || 0;
        const tust = parseFloat(document.getElementById('tust').value) || 0;
        const bandeira = parseFloat(document.getElementById('bandeiraTarifaria').value) || 0;
        const cip = parseFloat(document.getElementById('cipEnergia').value) || 0;
        const icmsEnergiaPct = (parseFloat(document.getElementById('icmsEnergia').value) || 0) / 100;
        const pisEnergiaPct = (parseFloat(document.getElementById('pisEnergia').value) || 0) / 100;
        const cofinsEnergiaPct = (parseFloat(document.getElementById('cofinsEnergia').value) || 0) / 100;

        const tarifaFio = (tarifaEnergia + tusd + tust + bandeira) * consumoEnergia;
        
        // ICMS incide sobre TUSD + Tarifa + TUST
        const baseIcms = (tarifaEnergia + tusd + tust + bandeira) * consumoEnergia;
        const icms = baseIcms * icmsEnergiaPct;
        
        let subtotal = tarifaFio + icms;
        const pis = subtotal * pisEnergiaPct;
        const cofins = subtotal * cofinsEnergiaPct;
        
        custoEnergia = subtotal + pis + cofins + cip;

        breakdownEnergia = `
            <p>Tarifa Fio (Consumo + TUSD + TUST + Bandeira): ${BRL(tarifaFio)}</p>
            <p>ICMS (${(icmsEnergiaPct * 100).toFixed(2)}%): ${BRL(icms)}</p>
            <p>PIS (${(pisEnergiaPct * 100).toFixed(2)}%): ${BRL(pis)}</p>
            <p>COFINS (${(cofinsEnergiaPct * 100).toFixed(2)}%): ${BRL(cofins)}</p>
            <p>CIP (Taxa Fixa): ${BRL(cip)}</p>
            <p><strong>Total Estimado: ${BRL(custoEnergia)}</strong></p>
        `;
    }

    document.getElementById('custoEstimadoAgua').textContent = BRL(custoAgua);
    document.getElementById('custoEstimadoEnergia').textContent = BRL(custoEnergia);
    document.getElementById('breakdownAgua').innerHTML = breakdownAgua;
    document.getElementById('breakdownEnergia').innerHTML = breakdownEnergia;
}

</script>
</body>
</html>
