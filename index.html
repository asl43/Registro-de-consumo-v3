<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Registro de Consumo v4.0</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }
    
    :root {
        --primary: #1e88e5;
        --secondary: #26a69a;
        --accent: #ff6f00;
        --success: #43a047;
        --error: #e53935;
        --warning: #fb8c00;
        --dark: #212121;
        --light: #f5f5f5;
        --border: #e0e0e0;
        --shadow: 0 2px 8px rgba(0,0,0,0.1);
        --shadow-lg: 0 4px 16px rgba(0,0,0,0.15);
        --bg-gradient-start: #667eea;
        --bg-gradient-end: #764ba2;
        --card-bg: #ffffff;
        --text-color: #212121;
        --text-secondary: #666;
    }

    [data-theme="dark"] {
        --dark: #f5f5f5;
        --light: #2a2a2a;
        --border: #444;
        --card-bg: #1e1e1e;
        --text-color: #e0e0e0;
        --text-secondary: #aaa;
        --bg-gradient-start: #2c3e50;
        --bg-gradient-end: #1a1a2e;
    }
    
    body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
        min-height: 100vh;
        padding: 20px;
        color: var(--text-color);
        transition: all 0.3s ease;
    }
    
    .container {
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
        animation: fadeInDown 0.6s ease;
        position: relative;
    }
    
    .header h1 {
        font-size: clamp(28px, 5vw, 42px);
        font-weight: 700;
        margin-bottom: 8px;
        text-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    
    .header p {
        font-size: 16px;
        opacity: 0.95;
    }

    .theme-toggle {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        background: var(--card-bg);
        border: 2px solid var(--border);
        border-radius: 50px;
        padding: 10px 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: var(--shadow-lg);
        transition: all 0.3s;
    }

    .theme-toggle:hover {
        transform: scale(1.05);
    }

    .theme-toggle .material-icons {
        font-size: 24px;
        color: var(--primary);
    }
    
    .status-bar {
        background: var(--card-bg);
        padding: 15px 25px;
        border-radius: 12px;
        box-shadow: var(--shadow-lg);
        margin-bottom: 25px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 15px;
        animation: fadeIn 0.6s ease;
    }
    
    .status-item {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .status-item .material-icons {
        font-size: 24px;
        color: var(--primary);
    }
    
    .status-text {
        font-size: 14px;
        color: var(--text-secondary);
    }
    
    .status-value {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-color);
    }
    
    .card {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 25px;
        box-shadow: var(--shadow);
        margin-bottom: 25px;
        animation: fadeInUp 0.6s ease;
    }
    
    .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--light);
    }

    .card-title {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .card-header .material-icons {
        font-size: 28px;
        color: var(--primary);
    }
    
    .card-header h2 {
        font-size: 20px;
        font-weight: 600;
        color: var(--text-color);
    }

    .card-actions {
        display: flex;
        gap: 10px;
    }
    
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
    }
    
    .form-group {
        margin-bottom: 18px;
    }
    
    .form-group label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        color: var(--text-color);
        margin-bottom: 8px;
    }
    
    .form-group input,
    .form-group select {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid var(--border);
        border-radius: 8px;
        font-size: 15px;
        font-family: inherit;
        transition: all 0.3s;
        background: var(--card-bg);
        color: var(--text-color);
    }
    
    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.1);
    }
    
    .form-group input:read-only {
        background: var(--light);
        color: var(--text-secondary);
        font-weight: 600;
        cursor: not-allowed;
    }
    
    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        text-decoration: none;
        white-space: nowrap;
    }
    
    .btn-primary {
        background: var(--primary);
        color: white;
        box-shadow: 0 4px 12px rgba(30, 136, 229, 0.3);
    }
    
    .btn-primary:hover:not(:disabled) {
        background: #1976d2;
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(30, 136, 229, 0.4);
    }
    
    .btn-primary:disabled {
        background: #bdbdbd;
        cursor: not-allowed;
        transform: none;
    }
    
    .btn-secondary {
        background: var(--secondary);
        color: white;
    }
    
    .btn-secondary:hover:not(:disabled) {
        background: #00897b;
        transform: translateY(-2px);
    }

    .btn-warning {
        background: var(--warning);
        color: white;
    }
    
    .btn-warning:hover:not(:disabled) {
        background: #f9a825;
        transform: translateY(-2px);
    }

    .btn-danger {
        background: var(--error);
        color: white;
        padding: 8px 16px;
        font-size: 14px;
    }
    
    .btn-danger:hover:not(:disabled) {
        background: #c62828;
        transform: translateY(-1px);
    }

    .btn-edit {
        background: var(--primary);
        color: white;
        padding: 8px 16px;
        font-size: 14px;
        margin-right: 8px;
    }
    
    .btn-edit:hover:not(:disabled) {
        background: #1976d2;
        transform: translateY(-1px);
    }

    .btn-icon {
        padding: 8px;
        width: 40px;
        height: 40px;
        border-radius: 8px;
    }
    
    .btn-full {
        width: 100%;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: var(--card-bg);
        padding: 25px;
        border-radius: 12px;
        box-shadow: var(--shadow);
        text-align: center;
        position: relative;
        overflow: hidden;
        transition: all 0.3s;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }
    
    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary), var(--secondary));
    }
    
    .stat-icon {
        font-size: 48px;
        margin-bottom: 10px;
    }
    
    .stat-label {
        font-size: 13px;
        color: var(--text-secondary);
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .stat-value {
        font-size: 32px;
        font-weight: 700;
        color: var(--text-color);
    }

    .trend-indicator {
        display: inline-flex;
        align-items: center;
        font-size: 14px;
        margin-top: 8px;
        padding: 4px 12px;
        border-radius: 20px;
        font-weight: 500;
    }

    .trend-up {
        background: #ffebee;
        color: var(--error);
    }

    .trend-down {
        background: #e8f5e9;
        color: var(--success);
    }

    .trend-neutral {
        background: var(--light);
        color: var(--text-secondary);
    }

    .chart-container {
        position: relative;
        height: 400px;
        margin-top: 20px;
    }

    .chart-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 2px solid var(--border);
    }

    .chart-tab {
        padding: 12px 24px;
        background: transparent;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        font-weight: 600;
        color: var(--text-secondary);
        transition: all 0.3s;
    }

    .chart-tab.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
    }

    .chart-tab:hover {
        color: var(--primary);
    }
    
    .filter-container {
        background: var(--light);
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 2px solid var(--border);
    }
    
    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        align-items: end;
    }
    
    .filter-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 15px;
    }

    .search-box {
        position: relative;
        margin-bottom: 15px;
    }

    .search-box input {
        width: 100%;
        padding: 12px 15px 12px 45px;
        border: 2px solid var(--border);
        border-radius: 8px;
        font-size: 15px;
        background: var(--card-bg);
        color: var(--text-color);
    }

    .search-box .material-icons {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
    }
    
    .table-container {
        overflow-x: auto;
        border-radius: 8px;
        border: 1px solid var(--border);
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
        min-width: 800px;
    }
    
    table thead {
        background: var(--dark);
        color: white;
    }
    
    table thead th {
        padding: 14px 16px;
        font-size: 13px;
        font-weight: 600;
        text-align: left;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        cursor: pointer;
        user-select: none;
    }

    table thead th:hover {
        background: rgba(255,255,255,0.1);
    }

    table thead th .sort-icon {
        font-size: 16px;
        vertical-align: middle;
        margin-left: 5px;
        opacity: 0.5;
    }

    table thead th.sorted .sort-icon {
        opacity: 1;
    }
    
    table tbody tr {
        border-bottom: 1px solid var(--border);
        transition: background 0.2s;
    }
    
    table tbody tr:hover {
        background: var(--light);
    }
    
    table tbody td {
        padding: 14px 16px;
        font-size: 14px;
        color: var(--text-color);
    }

    table tbody tr.offline-row {
        background: #fff8e1;
        font-weight: 500;
    }

    [data-theme="dark"] table tbody tr.offline-row {
        background: #3e2723;
    }
    
    .badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .badge-agua {
        background: #e3f2fd;
        color: #1976d2;
    }
    
    .badge-energia {
        background: #fff3e0;
        color: #f57c00;
    }

    .badge-offline {
        background: #ffecb3;
        color: #ffa000;
    }
    
    .alert {
        padding: 14px 18px;
        border-radius: 8px;
        margin-top: 15px;
        display: none;
        align-items: center;
        gap: 10px;
        font-size: 14px;
        font-weight: 500;
    }
    
    .alert.show {
        display: flex;
    }
    
    .alert-success {
        background: #e8f5e9;
        color: #2e7d32;
        border-left: 4px solid var(--success);
    }
    
    .alert-error {
        background: #ffebee;
        color: #c62828;
        border-left: 4px solid var(--error);
    }
    
    .alert-warning {
        background: #fffde7;
        color: #f57f17;
        border-left: 4px solid var(--warning);
    }
    
    .loading {
        display: inline-block;
        width: 18px;
        height: 18px;
        border: 3px solid rgba(255,255,255,0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.5);
        padding-top: 60px;
    }

    .modal-content {
        background-color: var(--card-bg);
        margin: 5% auto;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        width: 90%;
        max-width: 700px;
        position: relative;
        animation: fadeIn 0.3s;
    }

    .close-btn {
        color: var(--text-secondary);
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .close-btn:hover,
    .close-btn:focus {
        color: var(--text-color);
        text-decoration: none;
    }
    
    .consumption-display {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-top: 15px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    
    .consumption-display h3 {
        font-size: 16px;
        margin-bottom: 10px;
        opacity: 0.9;
    }
    
    .consumption-value {
        font-size: 36px;
        font-weight: 700;
        text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .daily-consumption-table {
        margin-top: 20px;
    }

    .daily-consumption-table table {
        min-width: 400px;
    }

    .autocomplete-items {
        position: absolute;
        border: 1px solid var(--border);
        border-top: none;
        z-index: 99;
        top: 100%;
        left: 0;
        right: 0;
        max-height: 200px;
        overflow-y: auto;
        background: var(--card-bg);
        border-radius: 0 0 8px 8px;
        box-shadow: var(--shadow);
    }

    .autocomplete-items div {
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid var(--border);
        color: var(--text-color);
    }

    .autocomplete-items div:hover {
        background: var(--light);
    }

    .keyboard-shortcuts {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--card-bg);
        padding: 15px;
        border-radius: 8px;
        box-shadow: var(--shadow-lg);
        font-size: 12px;
        display: none;
        z-index: 999;
    }

    .keyboard-shortcuts.show {
        display: block;
    }

    .keyboard-shortcuts h4 {
        margin-bottom: 10px;
        color: var(--text-color);
    }

    .keyboard-shortcuts kbd {
        background: var(--light);
        border: 1px solid var(--border);
        border-radius: 4px;
        padding: 2px 6px;
        font-family: monospace;
        color: var(--text-color);
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    @keyframes fadeInDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    @media print {
        .btn, .filter-container, .card-header, .theme-toggle {
            display: none !important;
        }
        
        body {
            background: white;
        }
        
        .card {
            box-shadow: none;
            border: 1px solid #000;
        }
    }

    @media (max-width: 768px) {
        body {
            padding: 15px;
        }
        
        .card {
            padding: 20px;
        }
        
        .form-grid {
            grid-template-columns: 1fr;
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .status-bar {
            flex-direction: column;
            align-items: flex-start;
        }

        .filter-grid {
            grid-template-columns: 1fr;
        }

        table {
             min-width: 600px;
        }

        .theme-toggle {
            top: 10px;
            right: 10px;
            padding: 8px 12px;
        }

        .chart-container {
            height: 300px;
        }
    }
</style>
</head>

<body>

<div class="theme-toggle" onclick="toggleTheme()">
    <span class="material-icons" id="themeIcon">dark_mode</span>
    <span id="themeText">Escuro</span>
</div>

<div class="keyboard-shortcuts" id="keyboardShortcuts">
    <h4>‚å®Ô∏è Atalhos de Teclado</h4>
    <p><kbd>Ctrl</kbd> + <kbd>S</kbd> - Salvar configura√ß√£o</p>
    <p><kbd>Esc</kbd> - Fechar modal</p>
    <p><kbd>?</kbd> - Mostrar/ocultar atalhos</p>
</div>

<div class="container">
    <div class="header">
        <h1>üíß‚ö° Sistema de Registro de Consumo v4.0</h1>
        <p>Controle inteligente com gr√°ficos, modo escuro e edi√ß√£o online</p>
    </div>
    
    <div class="status-bar">
        <div class="status-item">
            <span class="material-icons">cloud</span>
            <div>
                <div class="status-text">Status da Conex√£o</div>
                <div class="status-value" id="connectionStatus">Verificando...</div>
            </div>
        </div>
        <div class="status-item">
            <span class="material-icons">update</span>
            <div>
                <div class="status-text">√öltima Atualiza√ß√£o</div>
                <div class="status-value" id="lastUpdate">--:--</div>
            </div>
        </div>
        <div class="status-item">
            <span class="material-icons">storage</span>
            <div>
                <div class="status-text">Total de Registros</div>
                <div class="status-value" id="totalRecords">0</div>
            </div>
        </div>
        <div class="status-item">
            <span class="material-icons" style="color: var(--warning);">save</span>
            <div>
                <div class="status-text">Pendentes (Offline)</div>
                <div class="status-value" id="pendingRecordsCount">0</div>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <span class="material-icons">settings</span>
                <h2>Configura√ß√£o do Sistema</h2>
            </div>
        </div>
        
        <div class="form-grid">
            <div class="form-group">
                <label>üîó URL do Google Apps Script</label>
                <input type="url" id="scriptURL" placeholder="https://script.google.com/macros/s/.../exec">
            </div>
            <div class="form-group">
                <label>üìä ID da Planilha Google Sheets</label>
                <input type="text" id="sheetID" placeholder="ID da planilha (encontrado na URL)">
            </div>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
            <button class="btn btn-primary" onclick="salvarConfiguracao()">
                <span class="material-icons" style="font-size: 18px;">save</span>
                Salvar Configura√ß√£o
            </button>
            <button class="btn btn-secondary" onclick="testarConexao()">
                <span class="material-icons" style="font-size: 18px;">sync</span>
                Testar Conex√£o
            </button>
        </div>
        
        <div class="alert" id="configAlert"></div>
    </div>
    
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">üíß</div>
            <div class="stat-label">Leitura Atual √Ågua</div>
            <div class="stat-value" id="totalAgua">0.00 m¬≥</div>
            <div class="trend-indicator trend-neutral" id="trendAgua">
                <span class="material-icons" style="font-size: 16px;">remove</span>
                Est√°vel
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">‚ö°</div>
            <div class="stat-label">Leitura Atual Energia</div>
            <div class="stat-value" id="totalEnergia">0.00 kWh</div>
            <div class="trend-indicator trend-neutral" id="trendEnergia">
                <span class="material-icons" style="font-size: 16px;">remove</span>
                Est√°vel
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="color: var(--secondary);">üíß</div>
            <div class="stat-label">Consumo Hoje - √Ågua</div>
            <div class="stat-value" id="consumoHojeAgua">0.00 m¬≥</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="color: var(--accent);">‚ö°</div>
            <div class="stat-label">Consumo Hoje - Energia</div>
            <div class="stat-value" id="consumoHojeEnergia">0.00 kWh</div>
        </div>
    </div>

    <!-- NOVO: Gr√°ficos -->
    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <span class="material-icons">bar_chart</span>
                <h2>Gr√°ficos de Consumo</h2>
            </div>
            <div class="card-actions">
                <button class="btn btn-icon btn-secondary" onclick="exportarGrafico()" title="Exportar Gr√°fico">
                    <span class="material-icons">download</span>
                </button>
            </div>
        </div>

        <div class="chart-tabs">
            <button class="chart-tab active" onclick="trocarGrafico('line')">Evolu√ß√£o</button>
            <button class="chart-tab" onclick="trocarGrafico('bar')">Comparativo</button>
            <button class="chart-tab" onclick="trocarGrafico('pie')">Distribui√ß√£o</button>
        </div>

        <div class="chart-container">
            <canvas id="consumptionChart"></canvas>
        </div>
    </div>

    <!-- NOVO: Relat√≥rios -->
    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <span class="material-icons">summarize</span>
                <h2>Relat√≥rios Personalizados</h2>
            </div>
            <div class="card-actions">
                <button class="btn btn-primary" onclick="gerarRelatorioPDF()">
                    <span class="material-icons">picture_as_pdf</span>
                    Exportar PDF
                </button>
                <button class="btn btn-secondary" onclick="exportarCSV()">
                    <span class="material-icons">table_chart</span>
                    Exportar CSV
                </button>
            </div>
        </div>

        <div class="form-grid">
            <div class="form-group">
                <label>Per√≠odo do Relat√≥rio</label>
                <select id="relatorioPeriodo" onchange="atualizarRelatorio()">
                    <option value="7">√öltimos 7 dias</option>
                    <option value="30" selected>√öltimos 30 dias</option>
                    <option value="90">√öltimos 90 dias</option>
                    <option value="all">Todos os registros</option>
                </select>
            </div>
        </div>

        <div id="relatorioResumo" style="margin-top: 20px;">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total √Ågua no Per√≠odo</div>
                    <div class="stat-value" id="relatorioTotalAgua">0.00 m¬≥</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Energia no Per√≠odo</div>
                    <div class="stat-value" id="relatorioTotalEnergia">0.00 kWh</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">M√©dia Di√°ria √Ågua</div>
                    <div class="stat-value" id="relatorioMediaAgua">0.00 m¬≥/dia</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">M√©dia Di√°ria Energia</div>
                    <div class="stat-value" id="relatorioMediaEnergia">0.00 kWh/dia</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <span class="material-icons">water_drop</span>
                <h2>Registro de Consumo de √Ågua</h2>
            </div>
        </div>
        
        <form id="aguaForm" onsubmit="handleSubmit(event, 'agua')">
            <div class="form-grid">
                <div class="form-group">
                    <label>Nome Completo *</label>
                    <input type="text" name="nome" id="nomeAgua" required placeholder="Digite o nome completo" autocomplete="off">
                    <div class="autocomplete-items" id="autocompleteNomeAgua"></div>
                </div>
                <div class="form-group">
                    <label>Matr√≠cula Residencial *</label>
                    <input type="text" name="matricula" id="matriculaAgua" required placeholder="Digite a matr√≠cula" autocomplete="off">
                    <div class="autocomplete-items" id="autocompleteMatriculaAgua"></div>
                </div>
                <div class="form-group">
                    <label>Data e Hora *</label>
                    <input type="datetime-local" name="dataHora" id="dataHoraAgua" required>
                </div>
                <div class="form-group">
                    <label>Leitura Anterior (m¬≥)</label>
                    <input type="number" id="leituraAnteriorAgua" step="0.01" readonly>
                </div>
                <div class="form-group">
                    <label>Leitura Atual do Medidor (m¬≥) *</label>
                    <input type="number" name="leituraAtual" id="leituraAtualAgua" step="0.01" required placeholder="0.00" oninput="calcularConsumo('agua')">
                </div>
                <div class="form-group">
                    <label>Consumo Total Calculado (m¬≥)</label>
                    <input type="number" name="consumoTotal" id="consumoTotalAgua" step="0.01" readonly>
                </div>
                <div class="form-group">
                    <label>Extra 1 (Opcional)</label>
                    <input type="text" name="extra1" placeholder="Campo adicional 1">
                </div>
                <div class="form-group">
                    <label>Extra 2 (Opcional)</label>
                    <input type="text" name="extra2" placeholder="Campo adicional 2">
                </div>
                <div class="form-group">
                    <label>Extra 3 (Opcional)</label>
                    <input type="text" name="extra3" placeholder="Campo adicional 3">
                </div>
            </div>
            
            <div class="consumption-display" id="consumptionDisplayAgua" style="display: none;">
                <h3>üíß Consumo Calculado de √Ågua</h3>
                <div class="consumption-value" id="consumptionValueAgua">0.00 m¬≥</div>
            </div>
            
            <button type="submit" class="btn btn-primary btn-full" style="margin-top: 20px;">
                <span class="material-icons">send</span>
                Registrar Consumo de √Ågua
            </button>
            
            <div class="alert" id="alertAgua"></div>
        </form>
    </div>
    
    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <span class="material-icons">bolt</span>
                <h2>Registro de Consumo de Energia</h2>
            </div>
        </div>
        
        <form id="energiaForm" onsubmit="handleSubmit(event, 'energia')">
            <div class="form-grid">
                <div class="form-group">
                    <label>Nome Completo *</label>
                    <input type="text" name="nome" id="nomeEnergia" required placeholder="Digite o nome completo" autocomplete="off">
                    <div class="autocomplete-items" id="autocompleteNomeEnergia"></div>
                </div>
                <div class="form-group">
                    <label>Matr√≠cula Residencial *</label>
                    <input type="text" name="matricula" id="matriculaEnergia" required placeholder="Digite a matr√≠cula" autocomplete="off">
                    <div class="autocomplete-items" id="autocompleteMatriculaEnergia"></div>
                </div>
                <div class="form-group">
                    <label>Data e Hora *</label>
                    <input type="datetime-local" name="dataHora" id="dataHoraEnergia" required>
                </div>
                <div class="form-group">
                    <label>Leitura Anterior (kWh)</label>
                    <input type="number" id="leituraAnteriorEnergia" step="0.01" readonly>
                </div>
                <div class="form-group">
                    <label>Leitura Atual do Medidor (kWh) *</label>
                    <input type="number" name="leituraAtual" id="leituraAtualEnergia" step="0.01" required placeholder="0.00" oninput="calcularConsumo('energia')">
                </div>
                <div class="form-group">
                    <label>Consumo Total Calculado (kWh)</label>
                    <input type="number" name="consumoTotal" id="consumoTotalEnergia" step="0.01" readonly>
                </div>
                <div class="form-group">
                    <label>Extra 1 (Opcional)</label>
                    <input type="text" name="extra1" placeholder="Campo adicional 1">
                </div>
                <div class="form-group">
                    <label>Extra 2 (Opcional)</label>
                    <input type="text" name="extra2" placeholder="Campo adicional 2">
                </div>
                <div class="form-group">
                    <label>Extra 3 (Opcional)</label>
                    <input type="text" name="extra3" placeholder="Campo adicional 3">
                </div>
            </div>
            
            <div class="consumption-display" id="consumptionDisplayEnergia" style="display: none;">
                <h3>‚ö° Consumo Calculado de Energia</h3>
                <div class="consumption-value" id="consumptionValueEnergia">0.00 kWh</div>
            </div>
            
            <button type="submit" class="btn btn-primary btn-full" style="margin-top: 20px; background: var(--accent);">
                <span class="material-icons">send</span>
                Registrar Consumo de Energia
            </button>
            
            <div class="alert" id="alertEnergia"></div>
        </form>
    </div>

    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <span class="material-icons">calendar_today</span>
                <h2>Visualiza√ß√£o do Consumo Di√°rio</h2>
            </div>
        </div>

        <div class="filter-container">
            <h3 style="margin-bottom: 15px; font-size: 16px; color: var(--text-color);">
                <span class="material-icons" style="vertical-align: middle; font-size: 20px;">date_range</span>
                Selecione o Per√≠odo
            </h3>
            <div class="filter-grid">
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Data In√≠cio *</label>
                    <input type="date" id="dailyDataInicio" required>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Data Fim *</label>
                    <input type="date" id="dailyDataFim" required>
                </div>
            </div>
            <div class="filter-buttons">
                <button class="btn btn-primary" onclick="calcularConsumoDiario()">
                    <span class="material-icons">visibility</span>
                    Ver Consumo Di√°rio
                </button>
            </div>
        </div>

        <div class="table-container daily-consumption-table">
            <table>
                <thead>
                    <tr>
                        <th>Dia</th>
                        <th style="text-align: right;">üíß Consumo √Ågua</th>
                        <th style="text-align: right;">‚ö° Consumo Energia</th>
                    </tr>
                </thead>
                <tbody id="consumoDiarioBody">
                    <tr>
                        <td colspan="3" style="text-align: center; padding: 40px; color: #999;">
                            Selecione um per√≠odo e clique em "Ver Consumo Di√°rio".
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="card" id="pendingRecordsCard" style="display: none;">
        <div class="card-header" style="border-bottom-color: var(--warning);">
            <div class="card-title">
                <span class="material-icons" style="color: var(--warning);">warning</span>
                <h2>Registros Pendentes (Offline) <span id="pendingCountBadge" class="badge badge-offline">0</span></h2>
            </div>
        </div>

        <div class="filter-container">
            <h3 style="margin-bottom: 15px; font-size: 16px; color: var(--text-color);">
                <span class="material-icons" style="vertical-align: middle; font-size: 20px;">filter_list</span>
                Filtros de Pesquisa
            </h3>
            <div class="filter-grid">
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Tipo de Registro</label>
                    <select id="filtroTipoOffline">
                        <option value="all">Todos os Tipos</option>
                        <option value="agua">Apenas √Ågua</option>
                        <option value="energia">Apenas Energia</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Per√≠odo</label>
                    <select id="filtroPeriodoOffline" onchange="toggleCustomDateOffline()">
                        <option value="all">Todos os Registros</option>
                        <option value="today">Dia Atual</option>
                        <option value="custom">Per√≠odo Personalizado</option>
                    </select>
                </div>
                <div class="form-group" id="dataInicioGroupOffline" style="margin-bottom: 0; display: none;">
                    <label>Data In√≠cio</label>
                    <input type="date" id="dataInicioOffline">
                </div>
                <div class="form-group" id="dataFimGroupOffline" style="margin-bottom: 0; display: none;">
                    <label>Data Fim</label>
                    <input type="date" id="dataFimOffline">
                </div>
            </div>
            <div class="filter-buttons">
                <button class="btn btn-secondary" onclick="aplicarFiltrosOffline()">
                    <span class="material-icons">search</span>
                    Aplicar Filtros
                </button>
                <button class="btn btn-primary" onclick="limparFiltrosOffline()">
                    <span class="material-icons">clear</span>
                    Limpar Filtros
                </button>
            </div>
        </div>

        <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
            <button class="btn btn-warning" onclick="sincronizarRegistrosPendentes()">
                <span class="material-icons">cloud_upload</span>
                Sincronizar Registros Pendentes
            </button>
            <button class="btn btn-danger" onclick="limparTodosRegistrosOffline()">
                <span class="material-icons">delete_forever</span>
                Limpar Todos os Registros Offline
            </button>
        </div>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Tipo</th>
                        <th>Data/Hora</th>
                        <th>Nome</th>
                        <th>Matr√≠cula</th>
                        <th style="text-align: right;">Leitura Atual</th>
                        <th style="text-align: right;">Consumo</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="registrosPendentesBody">
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                            Nenhum registro offline pendente.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="alert" id="syncAlert"></div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <span class="material-icons">history</span>
                <h2>Hist√≥rico de Registros (Online)</h2>
            </div>
            <div class="card-actions">
                <button class="btn btn-icon btn-secondary" onclick="window.print()" title="Imprimir">
                    <span class="material-icons">print</span>
                </button>
            </div>
        </div>

        <div class="search-box">
            <span class="material-icons">search</span>
            <input type="text" id="searchInput" placeholder="Buscar por nome ou matr√≠cula..." oninput="buscarRegistros()">
        </div>
        
        <div class="filter-container">
            <h3 style="margin-bottom: 15px; font-size: 16px; color: var(--text-color);">
                <span class="material-icons" style="vertical-align: middle; font-size: 20px;">filter_list</span>
                Filtros de Pesquisa
            </h3>
            <div class="filter-grid">
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Tipo de Registro</label>
                    <select id="filtroTipo">
                        <option value="all">Todos os Tipos</option>
                        <option value="agua">Apenas √Ågua</option>
                        <option value="energia">Apenas Energia</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Per√≠odo</label>
                    <select id="filtroPeriodo" onchange="toggleCustomDate()">
                        <option value="all">Todos os Registros</option>
                        <option value="today">Dia Atual</option>
                        <option value="custom">Per√≠odo Personalizado</option>
                    </select>
                </div>
                <div class="form-group" id="dataInicioGroup" style="margin-bottom: 0; display: none;">
                    <label>Data In√≠cio</label>
                    <input type="date" id="dataInicio">
                </div>
                <div class="form-group" id="dataFimGroup" style="margin-bottom: 0; display: none;">
                    <label>Data Fim</label>
                    <input type="date" id="dataFim">
                </div>
            </div>
            <div class="filter-buttons">
                <button class="btn btn-secondary" onclick="aplicarFiltros()">
                    <span class="material-icons">search</span>
                    Aplicar Filtros
                </button>
                <button class="btn btn-primary" onclick="limparFiltros()">
                    <span class="material-icons">clear</span>
                    Limpar Filtros
                </button>
            </div>
        </div>
        
        <div class="table-container">
            <table id="historicoTable">
                <thead>
                    <tr>
                        <th onclick="ordenarTabela(0)">Tipo <span class="sort-icon material-icons">unfold_more</span></th>
                        <th onclick="ordenarTabela(1)">Data/Hora <span class="sort-icon material-icons">unfold_more</span></th>
                        <th onclick="ordenarTabela(2)">Nome <span class="sort-icon material-icons">unfold_more</span></th>
                        <th onclick="ordenarTabela(3)">Matr√≠cula <span class="sort-icon material-icons">unfold_more</span></th>
                        <th onclick="ordenarTabela(4)" style="text-align: right;">Leitura Anterior <span class="sort-icon material-icons">unfold_more</span></th>
                        <th onclick="ordenarTabela(5)" style="text-align: right;">Leitura Atual <span class="sort-icon material-icons">unfold_more</span></th>
                        <th onclick="ordenarTabela(6)" style="text-align: right;">Consumo <span class="sort-icon material-icons">unfold_more</span></th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="historicoBody">
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #999;">
                            Nenhum registro encontrado. Fa√ßa o primeiro registro!
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Editar Online -->
<div id="editOnlineModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="fecharModalEditOnline()">&times;</span>
        <h2>Editar Registro Online</h2>
        <form id="editOnlineForm" onsubmit="salvarEdicaoOnline(event)">
            <input type="hidden" id="editOnlineRowId">
            <input type="hidden" id="editOnlineTipo">
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Nome Completo *</label>
                    <input type="text" id="editOnlineNome" required>
                </div>
                <div class="form-group">
                    <label>Matr√≠cula Residencial *</label>
                    <input type="text" id="editOnlineMatricula" required>
                </div>
                <div class="form-group">
                    <label>Data e Hora *</label>
                    <input type="datetime-local" id="editOnlineDataHora" required>
                </div>
                <div class="form-group">
                    <label id="labelEditOnlineLeituraAnterior">Leitura Anterior (m¬≥)</label>
                    <input type="number" id="editOnlineLeituraAnterior" step="0.01" readonly>
                </div>
                <div class="form-group">
                    <label id="labelEditOnlineLeituraAtual">Leitura Atual do Medidor (m¬≥) *</label>
                    <input type="number" id="editOnlineLeituraAtual" step="0.01" required oninput="calcularConsumoModalOnline()">
                </div>
                <div class="form-group">
                    <label id="labelEditOnlineConsumoTotal">Consumo Total Calculado (m¬≥)</label>
                    <input type="number" id="editOnlineConsumoTotal" step="0.01" readonly>
                </div>
                <div class="form-group">
                    <label>Extra 1 (Opcional)</label>
                    <input type="text" id="editOnlineExtra1">
                </div>
                <div class="form-group">
                    <label>Extra 2 (Opcional)</label>
                    <input type="text" id="editOnlineExtra2">
                </div>
                <div class="form-group">
                    <label>Extra 3 (Opcional)</label>
                    <input type="text" id="editOnlineExtra3">
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary btn-full" style="margin-top: 20px;">
                <span class="material-icons">save</span>
                Salvar Altera√ß√µes
            </button>
            <div class="alert" id="alertEditOnlineModal"></div>
        </form>
    </div>
</div>

<!-- Modal Editar Offline -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="fecharModal()">&times;</span>
        <h2>Editar Registro Offline</h2>
        <form id="editForm" onsubmit="salvarEdicao(event)">
            <input type="hidden" id="editIndex">
            <input type="hidden" id="editTipo">
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Nome Completo *</label>
                    <input type="text" id="editNome" required>
                </div>
                <div class="form-group">
                    <label>Matr√≠cula Residencial *</label>
                    <input type="text" id="editMatricula" required>
                </div>
                <div class="form-group">
                    <label>Data e Hora *</label>
                    <input type="datetime-local" id="editDataHora" required>
                </div>
                <div class="form-group">
                    <label id="labelLeituraAnterior">Leitura Anterior (m¬≥)</label>
                    <input type="number" id="editLeituraAnterior" step="0.01" readonly>
                </div>
                <div class="form-group">
                    <label id="labelLeituraAtual">Leitura Atual do Medidor (m¬≥) *</label>
                    <input type="number" id="editLeituraAtual" step="0.01" required oninput="calcularConsumoModal()">
                </div>
                <div class="form-group">
                    <label id="labelConsumoTotal">Consumo Total Calculado (m¬≥)</label>
                    <input type="number" id="editConsumoTotal" step="0.01" readonly>
                </div>
                <div class="form-group">
                    <label>Extra 1 (Opcional)</label>
                    <input type="text" id="editExtra1">
                </div>
                <div class="form-group">
                    <label>Extra 2 (Opcional)</label>
                    <input type="text" id="editExtra2">
                </div>
                <div class="form-group">
                    <label>Extra 3 (Opcional)</label>
                    <input type="text" id="editExtra3">
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary btn-full" style="margin-top: 20px;">
                <span class="material-icons">save</span>
                Salvar Edi√ß√£o
            </button>
            <div class="alert" id="alertEditModal"></div>
        </form>
    </div>
</div>

<script>
let scriptURL = '';
let sheetID = '';
let leituraAnteriorAgua = 0;
let leituraAnteriorEnergia = 0;
let isProcessing = false;
let todosRegistrosOnline = [];
let todosRegistrosOffline = [];
let currentChart = null;
let currentChartType = 'line';
let sortDirection = {};
let nomesUnicos = new Set();
let matriculasUnicas = new Set();

window.onload = function() {
    carregarConfiguracao();
    setDataHoraAtual();
    setInterval(atualizarRelogio, 1000);
    carregarTema();
    inicializarAutocomplete();
    
    const nomeInputs = document.querySelectorAll('input[name="nome"]');
    const matriculaInputs = document.querySelectorAll('input[name="matricula"]');
    
    const ultimoNome = localStorage.getItem('ultimoNome') || '';
    const ultimaMatricula = localStorage.getItem('ultimaMatricula') || '';
    
    nomeInputs.forEach(input => {
        if (!input.id.includes('Online') && !input.id.includes('edit')) {
            input.value = ultimoNome;
        }
    });
    matriculaInputs.forEach(input => {
        if (!input.id.includes('Online') && !input.id.includes('edit')) {
            input.value = ultimaMatricula;
        }
    });
    
    const now = new Date();
    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
    const today = now.toISOString().split('T')[0];
    document.getElementById('dailyDataInicio').value = firstDay;
    document.getElementById('dailyDataFim').value = today;

    if (scriptURL && sheetID) {
        carregarDados();
    }

    carregarRegistrosPendentes();
    setupKeyboardShortcuts();
};

// TEMA ESCURO/CLARO
function toggleTheme() {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    
    document.documentElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    
    const icon = document.getElementById('themeIcon');
    const text = document.getElementById('themeText');
    
    if (newTheme === 'dark') {
        icon.textContent = 'light_mode';
        text.textContent = 'Claro';
    } else {
        icon.textContent = 'dark_mode';
        text.textContent = 'Escuro';
    }
    
    if (currentChart) {
        atualizarGrafico();
    }
}

function carregarTema() {
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    
    const icon = document.getElementById('themeIcon');
    const text = document.getElementById('themeText');
    
    if (savedTheme === 'dark') {
        icon.textContent = 'light_mode';
        text.textContent = 'Claro';
    } else {
        icon.textContent = 'dark_mode';
        text.textContent = 'Escuro';
    }
}

// ATALHOS DE TECLADO
function setupKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
        // Ctrl+S: Salvar configura√ß√£o
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            salvarConfiguracao();
        }
        
        // Esc: Fechar modals
        if (e.key === 'Escape') {
            fecharModal();
            fecharModalEditOnline();
        }
        
        // ?: Mostrar atalhos
        if (e.key === '?') {
            const shortcuts = document.getElementById('keyboardShortcuts');
            shortcuts.classList.toggle('show');
        }
    });
}

// AUTOCOMPLETE
function inicializarAutocomplete() {
    const inputsNome = ['nomeAgua', 'nomeEnergia'];
    const inputsMatricula = ['matriculaAgua', 'matriculaEnergia'];
    
    inputsNome.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('input', function() {
                const tipo = id.includes('Agua') ? 'Agua' : 'Energia';
                mostrarAutocomplete(this.value, 'nome', 'autocompleteNome' + tipo, id);
            });
        }
    });
    
    inputsMatricula.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('input', function() {
                const tipo = id.includes('Agua') ? 'Agua' : 'Energia';
                mostrarAutocomplete(this.value, 'matricula', 'autocompleteMatricula' + tipo, id);
            });
        }
    });
}

function mostrarAutocomplete(valor, tipo, autocompleteId, inputId) {
    const autocompleteDiv = document.getElementById(autocompleteId);
    if (!autocompleteDiv) return;
    
    autocompleteDiv.innerHTML = '';
    
    if (!valor) {
        return;
    }
    
    const dados = tipo === 'nome' ? Array.from(nomesUnicos) : Array.from(matriculasUnicas);
    const filtrados = dados.filter(item => 
        item.toLowerCase().includes(valor.toLowerCase())
    ).slice(0, 5);
    
    filtrados.forEach(item => {
        const div = document.createElement('div');
        div.textContent = item;
        div.onclick = function() {
            document.getElementById(inputId).value = item;
            autocompleteDiv.innerHTML = '';
        };
        autocompleteDiv.appendChild(div);
    });
}

function atualizarAutocomplete() {
    todosRegistrosOnline.forEach(reg => {
        if (reg.nome) nomesUnicos.add(reg.nome);
        if (reg.matricula) matriculasUnicas.add(reg.matricula);
    });
}

function setDataHoraAtual() {
    const now = new Date();
    const localDate = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
    document.getElementById('dataHoraAgua').value = localDate;
    document.getElementById('dataHoraEnergia').value = localDate;
}

function atualizarRelogio() {
    const now = new Date();
    document.getElementById('lastUpdate').textContent = now.toLocaleTimeString('pt-BR');
}

function carregarConfiguracao() {
    scriptURL = localStorage.getItem('scriptURL') || '';
    sheetID = localStorage.getItem('sheetID') || '';
    
    document.getElementById('scriptURL').value = scriptURL;
    document.getElementById('sheetID').value = sheetID;
    
    if (scriptURL && sheetID) {
        document.getElementById('connectionStatus').textContent = 'Conectado';
        document.getElementById('connectionStatus').style.color = 'var(--success)';
    } else {
        document.getElementById('connectionStatus').textContent = 'N√£o Configurado';
        document.getElementById('connectionStatus').style.color = 'var(--error)';
    }
}

function salvarConfiguracao() {
    const urlInput = document.getElementById('scriptURL').value.trim();
    const idInput = document.getElementById('sheetID').value.trim();
    
    if (!urlInput || !idInput) {
        mostrarAlerta('configAlert', 'Por favor, preencha todos os campos de configura√ß√£o!', 'error');
        return;
    }
    
    if (!urlInput.includes('/exec')) {
        mostrarAlerta('configAlert', 'A URL do Apps Script deve terminar com /exec', 'error');
        return;
    }
    
    localStorage.setItem('scriptURL', urlInput);
    localStorage.setItem('sheetID', idInput);
    
    scriptURL = urlInput;
    sheetID = idInput;
    
    document.getElementById('connectionStatus').textContent = 'Conectado';
    document.getElementById('connectionStatus').style.color = 'var(--success)';
    
    mostrarAlerta('configAlert', 'Configura√ß√£o salva com sucesso!', 'success');

    if (scriptURL && sheetID) {
        carregarDados();
    }
}

async function testarConexao() {
    if (!scriptURL || !sheetID) {
        mostrarAlerta('configAlert', 'Configure primeiro o sistema!', 'error');
        return;
    }
    
    try {
        document.getElementById('connectionStatus').textContent = 'Testando...';
        
        const response = await fetch(`${scriptURL}?action=test&sheetId=${sheetID}`);
        const data = await response.json();
        
        if (data.status === 'success') {
            mostrarAlerta('configAlert', 'Conex√£o estabelecida com sucesso!', 'success');
            document.getElementById('connectionStatus').textContent = 'Conectado';
            document.getElementById('connectionStatus').style.color = 'var(--success)';
            carregarDados();
        } else {
            throw new Error(data.message || 'Erro na conex√£o');
        }
    } catch (error) {
        mostrarAlerta('configAlert', 'Erro ao conectar: ' + error.message, 'error');
        document.getElementById('connectionStatus').textContent = 'Erro';
        document.getElementById('connectionStatus').style.color = 'var(--error)';
    }
}

async function carregarDados() {
    await carregarHistorico();
    calcularEstatisticasGerais();
    atualizarAutocomplete();
    atualizarGrafico();
    atualizarRelatorio();
}

function calcularEstatisticasGerais() {
    let totalAguaLeitura = 0;
    let totalEnergiaLeitura = 0;
    let totalConsumoAgua = 0;
    let totalConsumoEnergia = 0;
    let primeiraData = null;

    if (todosRegistrosOnline.length === 0) {
        leituraAnteriorAgua = 0;
        leituraAnteriorEnergia = 0;
        document.getElementById('leituraAnteriorAgua').value = '0.00';
        document.getElementById('leituraAnteriorEnergia').value = '0.00';
        document.getElementById('leituraAtualAgua').value = '0.00';
        document.getElementById('leituraAtualEnergia').value = '0.00';
        document.getElementById('totalAgua').textContent = '0.00 m¬≥';
        document.getElementById('totalEnergia').textContent = '0.00 kWh';
        document.getElementById('consumoHojeAgua').textContent = '0.00 m¬≥';
        document.getElementById('consumoHojeEnergia').textContent = '0.00 kWh';
        return;
    }

    const registrosAgua = todosRegistrosOnline.filter(r => r.tipo === 'agua').sort((a, b) => new Date(a.dataHora) - new Date(b.dataHora));
    const registrosEnergia = todosRegistrosOnline.filter(r => r.tipo === 'energia').sort((a, b) => new Date(a.dataHora) - new Date(b.dataHora));

    if (registrosAgua.length > 0) {
        const ultimoAgua = registrosAgua[registrosAgua.length - 1];
        totalAguaLeitura = parseFloat(ultimoAgua.leituraAtual || 0);
        const primeiroAgua = registrosAgua[0];
        totalConsumoAgua = totalAguaLeitura - parseFloat(primeiroAgua.leituraAnterior || 0);
        primeiraData = new Date(primeiroAgua.dataHora);
    }
    
    if (registrosEnergia.length > 0) {
        const ultimoEnergia = registrosEnergia[registrosEnergia.length - 1];
        totalEnergiaLeitura = parseFloat(ultimoEnergia.leituraAtual || 0);
        const primeiroEnergia = registrosEnergia[0];
        totalConsumoEnergia = totalEnergiaLeitura - parseFloat(primeiroEnergia.leituraAnterior || 0);
        if (!primeiraData) primeiraData = new Date(primeiroEnergia.dataHora);
    }

    leituraAnteriorAgua = totalAguaLeitura;
    leituraAnteriorEnergia = totalEnergiaLeitura;

    document.getElementById('leituraAnteriorAgua').value = leituraAnteriorAgua.toFixed(2);
    document.getElementById('leituraAnteriorEnergia').value = leituraAnteriorEnergia.toFixed(2);
    document.getElementById('leituraAtualAgua').value = leituraAnteriorAgua.toFixed(2);
    document.getElementById('leituraAtualEnergia').value = leituraAnteriorEnergia.toFixed(2);

    document.getElementById('totalAgua').textContent = totalAguaLeitura.toFixed(2) + ' m¬≥';
    document.getElementById('totalEnergia').textContent = totalEnergiaLeitura.toFixed(2) + ' kWh';

    const consumoHoje = calcularConsumoDiarioPorData(new Date().toISOString().split('T')[0]);
    document.getElementById('consumoHojeAgua').textContent = (consumoHoje.agua || 0).toFixed(2) + ' m¬≥';
    document.getElementById('consumoHojeEnergia').textContent = (consumoHoje.energia || 0).toFixed(2) + ' kWh';

    // Calcular tend√™ncia
    calcularTendencia();
    
    calcularConsumo('agua');
    calcularConsumo('energia');
}

function calcularTendencia() {
    const hoje = new Date().toISOString().split('T')[0];
    const ontem = new Date(Date.now() - 86400000).toISOString().split('T')[0];
    
    const consumoHoje = calcularConsumoDiarioPorData(hoje);
    const consumoOntem = calcularConsumoDiarioPorData(ontem);
    
    atualizarTrendIndicator('trendAgua', consumoHoje.agua, consumoOntem.agua, 'm¬≥');
    atualizarTrendIndicator('trendEnergia', consumoHoje.energia, consumoOntem.energia, 'kWh');
}

function atualizarTrendIndicator(elementId, hoje, ontem, unidade) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    if (ontem === 0 || !ontem) {
        element.className = 'trend-indicator trend-neutral';
        element.innerHTML = '<span class="material-icons" style="font-size: 16px;">remove</span> Sem dados';
        return;
    }
    
    const diferenca = hoje - ontem;
    const percentual = ((diferenca / ontem) * 100).toFixed(1);
    
    if (diferenca > 0) {
        element.className = 'trend-indicator trend-up';
        element.innerHTML = `<span class="material-icons" style="font-size: 16px;">trending_up</span> +${percentual}%`;
    } else if (diferenca < 0) {
        element.className = 'trend-indicator trend-down';
        element.innerHTML = `<span class="material-icons" style="font-size: 16px;">trending_down</span> ${percentual}%`;
    } else {
        element.className = 'trend-indicator trend-neutral';
        element.innerHTML = '<span class="material-icons" style="font-size: 16px;">remove</span> Est√°vel';
    }
}

function toYYYYMMDD(date) {
    const d = new Date(date);
    d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
    return d.toISOString().split('T')[0];
}

function calcularConsumoDiarioPorData(dataString) {
    const registrosDoDia = todosRegistrosOnline
        .filter(r => toYYYYMMDD(r.dataHora) === dataString)
        .sort((a, b) => new Date(a.dataHora) - new Date(b.dataHora));

    let consumoAgua = 0;
    let consumoEnergia = 0;

    const regAgua = registrosDoDia.filter(r => r.tipo === 'agua');
    const regEnergia = registrosDoDia.filter(r => r.tipo === 'energia');

    if (regAgua.length > 0) {
        const primeiraLeitura = parseFloat(regAgua[0].leituraAnterior || 0);
        const ultimaLeitura = parseFloat(regAgua[regAgua.length - 1].leituraAtual || 0);
        consumoAgua = Math.max(0, ultimaLeitura - primeiraLeitura);
    }
    if (regEnergia.length > 0) {
        const primeiraLeitura = parseFloat(regEnergia[0].leituraAnterior || 0);
        const ultimaLeitura = parseFloat(regEnergia[regEnergia.length - 1].leituraAtual || 0);
        consumoEnergia = Math.max(0, ultimaLeitura - primeiraLeitura);
    }

    return { agua: consumoAgua, energia: consumoEnergia };
}

function calcularConsumoDiario() {
    const dataInicioStr = document.getElementById('dailyDataInicio').value;
    const dataFimStr = document.getElementById('dailyDataFim').value;
    const tbody = document.getElementById('consumoDiarioBody');

    if (!dataInicioStr || !dataFimStr) {
        tbody.innerHTML = `<tr><td colspan="3" style="text-align: center; padding: 20px; color: var(--error);">Selecione as duas datas!</td></tr>`;
        return;
    }

    const dataInicio = new Date(dataInicioStr);
    const dataFim = new Date(dataFimStr);

    if (dataInicio > dataFim) {
        tbody.innerHTML = `<tr><td colspan="3" style="text-align: center; padding: 20px; color: var(--error);">A Data In√≠cio n√£o pode ser maior que a Data Fim!</td></tr>`;
        return;
    }
    
    tbody.innerHTML = '';
    let registroEncontrado = false;

    for (let d = new Date(dataInicio); d <= dataFim; d.setDate(d.getDate() + 1)) {
        const dataAtualStr = toYYYYMMDD(d);
        const consumo = calcularConsumoDiarioPorData(dataAtualStr);

        if (consumo.agua > 0 || consumo.energia > 0) {
            registroEncontrado = true;
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${new Date(dataAtualStr).toLocaleDateString('pt-BR')}</td>
                <td style="text-align: right;">${consumo.agua.toFixed(2)} m¬≥</td>
                <td style="text-align: right;">${consumo.energia.toFixed(2)} kWh</td>
            `;
        }
    }

    if (!registroEncontrado) {
        tbody.innerHTML = `<tr><td colspan="3" style="text-align: center; padding: 40px; color: #999;">
            Nenhum consumo registrado no per√≠odo selecionado.
        </td></tr>`;
    }
}

async function carregarHistorico() {
    if (!scriptURL || !sheetID) {
        console.warn('Configura√ß√£o ausente.');
        document.getElementById('totalRecords').textContent = '0';
        calcularEstatisticasGerais();
        return;
    }
    
    try {
        const response = await fetch(`${scriptURL}?action=getHistory&sheetId=${sheetID}&tipo=all`);
        const data = await response.json();
        
        if (data.status === 'success' && data.registros && data.registros.length > 0) {
            todosRegistrosOnline = data.registros;
            aplicarFiltros();
        } else {
            todosRegistrosOnline = [];
            renderizarHistorico([]);
        }
    } catch (error) {
        console.error('Erro ao carregar hist√≥rico:', error);
        document.getElementById('historicoBody').innerHTML = `
            <tr>
                <td colspan="8" style="text-align: center; padding: 40px; color: var(--error);">
                    ‚ùå Erro ao carregar hist√≥rico. Verifique a conex√£o e configura√ß√£o.
                </td>
            </tr>
        `;
    }
}

function renderizarHistorico(registros) {
    const tbody = document.getElementById('historicoBody');
    
    if (registros.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" style="text-align: center; padding: 40px; color: #999;">
                    Nenhum registro encontrado com os filtros aplicados.
                </td>
            </tr>
        `;
        document.getElementById('totalRecords').textContent = '0';
        return;
    }
    
    tbody.innerHTML = '';
    registros.forEach((reg, index) => {
        const row = tbody.insertRow();
        const tipo = String(reg.tipo || '').toLowerCase();
        const unit = tipo === 'agua' ? 'm¬≥' : 'kWh';
        
        let dataFormatada = 'Data Inv√°lida';
        if (reg.dataHora) {
            try {
                const d = new Date(reg.dataHora);
                if (!isNaN(d.getTime())) {
                    dataFormatada = d.toLocaleDateString('pt-BR') + ' ' + d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                }
            } catch (e) {
                console.error('Erro ao formatar data:', e);
            }
        }
        
        row.innerHTML = `
            <td><span class="badge badge-${tipo}">${tipo === 'agua' ? 'üíß √Ågua' : '‚ö° Energia'}</span></td>
            <td>${dataFormatada}</td>
            <td>${String(reg.nome || 'N/A')}</td>
            <td>${String(reg.matricula || 'N/A')}</td>
            <td style="text-align: right;">${parseFloat(reg.leituraAnterior || 0).toFixed(2)} ${unit}</td>
            <td style="text-align: right; font-weight: 600;">${parseFloat(reg.leituraAtual || 0).toFixed(2)} ${unit}</td>
            <td style="text-align: right; color: var(--success); font-weight: 600;">+${parseFloat(reg.consumoTotal || 0).toFixed(2)} ${unit}</td>
            <td>
                <button class="btn btn-edit" onclick="abrirModalEditOnline(${index})" title="Editar">
                    <span class="material-icons" style="font-size: 14px;">edit</span>
                </button>
                <button class="btn btn-danger" onclick="excluirRegistroOnline(${index})" title="Excluir">
                    <span class="material-icons" style="font-size: 14px;">delete</span>
                </button>
            </td>
        `;
    });
    
    document.getElementById('totalRecords').textContent = registros.length;
}

// BUSCA EM TEMPO REAL
function buscarRegistros() {
    const termo = document.getElementById('searchInput').value.toLowerCase();
    
    let registrosFiltrados = [...todosRegistrosOnline];
    
    if (termo) {
        registrosFiltrados = registrosFiltrados.filter(r => 
            (r.nome && r.nome.toLowerCase().includes(termo)) ||
            (r.matricula && r.matricula.toLowerCase().includes(termo))
        );
    }
    
    aplicarFiltrosAdicionais(registrosFiltrados);
}

function aplicarFiltrosAdicionais(registros) {
    const tipoFiltro = document.getElementById('filtroTipo').value;
    const periodoFiltro = document.getElementById('filtroPeriodo').value;
    
    let registrosFiltrados = [...registros];
    
    if (tipoFiltro !== 'all') {
        registrosFiltrados = registrosFiltrados.filter(r => String(r.tipo).toLowerCase() === tipoFiltro);
    }
    
    if (periodoFiltro === 'today') {
        const hoje = new Date().toISOString().split('T')[0];
        registrosFiltrados = registrosFiltrados.filter(r => {
            if (!r.dataHora) return false;
            const dataReg = new Date(r.dataHora).toISOString().split('T')[0];
            return dataReg === hoje;
        });
    } else if (periodoFiltro === 'custom') {
        const dataInicio = document.getElementById('dataInicio').value;
        const dataFim = document.getElementById('dataFim').value;
        
        if (dataInicio && dataFim) {
            registrosFiltrados = registrosFiltrados.filter(r => {
                if (!r.dataHora) return false;
                const dataReg = new Date(r.dataHora).toISOString().split('T')[0];
                return dataReg >= dataInicio && dataReg <= dataFim;
            });
        }
    }
    
    renderizarHistorico(registrosFiltrados);
}

// ORDENA√á√ÉO DE TABELA
function ordenarTabela(coluna) {
    const direcao = sortDirection[coluna] === 'asc' ? 'desc' : 'asc';
    sortDirection = {};
    sortDirection[coluna] = direcao;
    
    const tbody = document.getElementById('historicoBody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    rows.sort((a, b) => {
        const aValue = a.cells[coluna].textContent.trim();
        const bValue = b.cells[coluna].textContent.trim();
        
        if (direcao === 'asc') {
            return aValue.localeCompare(bValue, 'pt-BR', { numeric: true });
        } else {
            return bValue.localeCompare(aValue, 'pt-BR', { numeric: true });
        }
    });
    
    rows.forEach(row => tbody.appendChild(row));
    
    // Atualizar √≠cones
    document.querySelectorAll('.sort-icon').forEach(icon => {
        icon.textContent = 'unfold_more';
        icon.parentElement.classList.remove('sorted');
    });
    
    const header = document.querySelectorAll('th')[coluna];
    const icon = header.querySelector('.sort-icon');
    icon.textContent = direcao === 'asc' ? 'arrow_upward' : 'arrow_downward';
    header.classList.add('sorted');
}

function toggleCustomDate() {
    const periodo = document.getElementById('filtroPeriodo').value;
    const showCustom = periodo === 'custom';
    
    document.getElementById('dataInicioGroup').style.display = showCustom ? 'block' : 'none';
    document.getElementById('dataFimGroup').style.display = showCustom ? 'block' : 'none';
}

function aplicarFiltros() {
    buscarRegistros();
}

function limparFiltros() {
    document.getElementById('filtroTipo').value = 'all';
    document.getElementById('filtroPeriodo').value = 'all';
    document.getElementById('dataInicio').value = '';
    document.getElementById('dataFim').value = '';
    document.getElementById('searchInput').value = '';
    toggleCustomDate();
    aplicarFiltros();
}

function calcularConsumo(tipo) {
    const leituraAtualInput = document.getElementById(`leituraAtual${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
    const consumoTotalInput = document.getElementById(`consumoTotal${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
    
    const leituraAtual = parseFloat(leituraAtualInput.value) || 0;
    const leituraAnterior = tipo === 'agua' ? leituraAnteriorAgua : leituraAnteriorEnergia;
    
    const consumo = Math.max(0, leituraAtual - leituraAnterior);
    consumoTotalInput.value = consumo.toFixed(2);
    
    const display = document.getElementById(`consumptionDisplay${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
    const valueDisplay = document.getElementById(`consumptionValue${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
    
    if (consumo > 0) {
        display.style.display = 'block';
        valueDisplay.textContent = consumo.toFixed(2) + (tipo === 'agua' ? ' m¬≥' : ' kWh');
    } else {
        display.style.display = 'none';
    }
}

async function handleSubmit(event, tipo) {
    event.preventDefault();
    
    if (isProcessing) {
        mostrarAlerta(`alert${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`, 'Aguarde o envio anterior ser conclu√≠do!', 'error');
        return;
    }
    
    isProcessing = true;
    const form = event.target;
    const btn = form.querySelector('button[type="submit"]');
    const originalHTML = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '<div class="loading"></div> Enviando...';

    const formData = new FormData(form);
    const dataToSend = {
        tipo: tipo,
        nome: formData.get('nome'),
        matricula: formData.get('matricula'),
        dataHora: formData.get('dataHora'),
        leituraAnterior: tipo === 'agua' ? leituraAnteriorAgua.toFixed(2) : leituraAnteriorEnergia.toFixed(2),
        leituraAtual: parseFloat(formData.get('leituraAtual') || 0).toFixed(2),
        consumoTotal: parseFloat(formData.get('consumoTotal') || 0).toFixed(2),
        extra1: formData.get('extra1') || '',
        extra2: formData.get('extra2') || '',
        extra3: formData.get('extra3') || '',
        timestamp: new Date().toISOString()
    };

    localStorage.setItem('ultimoNome', dataToSend.nome);
    localStorage.setItem('ultimaMatricula', dataToSend.matricula);

    let success = false;

    if (scriptURL && sheetID) {
        try {
            const onlineFormData = new FormData();
            onlineFormData.append('action', 'addRecord');
            onlineFormData.append('tipo', tipo);
            onlineFormData.append('sheetId', sheetID);

            for (const key in dataToSend) {
                if (key !== 'tipo' && key !== 'timestamp') {
                    onlineFormData.append(key, dataToSend[key]);
                }
            }
            
            const response = await fetch(scriptURL, {
                method: 'POST',
                body: onlineFormData
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                mostrarAlerta(`alert${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`, '‚úÖ Registro salvo ONLINE com sucesso!', 'success');
                success = true;
                
                // Tocar som de sucesso
                playSuccessSound();
            } else {
                throw new Error(result.message || 'Erro ao salvar online, salvando offline...');
            }
        } catch (error) {
            console.error('Falha no envio online. Salvando offline.', error);
            salvarRegistroOffline(dataToSend);
            mostrarAlerta(`alert${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`, `‚ö†Ô∏è Falha no envio ONLINE. Registro salvo OFFLINE. ${error.message}`, 'warning');
        }
    } else {
        salvarRegistroOffline(dataToSend);
        mostrarAlerta(`alert${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`, '‚ö†Ô∏è Sistema n√£o configurado. Registro salvo OFFLINE.', 'warning');
    }
    
    if (success) {
        await carregarDados();
    }
    carregarRegistrosPendentes();
    
    const nome = dataToSend.nome;
    const matricula = dataToSend.matricula;
    form.reset();
    form.querySelector('input[name="nome"]').value = nome;
    form.querySelector('input[name="matricula"]').value = matricula;
    setDataHoraAtual();
    
    document.getElementById(`consumptionDisplay${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`).style.display = 'none';

    isProcessing = false;
    btn.disabled = false;
    btn.innerHTML = originalHTML;
}

function playSuccessSound() {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.value = 800;
    oscillator.type = 'sine';
    
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.2);
}

function getRegistrosOffline() {
    const json = localStorage.getItem('registrosOffline');
    return json ? JSON.parse(json) : [];
}

function setRegistrosOffline(registros) {
    localStorage.setItem('registrosOffline', JSON.stringify(registros));
    document.getElementById('pendingRecordsCount').textContent = registros.length;
    carregarRegistrosPendentes();
}

function salvarRegistroOffline(registro) {
    const registros = getRegistrosOffline();
    registros.push(registro);
    setRegistrosOffline(registros);
}

function carregarRegistrosPendentes() {
    todosRegistrosOffline = getRegistrosOffline();
    aplicarFiltrosOffline();
    
    const card = document.getElementById('pendingRecordsCard');
    const badge = document.getElementById('pendingCountBadge');
    
    badge.textContent = todosRegistrosOffline.length;
    card.style.display = todosRegistrosOffline.length > 0 ? 'block' : 'none';
}

function renderizarRegistrosOffline(registros) {
    const tbody = document.getElementById('registrosPendentesBody');
    
    if (registros.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                    Nenhum registro offline encontrado com os filtros aplicados.
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = '';
    registros.forEach((reg, index) => {
        const indexOriginal = todosRegistrosOffline.indexOf(reg);
        const row = tbody.insertRow();
        row.classList.add('offline-row');
        const tipo = String(reg.tipo || '').toLowerCase();
        const unit = tipo === 'agua' ? 'm¬≥' : 'kWh';

        let dataFormatada = 'Data Inv√°lida';
        if (reg.dataHora) {
            try {
                const d = new Date(reg.dataHora);
                if (!isNaN(d.getTime())) {
                    dataFormatada = d.toLocaleDateString('pt-BR') + ' ' + d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                }
            } catch (e) {
                console.error('Erro ao formatar data:', e);
            }
        }
        
        row.innerHTML = `
            <td><span class="badge badge-offline">${tipo === 'agua' ? 'üíß √Ågua' : '‚ö° Energia'}</span></td>
            <td>${dataFormatada}</td>
            <td>${String(reg.nome || 'N/A')}</td>
            <td>${String(reg.matricula || 'N/A')}</td>
            <td style="text-align: right; font-weight: 600;">${parseFloat(reg.leituraAtual || 0).toFixed(2)} ${unit}</td>
            <td style="text-align: right; color: var(--success); font-weight: 600;">+${parseFloat(reg.consumoTotal || 0).toFixed(2)} ${unit}</td>
            <td>
                <button class="btn btn-edit" onclick="abrirModalEdicao(${indexOriginal})">
                    <span class="material-icons" style="font-size: 14px;">edit</span>
                    Editar
                </button>
                <button class="btn btn-danger" onclick="excluirRegistroOffline(${indexOriginal})">
                    <span class="material-icons" style="font-size: 14px;">delete</span>
                    Excluir
                </button>
            </td>
        `;
    });
}

function toggleCustomDateOffline() {
    const periodo = document.getElementById('filtroPeriodoOffline').value;
    const showCustom = periodo === 'custom';
    
    document.getElementById('dataInicioGroupOffline').style.display = showCustom ? 'block' : 'none';
    document.getElementById('dataFimGroupOffline').style.display = showCustom ? 'block' : 'none';
}

function aplicarFiltrosOffline() {
    const tipoFiltro = document.getElementById('filtroTipoOffline').value;
    const periodoFiltro = document.getElementById('filtroPeriodoOffline').value;
    
    let registrosFiltrados = [...todosRegistrosOffline];
    
    if (tipoFiltro !== 'all') {
        registrosFiltrados = registrosFiltrados.filter(r => String(r.tipo).toLowerCase() === tipoFiltro);
    }
    
    if (periodoFiltro === 'today') {
        const hoje = new Date().toISOString().split('T')[0];
        registrosFiltrados = registrosFiltrados.filter(r => {
            if (!r.dataHora) return false;
            const dataReg = new Date(r.dataHora).toISOString().split('T')[0];
            return dataReg === hoje;
        });
    } else if (periodoFiltro === 'custom') {
        const dataInicio = document.getElementById('dataInicioOffline').value;
        const dataFim = document.getElementById('dataFimOffline').value;
        
        if (dataInicio && dataFim) {
            registrosFiltrados = registrosFiltrados.filter(r => {
                if (!r.dataHora) return false;
                const dataReg = new Date(r.dataHora).toISOString().split('T')[0];
                return dataReg >= dataInicio && dataReg <= dataFim;
            });
        }
    }
    
    renderizarRegistrosOffline(registrosFiltrados);
}

function limparFiltrosOffline() {
    document.getElementById('filtroTipoOffline').value = 'all';
    document.getElementById('filtroPeriodoOffline').value = 'all';
    document.getElementById('dataInicioOffline').value = '';
    document.getElementById('dataFimOffline').value = '';
    toggleCustomDateOffline();
    aplicarFiltrosOffline();
}

function excluirRegistroOffline(index) {
    if (!confirm('Tem certeza de que deseja excluir este registro offline? Esta a√ß√£o n√£o pode ser desfeita.')) {
        return;
    }
    const registros = getRegistrosOffline();
    registros.splice(index, 1);
    setRegistrosOffline(registros);
    mostrarAlerta('syncAlert', 'Registro exclu√≠do com sucesso!', 'success');
}

function limparTodosRegistrosOffline() {
    const registros = getRegistrosOffline();
    
    if (registros.length === 0) {
        mostrarAlerta('syncAlert', 'N√£o h√° registros offline para limpar.', 'warning');
        return;
    }
    
    if (!confirm(`‚ö†Ô∏è ATEN√á√ÉO: Voc√™ tem CERTEZA ABSOLUTA de que deseja EXCLUIR TODOS os ${registros.length} registros pendentes offline?\n\n‚ùå Esta a√ß√£o √© IRREVERS√çVEL e os dados ser√£o PERDIDOS PERMANENTEMENTE!\n\n‚úÖ Clique em OK para confirmar a exclus√£o\n‚ùå Clique em Cancelar para manter os registros`)) {
        return;
    }
    
    if (!confirm(`üö® √öLTIMA CONFIRMA√á√ÉO!\n\nVoc√™ est√° prestes a excluir ${registros.length} registro(s) offline.\n\nTem certeza de que deseja continuar?`)) {
        return;
    }
    
    setRegistrosOffline([]);
    mostrarAlerta('syncAlert', `‚úÖ Todos os ${registros.length} registros offline foram exclu√≠dos com sucesso.`, 'warning');
}

async function sincronizarRegistrosPendentes() {
    if (isProcessing) {
        mostrarAlerta('syncAlert', 'Aguarde a sincroniza√ß√£o anterior ser conclu√≠da!', 'error');
        return;
    }

    if (!scriptURL || !sheetID) {
        mostrarAlerta('syncAlert', 'Configure o sistema (URL e ID) primeiro!', 'error');
        return;
    }

    const registros = getRegistrosOffline();
    if (registros.length === 0) {
        mostrarAlerta('syncAlert', 'N√£o h√° registros pendentes para sincronizar!', 'warning');
        return;
    }

    isProcessing = true;
    const btn = document.querySelector('.btn-warning');
    const originalHTML = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '<div class="loading"></div> Sincronizando...';

    const payload = registros.map(reg => ({
        tipo: reg.tipo,
        nome: reg.nome,
        matricula: reg.matricula,
        dataHora: reg.dataHora,
        leituraAnterior: reg.leituraAnterior,
        leituraAtual: reg.leituraAtual,
        consumoTotal: reg.consumoTotal,
        extra1: reg.extra1,
        extra2: reg.extra2,
        extra3: reg.extra3,
    }));

    try {
        const response = await fetch(`${scriptURL}?action=addBatchRecords&sheetId=${sheetID}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ records: payload })
        });

        const result = await response.json();

        if (result.status === 'success') {
            setRegistrosOffline([]);
            mostrarAlerta('syncAlert', `‚úÖ ${result.count || registros.length} registros sincronizados com sucesso!`, 'success');
            await carregarDados();
        } else {
            throw new Error(result.message || 'Erro desconhecido ao sincronizar em lote.');
        }

    } catch (error) {
        mostrarAlerta('syncAlert', '‚ùå Erro na sincroniza√ß√£o: ' + error.message, 'error');
        console.error('Erro de sincroniza√ß√£o:', error);
    } finally {
        isProcessing = false;
        btn.disabled = false;
        btn.innerHTML = originalHTML;
        carregarRegistrosPendentes();
    }
}

// MODAL EDI√á√ÉO OFFLINE
function abrirModalEdicao(index) {
    const registros = getRegistrosOffline();
    const reg = registros[index];
    const tipo = reg.tipo;
    const unit = tipo === 'agua' ? 'm¬≥' : 'kWh';

    document.getElementById('editIndex').value = index;
    document.getElementById('editTipo').value = tipo;
    
    document.getElementById('labelLeituraAnterior').textContent = `Leitura Anterior (${unit})`;
    document.getElementById('labelLeituraAtual').textContent = `Leitura Atual do Medidor (${unit}) *`;
    document.getElementById('labelConsumoTotal').textContent = `Consumo Total Calculado (${unit})`;

    document.getElementById('editNome').value = reg.nome;
    document.getElementById('editMatricula').value = reg.matricula;
    document.getElementById('editDataHora').value = reg.dataHora.slice(0, 16);
    document.getElementById('editLeituraAnterior').value = reg.leituraAnterior;
    document.getElementById('editLeituraAtual').value = reg.leituraAtual;
    document.getElementById('editConsumoTotal').value = reg.consumoTotal;
    document.getElementById('editExtra1').value = reg.extra1;
    document.getElementById('editExtra2').value = reg.extra2;
    document.getElementById('editExtra3').value = reg.extra3;
    
    document.getElementById('editModal').style.display = 'block';
}

function calcularConsumoModal() {
    const leituraAtual = parseFloat(document.getElementById('editLeituraAtual').value) || 0;
    const leituraAnterior = parseFloat(document.getElementById('editLeituraAnterior').value) || 0;
    
    const consumo = Math.max(0, leituraAtual - leituraAnterior);
    document.getElementById('editConsumoTotal').value = consumo.toFixed(2);
}

function salvarEdicao(event) {
    event.preventDefault();

    const index = parseInt(document.getElementById('editIndex').value);
    const tipo = document.getElementById('editTipo').value;
    const registros = getRegistrosOffline();
    
    calcularConsumoModal();

    const registroEditado = {
        tipo: tipo,
        nome: document.getElementById('editNome').value,
        matricula: document.getElementById('editMatricula').value,
        dataHora: document.getElementById('editDataHora').value,
        leituraAnterior: parseFloat(document.getElementById('editLeituraAnterior').value).toFixed(2),
        leituraAtual: parseFloat(document.getElementById('editLeituraAtual').value).toFixed(2),
        consumoTotal: parseFloat(document.getElementById('editConsumoTotal').value).toFixed(2),
        extra1: document.getElementById('editExtra1').value,
        extra2: document.getElementById('editExtra2').value,
        extra3: document.getElementById('editExtra3').value,
        timestamp: registros[index].timestamp
    };

    registros[index] = registroEditado;
    setRegistrosOffline(registros);
    mostrarAlerta('alertEditModal', 'Registro atualizado com sucesso no modo offline!', 'success');
    
    setTimeout(() => {
        fecharModal();
    }, 1500);
}

function fecharModal() {
    document.getElementById('editModal').style.display = 'none';
    document.getElementById('alertEditModal').classList.remove('show');
}

// MODAL EDI√á√ÉO ONLINE
function abrirModalEditOnline(index) {
    const registrosFiltrados = obterRegistrosFiltrados();
    const reg = registrosFiltrados[index];
    const tipo = reg.tipo;
    const unit = tipo === 'agua' ? 'm¬≥' : 'kWh';

    document.getElementById('editOnlineRowId').value = index;
    document.getElementById('editOnlineTipo').value = tipo;
    
    document.getElementById('labelEditOnlineLeituraAnterior').textContent = `Leitura Anterior (${unit})`;
    document.getElementById('labelEditOnlineLeituraAtual').textContent = `Leitura Atual do Medidor (${unit}) *`;
    document.getElementById('labelEditOnlineConsumoTotal').textContent = `Consumo Total Calculado (${unit})`;

    document.getElementById('editOnlineNome').value = reg.nome;
    document.getElementById('editOnlineMatricula').value = reg.matricula;
    
    const dataHora = new Date(reg.dataHora);
    const localDate = new Date(dataHora.getTime() - dataHora.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
    document.getElementById('editOnlineDataHora').value = localDate;
    
    document.getElementById('editOnlineLeituraAnterior').value = parseFloat(reg.leituraAnterior || 0).toFixed(2);
    document.getElementById('editOnlineLeituraAtual').value = parseFloat(reg.leituraAtual || 0).toFixed(2);
    document.getElementById('editOnlineConsumoTotal').value = parseFloat(reg.consumoTotal || 0).toFixed(2);
    document.getElementById('editOnlineExtra1').value = reg.extra1 || '';
    document.getElementById('editOnlineExtra2').value = reg.extra2 || '';
    document.getElementById('editOnlineExtra3').value = reg.extra3 || '';
    
    document.getElementById('editOnlineModal').style.display = 'block';
}

function calcularConsumoModalOnline() {
    const leituraAtual = parseFloat(document.getElementById('editOnlineLeituraAtual').value) || 0;
    const leituraAnterior = parseFloat(document.getElementById('editOnlineLeituraAnterior').value) || 0;
    
    const consumo = Math.max(0, leituraAtual - leituraAnterior);
    document.getElementById('editOnlineConsumoTotal').value = consumo.toFixed(2);
}

async function salvarEdicaoOnline(event) {
    event.preventDefault();

    if (!scriptURL || !sheetID) {
        mostrarAlerta('alertEditOnlineModal', 'Configure o sistema primeiro!', 'error');
        return;
    }

    const index = parseInt(document.getElementById('editOnlineRowId').value);
    const registrosFiltrados = obterRegistrosFiltrados();
    const regOriginal = registrosFiltrados[index];
    const tipo = document.getElementById('editOnlineTipo').value;
    
    calcularConsumoModalOnline();

    const dadosAtualizados = {
        action: 'updateRecord',
        sheetId: sheetID,
        tipo: tipo,
        rowIndex: todosRegistrosOnline.indexOf(regOriginal) + 2, // +2 porque a planilha come√ßa em 1 e tem cabe√ßalho
        nome: document.getElementById('editOnlineNome').value,
        matricula: document.getElementById('editOnlineMatricula').value,
        dataHora: document.getElementById('editOnlineDataHora').value,
        leituraAnterior: parseFloat(document.getElementById('editOnlineLeituraAnterior').value).toFixed(2),
        leituraAtual: parseFloat(document.getElementById('editOnlineLeituraAtual').value).toFixed(2),
        consumoTotal: parseFloat(document.getElementById('editOnlineConsumoTotal').value).toFixed(2),
        extra1: document.getElementById('editOnlineExtra1').value,
        extra2: document.getElementById('editOnlineExtra2').value,
        extra3: document.getElementById('editOnlineExtra3').value
    };

    try {
        const formData = new FormData();
        for (const key in dadosAtualizados) {
            formData.append(key, dadosAtualizados[key]);
        }

        const response = await fetch(scriptURL, {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.status === 'success') {
            mostrarAlerta('alertEditOnlineModal', '‚úÖ Registro atualizado com sucesso!', 'success');
            setTimeout(async () => {
                fecharModalEditOnline();
                await carregarDados();
            }, 1500);
        } else {
            throw new Error(result.message || 'Erro ao atualizar registro');
        }
    } catch (error) {
        mostrarAlerta('alertEditOnlineModal', '‚ùå Erro ao salvar: ' + error.message, 'error');
        console.error('Erro:', error);
    }
}

function fecharModalEditOnline() {
    document.getElementById('editOnlineModal').style.display = 'none';
    document.getElementById('alertEditOnlineModal').classList.remove('show');
}

async function excluirRegistroOnline(index) {
    if (!confirm('‚ö†Ô∏è Tem certeza de que deseja EXCLUIR este registro online?\n\nEsta a√ß√£o √© IRREVERS√çVEL!')) {
        return;
    }

    if (!scriptURL || !sheetID) {
        mostrarAlerta('configAlert', 'Configure o sistema primeiro!', 'error');
        return;
    }

    const registrosFiltrados = obterRegistrosFiltrados();
    const reg = registrosFiltrados[index];
    const tipo = reg.tipo;

    try {
        const formData = new FormData();
        formData.append('action', 'deleteRecord');
        formData.append('sheetId', sheetID);
        formData.append('tipo', tipo);
        formData.append('rowIndex', todosRegistrosOnline.indexOf(reg) + 2); // +2 porque a planilha come√ßa em 1 e tem cabe√ßalho

        const response = await fetch(scriptURL, {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.status === 'success') {
            mostrarAlerta('configAlert', '‚úÖ Registro exclu√≠do com sucesso!', 'success');
            await carregarDados();
        } else {
            throw new Error(result.message || 'Erro ao excluir registro');
        }
    } catch (error) {
        mostrarAlerta('configAlert', '‚ùå Erro ao excluir: ' + error.message, 'error');
        console.error('Erro:', error);
    }
}

function obterRegistrosFiltrados() {
    const termo = document.getElementById('searchInput').value.toLowerCase();
    const tipoFiltro = document.getElementById('filtroTipo').value;
    const periodoFiltro = document.getElementById('filtroPeriodo').value;
    
    let registrosFiltrados = [...todosRegistrosOnline];
    
    if (termo) {
        registrosFiltrados = registrosFiltrados.filter(r => 
            (r.nome && r.nome.toLowerCase().includes(termo)) ||
            (r.matricula && r.matricula.toLowerCase().includes(termo))
        );
    }
    
    if (tipoFiltro !== 'all') {
        registrosFiltrados = registrosFiltrados.filter(r => String(r.tipo).toLowerCase() === tipoFiltro);
    }
    
    if (periodoFiltro === 'today') {
        const hoje = new Date().toISOString().split('T')[0];
        registrosFiltrados = registrosFiltrados.filter(r => {
            if (!r.dataHora) return false;
            const dataReg = new Date(r.dataHora).toISOString().split('T')[0];
            return dataReg === hoje;
        });
    } else if (periodoFiltro === 'custom') {
        const dataInicio = document.getElementById('dataInicio').value;
        const dataFim = document.getElementById('dataFim').value;
        
        if (dataInicio && dataFim) {
            registrosFiltrados = registrosFiltrados.filter(r => {
                if (!r.dataHora) return false;
                const dataReg = new Date(r.dataHora).toISOString().split('T')[0];
                return dataReg >= dataInicio && dataReg <= dataFim;
            });
        }
    }
    
    return registrosFiltrados;
}

// GR√ÅFICOS
function trocarGrafico(tipo) {
    currentChartType = tipo;
    
    document.querySelectorAll('.chart-tab').forEach(tab => tab.classList.remove('active'));
    event.target.classList.add('active');
    
    atualizarGrafico();
}

function atualizarGrafico() {
    if (currentChart) {
        currentChart.destroy();
    }

    const ctx = document.getElementById('consumptionChart').getContext('2d');
    const theme = document.documentElement.getAttribute('data-theme');
    const textColor = theme === 'dark' ? '#e0e0e0' : '#212121';
    const gridColor = theme === 'dark' ? '#444' : '#e0e0e0';

    if (currentChartType === 'line') {
        criarGraficoLinha(ctx, textColor, gridColor);
    } else if (currentChartType === 'bar') {
        criarGraficoBarras(ctx, textColor, gridColor);
    } else if (currentChartType === 'pie') {
        criarGraficoPizza(ctx, textColor);
    }
}

function criarGraficoLinha(ctx, textColor, gridColor) {
    const ultimos30Dias = [];
    const consumoAgua = [];
    const consumoEnergia = [];
    
    for (let i = 29; i >= 0; i--) {
        const data = new Date();
        data.setDate(data.getDate() - i);
        const dataStr = toYYYYMMDD(data);
        ultimos30Dias.push(data.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }));
        
        const consumo = calcularConsumoDiarioPorData(dataStr);
        consumoAgua.push(consumo.agua);
        consumoEnergia.push(consumo.energia);
    }

    currentChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ultimos30Dias,
            datasets: [{
                label: 'üíß √Ågua (m¬≥)',
                data: consumoAgua,
                borderColor: '#1e88e5',
                backgroundColor: 'rgba(30, 136, 229, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: '‚ö° Energia (kWh)',
                data: consumoEnergia,
                borderColor: '#ff6f00',
                backgroundColor: 'rgba(255, 111, 0, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: textColor }
                },
                title: {
                    display: true,
                    text: 'Evolu√ß√£o do Consumo - √öltimos 30 Dias',
                    color: textColor,
                    font: { size: 16 }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: textColor },
                    grid: { color: gridColor }
                },
                x: {
                    ticks: { color: textColor },
                    grid: { color: gridColor }
                }
            }
        }
    });
}

function criarGraficoBarras(ctx, textColor, gridColor) {
    const ultimos7Dias = [];
    const consumoAgua = [];
    const consumoEnergia = [];
    
    for (let i = 6; i >= 0; i--) {
        const data = new Date();
        data.setDate(data.getDate() - i);
        const dataStr = toYYYYMMDD(data);
        ultimos7Dias.push(data.toLocaleDateString('pt-BR', { weekday: 'short', day: '2-digit' }));
        
        const consumo = calcularConsumoDiarioPorData(dataStr);
        consumoAgua.push(consumo.agua);
        consumoEnergia.push(consumo.energia);
    }

    currentChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ultimos7Dias,
            datasets: [{
                label: 'üíß √Ågua (m¬≥)',
                data: consumoAgua,
                backgroundColor: '#1e88e5'
            }, {
                label: '‚ö° Energia (kWh)',
                data: consumoEnergia,
                backgroundColor: '#ff6f00'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: textColor }
                },
                title: {
                    display: true,
                    text: 'Comparativo Semanal',
                    color: textColor,
                    font: { size: 16 }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: textColor },
                    grid: { color: gridColor }
                },
                x: {
                    ticks: { color: textColor },
                    grid: { color: gridColor }
                }
            }
        }
    });
}

function criarGraficoPizza(ctx, textColor) {
    let totalAgua = 0;
    let totalEnergia = 0;
    
    todosRegistrosOnline.forEach(reg => {
        const consumo = parseFloat(reg.consumoTotal || 0);
        if (reg.tipo === 'agua') {
            totalAgua += consumo;
        } else {
            totalEnergia += consumo;
        }
    });

    currentChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['üíß √Ågua', '‚ö° Energia'],
            datasets: [{
                data: [totalAgua, totalEnergia],
                backgroundColor: ['#1e88e5', '#ff6f00']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: textColor }
                },
                title: {
                    display: true,
                    text: 'Distribui√ß√£o Total do Consumo',
                    color: textColor,
                    font: { size: 16 }
                }
            }
        }
    });
}

function exportarGrafico() {
    const canvas = document.getElementById('consumptionChart');
    const url = canvas.toDataURL('image/png');
    const link = document.createElement('a');
    link.download = `grafico-consumo-${new Date().toISOString().split('T')[0]}.png`;
    link.href = url;
    link.click();
}

// RELAT√ìRIOS
function atualizarRelatorio() {
    const periodo = parseInt(document.getElementById('relatorioPeriodo').value);
    let dataInicio;
    
    if (periodo === 'all') {
        dataInicio = new Date(0);
    } else {
        dataInicio = new Date();
        dataInicio.setDate(dataInicio.getDate() - periodo);
    }
    
    const registrosFiltrados = todosRegistrosOnline.filter(r => {
        const dataReg = new Date(r.dataHora);
        return dataReg >= dataInicio;
    });
    
    let totalAgua = 0;
    let totalEnergia = 0;
    
    registrosFiltrados.forEach(reg => {
        const consumo = parseFloat(reg.consumoTotal || 0);
        if (reg.tipo === 'agua') {
            totalAgua += consumo;
        } else {
            totalEnergia += consumo;
        }
    });
    
    const dias = periodo === 'all' ? Math.max(1, Math.ceil((new Date() - new Date(registrosFiltrados[0]?.dataHora || new Date())) / (1000 * 60 * 60 * 24))) : periodo;
    const mediaAgua = totalAgua / dias;
    const mediaEnergia = totalEnergia / dias;
    
    document.getElementById('relatorioTotalAgua').textContent = totalAgua.toFixed(2) + ' m¬≥';
    document.getElementById('relatorioTotalEnergia').textContent = totalEnergia.toFixed(2) + ' kWh';
    document.getElementById('relatorioMediaAgua').textContent = mediaAgua.toFixed(2) + ' m¬≥/dia';
    document.getElementById('relatorioMediaEnergia').textContent = mediaEnergia.toFixed(2) + ' kWh/dia';
}

function gerarRelatorioPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    doc.setFontSize(18);
    doc.text('Relat√≥rio de Consumo', 105, 15, { align: 'center' });
    
    doc.setFontSize(12);
    doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 105, 25, { align: 'center' });
    
    let y = 40;
    
    doc.setFontSize(14);
    doc.text('Resumo Geral', 20, y);
    y += 10;
    
    doc.setFontSize(11);
    doc.text(`üíß Total √Ågua: ${document.getElementById('relatorioTotalAgua').textContent}`, 20, y);
    y += 7;
    doc.text(`‚ö° Total Energia: ${document.getElementById('relatorioTotalEnergia').textContent}`, 20, y);
    y += 7;
    doc.text(`üìä M√©dia Di√°ria √Ågua: ${document.getElementById('relatorioMediaAgua').textContent}`, 20, y);
    y += 7;
    doc.text(`üìä M√©dia Di√°ria Energia: ${document.getElementById('relatorioMediaEnergia').textContent}`, 20, y);
    y += 15;
    
    doc.setFontSize(14);
    doc.text('√öltimos 10 Registros', 20, y);
    y += 10;
    
    const ultimos10 = todosRegistrosOnline.slice(-10);
    
    doc.setFontSize(9);
    ultimos10.forEach(reg => {
        const tipo = reg.tipo === 'agua' ? 'üíß √Ågua' : '‚ö° Energia';
        const data = new Date(reg.dataHora).toLocaleDateString('pt-BR');
        const linha = `${tipo} | ${data} | ${reg.nome} | ${parseFloat(reg.consumoTotal || 0).toFixed(2)}`;
        doc.text(linha, 20, y);
        y += 6;
        
        if (y > 270) {
            doc.addPage();
            y = 20;
        }
    });
    
    doc.save(`relatorio-consumo-${new Date().toISOString().split('T')[0]}.pdf`);
}

function exportarCSV() {
    let csv = 'Tipo,Data/Hora,Nome,Matr√≠cula,Leitura Anterior,Leitura Atual,Consumo Total\n';
    
    todosRegistrosOnline.forEach(reg => {
        const tipo = reg.tipo === 'agua' ? '√Ågua' : 'Energia';
        const dataHora = new Date(reg.dataHora).toLocaleString('pt-BR');
        const linha = `${tipo},"${dataHora}","${reg.nome}","${reg.matricula}",${reg.leituraAnterior},${reg.leituraAtual},${reg.consumoTotal}\n`;
        csv += linha;
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `dados-consumo-${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
}

window.onclick = function(event) {
    const editModal = document.getElementById('editModal');
    const editOnlineModal = document.getElementById('editOnlineModal');
    
    if (event.target === editModal) {
        fecharModal();
    }
    if (event.target === editOnlineModal) {
        fecharModalEditOnline();
    }
}

function mostrarAlerta(elementId, mensagem, tipo) {
    const alert = document.getElementById(elementId);
    if (!alert) return;
    
    alert.className = `alert alert-${tipo} show`;
    alert.innerHTML = `
        <span class="material-icons">${tipo === 'success' ? 'check_circle' : (tipo === 'warning' ? 'warning' : 'error')}</span>
        ${mensagem}
    `;
    
    setTimeout(() => {
        alert.classList.remove('show');
    }, 8000);
}
</script>

</body>
</html>
