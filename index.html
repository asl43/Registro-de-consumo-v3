<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Registro de Consumo</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
    /* O CSS ORIGINAL FOI MANTIDO SEM ALTERAÇÕES PARA MANTER O ESTILO */
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }
    
    :root {
        --primary: #1e88e5;
        --secondary: #26a69a;
        --accent: #ff6f00;
        --success: #43a047;
        --error: #e53935;
        --warning: #fb8c00;
        --dark: #212121;
        --light: #f5f5f5;
        --border: #e0e0e0;
        --shadow: 0 2px 8px rgba(0,0,0,0.1);
        --shadow-lg: 0 4px 16px rgba(0,0,0,0.15);
    }
    
    body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        color: var(--dark);
    }
    
    .container {
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
        animation: fadeInDown 0.6s ease;
    }
    
    .header h1 {
        font-size: clamp(28px, 5vw, 42px);
        font-weight: 700;
        margin-bottom: 8px;
        text-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    
    .header p {
        font-size: 16px;
        opacity: 0.95;
    }
    
    .status-bar {
        background: white;
        padding: 15px 25px;
        border-radius: 12px;
        box-shadow: var(--shadow-lg);
        margin-bottom: 25px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 15px;
        animation: fadeIn 0.6s ease;
    }
    
    .status-item {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .status-item .material-icons {
        font-size: 24px;
        color: var(--primary);
    }
    
    .status-text {
        font-size: 14px;
        color: #666;
    }
    
    .status-value {
        font-size: 16px;
        font-weight: 600;
        color: var(--dark);
    }
    
    .card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: var(--shadow);
        margin-bottom: 25px;
        animation: fadeInUp 0.6s ease;
    }
    
    .card-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--light);
    }
    
    .card-header .material-icons {
        font-size: 28px;
        color: var(--primary);
    }
    
    .card-header h2 {
        font-size: 20px;
        font-weight: 600;
        color: var(--dark);
    }
    
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
    }
    
    .form-group {
        margin-bottom: 18px;
    }
    
    .form-group label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        color: var(--dark);
        margin-bottom: 8px;
    }
    
    .form-group input,
    .form-group select {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid var(--border);
        border-radius: 8px;
        font-size: 15px;
        font-family: inherit;
        transition: all 0.3s;
        background: white;
    }
    
    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.1);
    }
    
    .form-group input:read-only {
        background: #f8f9fa;
        color: #495057;
        font-weight: 600;
        cursor: not-allowed;
    }
    
    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        text-decoration: none;
        white-space: nowrap;
    }
    
    .btn-primary {
        background: var(--primary);
        color: white;
        box-shadow: 0 4px 12px rgba(30, 136, 229, 0.3);
    }
    
    .btn-primary:hover:not(:disabled) {
        background: #1976d2;
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(30, 136, 229, 0.4);
    }
    
    .btn-primary:disabled {
        background: #bdbdbd;
        cursor: not-allowed;
        transform: none;
    }
    
    .btn-secondary {
        background: var(--secondary);
        color: white;
    }
    
    .btn-secondary:hover:not(:disabled) {
        background: #00897b;
        transform: translateY(-2px);
    }

    .btn-warning {
        background: var(--warning);
        color: white;
    }
    
    .btn-warning:hover:not(:disabled) {
        background: #f9a825;
        transform: translateY(-2px);
    }

    .btn-danger {
        background: var(--error);
        color: white;
        padding: 8px 16px;
        font-size: 14px;
    }
    
    .btn-danger:hover:not(:disabled) {
        background: #c62828;
        transform: translateY(-1px);
    }

    .btn-edit {
        background: var(--primary);
        color: white;
        padding: 8px 16px;
        font-size: 14px;
        margin-right: 8px;
    }
    
    .btn-edit:hover:not(:disabled) {
        background: #1976d2;
        transform: translateY(-1px);
    }

    .btn-icon-only {
        padding: 8px;
        width: 38px;
        height: 38px;
        border-radius: 50%;
    }
    
    .btn-full {
        width: 100%;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: var(--shadow);
        text-align: center;
        position: relative;
        overflow: hidden;
    }
    
    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary), var(--secondary));
    }
    
    .stat-icon {
        font-size: 48px;
        margin-bottom: 10px;
    }
    
    .stat-label {
        font-size: 13px;
        color: #757575;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .stat-value {
        font-size: 32px;
        font-weight: 700;
        color: var(--dark);
    }
    
    .filter-container {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 2px solid var(--border);
    }
    
    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        align-items: end;
    }
    
    .filter-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 15px;
    }
    
    .table-container {
        overflow-x: auto;
        border-radius: 8px;
        border: 1px solid var(--border);
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
        min-width: 800px;
    }
    
    table thead {
        background: var(--dark);
        color: white;
    }
    
    table thead th {
        padding: 14px 16px;
        font-size: 13px;
        font-weight: 600;
        text-align: left;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    table tbody tr {
        border-bottom: 1px solid var(--border);
        transition: background 0.2s;
    }
    
    table tbody tr:hover {
        background: #f5f5f5;
    }
    
    table tbody td {
        padding: 14px 16px;
        font-size: 14px;
    }

    table tbody tr.offline-row {
        background: #fff8e1;
        font-weight: 500;
    }
    
    .badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .badge-agua {
        background: #e3f2fd;
        color: #1976d2;
    }
    
    .badge-energia {
        background: #fff3e0;
        color: #f57c00;
    }

    .badge-offline {
        background: #ffecb3;
        color: #ffa000;
    }
    
    .alert {
        padding: 14px 18px;
        border-radius: 8px;
        margin-top: 15px;
        display: none;
        align-items: center;
        gap: 10px;
        font-size: 14px;
        font-weight: 500;
    }
    
    .alert.show {
        display: flex;
    }
    
    .alert-success {
        background: #e8f5e9;
        color: #2e7d32;
        border-left: 4px solid var(--success);
    }
    
    .alert-error {
        background: #ffebee;
        color: #c62828;
        border-left: 4px solid var(--error);
    }
    
    .alert-warning {
        background: #fffde7;
        color: #f57f17;
        border-left: 4px solid var(--warning);
    }
    
    .loading {
        display: inline-block;
        width: 18px;
        height: 18px;
        border: 3px solid rgba(255,255,255,0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
        padding-top: 60px;
    }

    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        width: 90%;
        max-width: 700px;
        position: relative;
        animation: fadeIn 0.3s;
    }

    .close-btn {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

    .close-btn:hover,
    .close-btn:focus {
        color: #000;
        text-decoration: none;
        cursor: pointer;
    }
    
    .consumption-display {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-top: 15px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    
    .consumption-display h3 {
        font-size: 16px;
        margin-bottom: 10px;
        opacity: 0.9;
    }
    
    .consumption-value {
        font-size: 36px;
        font-weight: 700;
        text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .daily-consumption-table {
        margin-top: 20px;
    }

    .daily-consumption-table table {
        min-width: 400px;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    @keyframes fadeInDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    @media (max-width: 768px) {
        body {
            padding: 15px;
        }
        
        .card {
            padding: 20px;
        }
        
        .form-grid {
            grid-template-columns: 1fr;
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .status-bar {
            flex-direction: column;
            align-items: flex-start;
        }

        .filter-grid {
            grid-template-columns: 1fr;
        }

        table {
             min-width: 600px;
        }
    }
</style>
</head>

<body>

<div class="container">
    <div class="header">
        <h1>💧⚡ Sistema de Registro de Consumo</h1>
        <p>Controle inteligente de água e energia com sincronização em tempo real e modo offline</p>
    </div>
    
    <div class="status-bar">
        <div class="status-item">
            <span class="material-icons">cloud</span>
            <div>
                <div class="status-text">Status da Conexão</div>
                <div class="status-value" id="connectionStatus">Verificando...</div>
            </div>
        </div>
        <div class="status-item">
            <span class="material-icons">update</span>
            <div>
                <div class="status-text">Última Atualização</div>
                <div class="status-value" id="lastUpdate">--:--</div>
            </div>
        </div>
        <div class="status-item">
            <span class="material-icons">storage</span>
            <div>
                <div class="status-text">Total de Registros (Online)</div>
                <div class="status-value" id="totalRecords">0</div>
            </div>
        </div>
        <div class="status-item">
            <span class="material-icons" style="color: var(--warning);">save</span>
            <div>
                <div class="status-text">Registros Pendentes (Offline)</div>
                <div class="status-value" id="pendingRecordsCount">0</div>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <span class="material-icons">settings</span>
            <h2>Configuração do Sistema</h2>
        </div>
        
        <div class="form-grid">
            <div class="form-group">
                <label>🔗 URL do Google Apps Script</label>
                <input type="url" id="scriptURL" placeholder="https://script.google.com/macros/s/.../exec">
            </div>
            <div class="form-group">
                <label>📊 ID da Planilha Google Sheets</label>
                <input type="text" id="sheetID" placeholder="ID da planilha (encontrado na URL)">
            </div>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
            <button class="btn btn-primary" onclick="salvarConfiguracao()">
                <span class="material-icons" style="font-size: 18px;">save</span>
                Salvar Configuração
            </button>
            <button class="btn btn-secondary" onclick="testarConexao()">
                <span class="material-icons" style="font-size: 18px;">sync</span>
                Testar Conexão
            </button>
        </div>
        
        <div class="alert" id="configAlert"></div>
    </div>
    
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">💧</div>
            <div class="stat-label">Leitura Atual Água</div>
            <div class="stat-value" id="totalAgua">0.00 m³</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">⚡</div>
            <div class="stat-label">Leitura Atual Energia</div>
            <div class="stat-value" id="totalEnergia">0.00 kWh</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="color: var(--secondary);">💧</div>
            <div class="stat-label">Média Diária Água</div>
            <div class="stat-value" id="mediaDiariaAgua">0.00 m³/dia</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="color: var(--accent);">⚡</div>
            <div class="stat-label">Média Diária Energia</div>
            <div class="stat-value" id="mediaDiariaEnergia">0.00 kWh/dia</div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <span class="material-icons">water_drop</span>
            <h2>Registro de Consumo de Água</h2>
        </div>
        
        <form id="aguaForm" onsubmit="handleSubmit(event, 'agua')">
            <div class="form-grid">
                <div class="form-group">
                    <label>Nome Completo *</label>
                    <input type="text" name="nome" required placeholder="Digite o nome completo">
                </div>
                <div class="form-group">
                    <label>Matrícula Residencial *</label>
                    <input type="text" name="matricula" required placeholder="Digite a matrícula">
                </div>
                <div class="form-group">
                    <label>Data e Hora *</label>
                    <input type="datetime-local" name="dataHora" id="dataHoraAgua" required>
                </div>
                <div class="form-group">
                    <label>Leitura Anterior (m³)</label>
                    <input type="number" id="leituraAnteriorAgua" step="0.01" readonly>
                </div>
                <div class="form-group">
                    <label>Leitura Atual do Medidor (m³) *</label>
                    <input type="number" name="leituraAtual" id="leituraAtualAgua" step="0.01" required placeholder="0.00" oninput="calcularConsumo('agua')">
                </div>
                <div class="form-group">
                    <label>Consumo Total Calculado (m³)</label>
                    <input type="number" name="consumoTotal" id="consumoTotalAgua" step="0.01" readonly>
                </div>
                <div class="form-group">
                    <label>Extra 1 (Opcional)</label>
                    <input type="text" name="extra1" placeholder="Campo adicional 1">
                </div>
                <div class="form-group">
                    <label>Extra 2 (Opcional)</label>
                    <input type="text" name="extra2" placeholder="Campo adicional 2">
                </div>
                <div class="form-group">
                    <label>Extra 3 (Opcional)</label>
                    <input type="text" name="extra3" placeholder="Campo adicional 3">
                </div>
            </div>
            
            <div class="consumption-display" id="consumptionDisplayAgua" style="display: none;">
                <h3>💧 Consumo Calculado de Água</h3>
                <div class="consumption-value" id="consumptionValueAgua">0.00 m³</div>
            </div>
            
            <button type="submit" class="btn btn-primary btn-full" style="margin-top: 20px;">
                <span class="material-icons">send</span>
                Registrar Consumo de Água
            </button>
            
            <div class="alert" id="alertAgua"></div>
        </form>
    </div>
    
    <div class="card">
        <div class="card-header">
            <span class="material-icons">bolt</span>
            <h2>Registro de Consumo de Energia</h2>
        </div>
        
        <form id="energiaForm" onsubmit="handleSubmit(event, 'energia')">
            <div class="form-grid">
                <div class="form-group">
                    <label>Nome Completo *</label>
                    <input type="text" name="nome" required placeholder="Digite o nome completo">
                </div>
                <div class="form-group">
                    <label>Matrícula Residencial *</label>
                    <input type="text" name="matricula" required placeholder="Digite a matrícula">
                </div>
                <div class="form-group">
                    <label>Data e Hora *</label>
                    <input type="datetime-local" name="dataHora" id="dataHoraEnergia" required>
                </div>
                <div class="form-group">
                    <label>Leitura Anterior (kWh)</label>
                    <input type="number" id="leituraAnteriorEnergia" step="0.01" readonly>
                </div>
                <div class="form-group">
                    <label>Leitura Atual do Medidor (kWh) *</label>
                    <input type="number" name="leituraAtual" id="leituraAtualEnergia" step="0.01" required placeholder="0.00" oninput="calcularConsumo('energia')">
                </div>
                <div class="form-group">
                    <label>Consumo Total Calculado (kWh)</label>
                    <input type="number" name="consumoTotal" id="consumoTotalEnergia" step="0.01" readonly>
                </div>
                <div class="form-group">
                    <label>Extra 1 (Opcional)</label>
                    <input type="text" name="extra1" placeholder="Campo adicional 1">
                </div>
                <div class="form-group">
                    <label>Extra 2 (Opcional)</label>
                    <input type="text" name="extra2" placeholder="Campo adicional 2">
                </div>
                <div class="form-group">
                    <label>Extra 3 (Opcional)</label>
                    <input type="text" name="extra3" placeholder="Campo adicional 3">
                </div>
            </div>
            
            <div class="consumption-display" id="consumptionDisplayEnergia" style="display: none;">
                <h3>⚡ Consumo Calculado de Energia</h3>
                <div class="consumption-value" id="consumptionValueEnergia">0.00 kWh</div>
            </div>
            
            <button type="submit" class="btn btn-primary btn-full" style="margin-top: 20px; background: var(--accent);">
                <span class="material-icons">send</span>
                Registrar Consumo de Energia
            </button>
            
            <div class="alert" id="alertEnergia"></div>
        </form>
    </div>

    <div class="card">
        <div class="card-header">
            <span class="material-icons">calendar_today</span>
            <h2>Visualização do Consumo Diário</h2>
        </div>

        <div class="filter-container">
            <h3 style="margin-bottom: 15px; font-size: 16px; color: var(--dark);">
                <span class="material-icons" style="vertical-align: middle; font-size: 20px;">date_range</span>
                Selecione o Período
            </h3>
            <div class="filter-grid">
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Data Início *</label>
                    <input type="date" id="dailyDataInicio" required>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Data Fim *</label>
                    <input type="date" id="dailyDataFim" required>
                </div>
            </div>
            <div class="filter-buttons">
                <button class="btn btn-primary" onclick="calcularConsumoDiario()">
                    <span class="material-icons">visibility</span>
                    Ver Consumo Diário
                </button>
            </div>
        </div>

        <div class="table-container daily-consumption-table">
            <table>
                <thead>
                    <tr>
                        <th>Dia</th>
                        <th style="text-align: right;">💧 Consumo Água</th>
                        <th style="text-align: right;">⚡ Consumo Energia</th>
                    </tr>
                </thead>
                <tbody id="consumoDiarioBody">
                    <tr>
                        <td colspan="3" style="text-align: center; padding: 40px; color: #999;">
                            Selecione um período e clique em "Ver Consumo Diário".
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="card" id="pendingRecordsCard" style="display: none;">
        <div class="card-header" style="border-bottom-color: var(--warning);">
            <span class="material-icons" style="color: var(--warning);">warning</span>
            <h2>Registros Pendentes (Offline) <span id="pendingCountBadge" class="badge badge-offline">0</span></h2>
        </div>

        <div class="filter-container">
            <h3 style="margin-bottom: 15px; font-size: 16px; color: var(--dark);">
                <span class="material-icons" style="vertical-align: middle; font-size: 20px;">filter_list</span>
                Filtros de Pesquisa
            </h3>
            <div class="filter-grid">
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Tipo de Registro</label>
                    <select id="filtroTipoOffline">
                        <option value="all">Todos os Tipos</option>
                        <option value="agua">Apenas Água</option>
                        <option value="energia">Apenas Energia</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Período</label>
                    <select id="filtroPeriodoOffline" onchange="toggleCustomDateOffline()">
                        <option value="all">Todos os Registros</option>
                        <option value="today">Dia Atual</option>
                        <option value="custom">Período Personalizado</option>
                    </select>
                </div>
                <div class="form-group" id="dataInicioGroupOffline" style="margin-bottom: 0; display: none;">
                    <label>Data Início</label>
                    <input type="date" id="dataInicioOffline">
                </div>
                <div class="form-group" id="dataFimGroupOffline" style="margin-bottom: 0; display: none;">
                    <label>Data Fim</label>
                    <input type="date" id="dataFimOffline">
                </div>
            </div>
            <div class="filter-buttons">
                <button class="btn btn-secondary" onclick="aplicarFiltrosOffline()">
                    <span class="material-icons">search</span>
                    Aplicar Filtros
                </button>
                <button class="btn btn-primary" onclick="limparFiltrosOffline()">
                    <span class="material-icons">clear</span>
                    Limpar Filtros
                </button>
            </div>
        </div>

        <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
            <button class="btn btn-warning" onclick="sincronizarRegistrosPendentes()">
                <span class="material-icons">cloud_upload</span>
                Sincronizar Registros Pendentes
            </button>
            <button class="btn btn-danger" onclick="limparTodosRegistrosOffline()">
                <span class="material-icons">delete_forever</span>
                Limpar Todos os Registros Offline
            </button>
        </div>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Tipo</th>
                        <th>Data/Hora</th>
                        <th>Nome</th>
                        <th>Matrícula</th>
                        <th style="text-align: right;">Leitura Atual</th>
                        <th style="text-align: right;">Consumo</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="registrosPendentesBody">
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                            Nenhum registro offline pendente.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="alert" id="syncAlert"></div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <span class="material-icons">history</span>
            <h2>Histórico de Registros (Online)</h2>
        </div>
        
        <div class="filter-container">
            <h3 style="margin-bottom: 15px; font-size: 16px; color: var(--dark);">
                <span class="material-icons" style="vertical-align: middle; font-size: 20px;">filter_list</span>
                Filtros de Pesquisa
            </h3>
            <div class="filter-grid">
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Tipo de Registro</label>
                    <select id="filtroTipo">
                        <option value="all">Todos os Tipos</option>
                        <option value="agua">Apenas Água</option>
                        <option value="energia">Apenas Energia</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Período</label>
                    <select id="filtroPeriodo" onchange="toggleCustomDate()">
                        <option value="all">Todos os Registros</option>
                        <option value="today">Dia Atual</option>
                        <option value="custom">Período Personalizado</option>
                    </select>
                </div>
                <div class="form-group" id="dataInicioGroup" style="margin-bottom: 0; display: none;">
                    <label>Data Início</label>
                    <input type="date" id="dataInicio">
                </div>
                <div class="form-group" id="dataFimGroup" style="margin-bottom: 0; display: none;">
                    <label>Data Fim</label>
                    <input type="date" id="dataFim">
                </div>
            </div>
            <div class="filter-buttons">
                <button class="btn btn-secondary" onclick="aplicarFiltros()">
                    <span class="material-icons">search</span>
                    Aplicar Filtros
                </button>
                <button class="btn btn-primary" onclick="limparFiltros()">
                    <span class="material-icons">clear</span>
                    Limpar Filtros
                </button>
            </div>
        </div>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Tipo</th>
                        <th>Data/Hora</th>
                        <th>Nome</th>
                        <th>Matrícula</th>
                        <th style="text-align: right;">Leitura Anterior</th>
                        <th style="text-align: right;">Leitura Atual</th>
                        <th style="text-align: right;">Consumo</th>
                    </tr>
                </thead>
                <tbody id="historicoBody">
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                            Nenhum registro encontrado. Faça o primeiro registro!
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="fecharModal()">&times;</span>
        <h2>Editar Registro Offline</h2>
        <form id="editForm" onsubmit="salvarEdicao(event)">
            <input type="hidden" id="editIndex">
            <input type="hidden" id="editTipo">
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Nome Completo *</label>
                    <input type="text" id="editNome" required>
                </div>
                <div class="form-group">
                    <label>Matrícula Residencial *</label>
                    <input type="text" id="editMatricula" required>
                </div>
                <div class="form-group">
                    <label>Data e Hora *</label>
                    <input type="datetime-local" id="editDataHora" required>
                </div>
                <div class="form-group">
                    <label id="labelLeituraAnterior">Leitura Anterior (m³)</label>
                    <input type="number" id="editLeituraAnterior" step="0.01" readonly>
                </div>
                <div class="form-group">
                    <label id="labelLeituraAtual">Leitura Atual do Medidor (m³) *</label>
                    <input type="number" id="editLeituraAtual" step="0.01" required oninput="calcularConsumoModal()">
                </div>
                <div class="form-group">
                    <label id="labelConsumoTotal">Consumo Total Calculado (m³)</label>
                    <input type="number" id="editConsumoTotal" step="0.01" readonly>
                </div>
                <div class="form-group">
                    <label>Extra 1 (Opcional)</label>
                    <input type="text" id="editExtra1">
                </div>
                <div class="form-group">
                    <label>Extra 2 (Opcional)</label>
                    <input type="text" id="editExtra2">
                </div>
                <div class="form-group">
                    <label>Extra 3 (Opcional)</label>
                    <input type="text" id="editExtra3">
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary btn-full" style="margin-top: 20px;">
                <span class="material-icons">save</span>
                Salvar Edição
            </button>
            <div class="alert" id="alertEditModal"></div>
        </form>
    </div>
</div>

<script>
let scriptURL = '';
let sheetID = '';
let leituraAnteriorAgua = 0;
let leituraAnteriorEnergia = 0;
let isProcessing = false;
let todosRegistrosOnline = [];
let todosRegistrosOffline = [];

window.onload = function() {
    carregarConfiguracao();
    setDataHoraAtual();
    setInterval(atualizarRelogio, 1000);
    
    const nomeInput = document.querySelectorAll('input[name="nome"]');
    const matriculaInput = document.querySelectorAll('input[name="matricula"]');
    
    const ultimoNome = localStorage.getItem('ultimoNome') || '';
    const ultimaMatricula = localStorage.getItem('ultimaMatricula') || '';
    
    nomeInput.forEach(input => input.value = ultimoNome);
    matriculaInput.forEach(input => input.value = ultimaMatricula);
    
    // Define as datas do filtro de consumo diário para o mês atual
    const now = new Date();
    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
    const today = now.toISOString().split('T')[0];
    document.getElementById('dailyDataInicio').value = firstDay;
    document.getElementById('dailyDataFim').value = today;

    if (scriptURL && sheetID) {
        carregarDados();
    }

    carregarRegistrosPendentes();
};

function setDataHoraAtual() {
    const now = new Date();
    const localDate = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
    document.getElementById('dataHoraAgua').value = localDate;
    document.getElementById('dataHoraEnergia').value = localDate;
}

function atualizarRelogio() {
    const now = new Date();
    document.getElementById('lastUpdate').textContent = now.toLocaleTimeString('pt-BR');
}

function carregarConfiguracao() {
    scriptURL = localStorage.getItem('scriptURL') || '';
    sheetID = localStorage.getItem('sheetID') || '';
    
    document.getElementById('scriptURL').value = scriptURL;
    document.getElementById('sheetID').value = sheetID;
    
    if (scriptURL && sheetID) {
        document.getElementById('connectionStatus').textContent = 'Conectado';
        document.getElementById('connectionStatus').style.color = 'var(--success)';
    } else {
        document.getElementById('connectionStatus').textContent = 'Não Configurado';
        document.getElementById('connectionStatus').style.color = 'var(--error)';
    }
}

function salvarConfiguracao() {
    const urlInput = document.getElementById('scriptURL').value.trim();
    const idInput = document.getElementById('sheetID').value.trim();
    
    if (!urlInput || !idInput) {
        mostrarAlerta('configAlert', 'Por favor, preencha todos os campos de configuração!', 'error');
        return;
    }
    
    if (!urlInput.includes('/exec')) {
        mostrarAlerta('configAlert', 'A URL do Apps Script deve terminar com /exec', 'error');
        return;
    }
    
    localStorage.setItem('scriptURL', urlInput);
    localStorage.setItem('sheetID', idInput);
    
    scriptURL = urlInput;
    sheetID = idInput;
    
    document.getElementById('connectionStatus').textContent = 'Conectado';
    document.getElementById('connectionStatus').style.color = 'var(--success)';
    
    mostrarAlerta('configAlert', 'Configuração salva com sucesso!', 'success');

    if (scriptURL && sheetID) {
        carregarDados();
    }
}

async function testarConexao() {
    if (!scriptURL || !sheetID) {
        mostrarAlerta('configAlert', 'Configure primeiro o sistema!', 'error');
        return;
    }
    
    try {
        document.getElementById('connectionStatus').textContent = 'Testando...';
        
        const response = await fetch(`${scriptURL}?action=test&sheetId=${sheetID}`);
        const data = await response.json();
        
        if (data.status === 'success') {
            mostrarAlerta('configAlert', 'Conexão estabelecida com sucesso!', 'success');
            document.getElementById('connectionStatus').textContent = 'Conectado';
            document.getElementById('connectionStatus').style.color = 'var(--success)';
            carregarDados();
        } else {
            throw new Error(data.message || 'Erro na conexão');
        }
    } catch (error) {
        mostrarAlerta('configAlert', 'Erro ao conectar: ' + error.message, 'error');
        document.getElementById('connectionStatus').textContent = 'Erro';
        document.getElementById('connectionStatus').style.color = 'var(--error)';
    }
}

async function carregarDados() {
    await carregarHistorico();
    // Após carregar o histórico, os totais e médias serão calculados
    calcularEstatisticasGerais(); 
}

// REMOVIDA A FUNÇÃO carregarUltimasLeituras() - Os dados serão obtidos e calculados a partir do histórico completo

function calcularEstatisticasGerais() {
    let totalAguaLeitura = 0;
    let totalEnergiaLeitura = 0;
    let totalConsumoAgua = 0;
    let totalConsumoEnergia = 0;
    let primeiraData = null;
    let ultimaData = null;

    if (todosRegistrosOnline.length === 0) {
        // Se não houver registros, reseta os valores
        leituraAnteriorAgua = 0;
        leituraAnteriorEnergia = 0;
        document.getElementById('leituraAnteriorAgua').value = '0.00';
        document.getElementById('leituraAnteriorEnergia').value = '0.00';
        document.getElementById('leituraAtualAgua').value = '0.00';
        document.getElementById('leituraAtualEnergia').value = '0.00';
        document.getElementById('totalAgua').textContent = '0.00 m³';
        document.getElementById('totalEnergia').textContent = '0.00 kWh';
        document.getElementById('mediaDiariaAgua').textContent = '0.00 m³/dia';
        document.getElementById('mediaDiariaEnergia').textContent = '0.00 kWh/dia';
        document.getElementById('consumoHojeAgua').textContent = '0.00 m³'; // Resetar Consumo Hoje
        document.getElementById('consumoHojeEnergia').textContent = '0.00 kWh'; // Resetar Consumo Hoje
        return;
    }

    // 1. Encontrar a última leitura e o total de consumo
    const ultimasLeituras = {
        agua: { leitura: 0, consumo: 0, data: null },
        energia: { leitura: 0, consumo: 0, data: null }
    };
    
    // Agrupar por tipo e ordenar por data para obter as últimas leituras
    const registrosAgua = todosRegistrosOnline.filter(r => r.tipo === 'agua').sort((a, b) => new Date(a.dataHora) - new Date(b.dataHora));
    const registrosEnergia = todosRegistrosOnline.filter(r => r.tipo === 'energia').sort((a, b) => new Date(a.dataHora) - new Date(b.dataHora));

    // Determinar a última leitura (leituraAtual do registro mais recente)
    if (registrosAgua.length > 0) {
        const ultimoAgua = registrosAgua[registrosAgua.length - 1];
        totalAguaLeitura = parseFloat(ultimoAgua.leituraAtual || 0);
        ultimasLeituras.agua.data = new Date(ultimoAgua.dataHora);
    }
    if (registrosEnergia.length > 0) {
        const ultimoEnergia = registrosEnergia[registrosEnergia.length - 1];
        totalEnergiaLeitura = parseFloat(ultimoEnergia.leituraAtual || 0);
        ultimasLeituras.energia.data = new Date(ultimoEnergia.dataHora);
    }

    // Calcular o consumo total a partir da diferença da primeira leitura com a última
    if (registrosAgua.length > 0) {
        const primeiroAgua = registrosAgua[0];
        totalConsumoAgua = totalAguaLeitura - parseFloat(primeiroAgua.leituraAnterior || 0);
        primeiraData = primeiraData ? Math.min(primeiraData, new Date(primeiroAgua.dataHora)) : new Date(primeiroAgua.dataHora);
    }
    if (registrosEnergia.length > 0) {
        const primeiroEnergia = registrosEnergia[0];
        totalConsumoEnergia = totalEnergiaLeitura - parseFloat(primeiroEnergia.leituraAnterior || 0);
        primeiraData = primeiraData ? Math.min(primeiraData, new Date(primeiroEnergia.dataHora)) : new Date(primeiroEnergia.dataHora);
    }

    // 2. Definir Leitura Anterior para novos registros e a Última Leitura para os totais
    leituraAnteriorAgua = totalAguaLeitura;
    leituraAnteriorEnergia = totalEnergiaLeitura;

    document.getElementById('leituraAnteriorAgua').value = leituraAnteriorAgua.toFixed(2);
    document.getElementById('leituraAnteriorEnergia').value = leituraAnteriorEnergia.toFixed(2);
    document.getElementById('leituraAtualAgua').value = leituraAnteriorAgua.toFixed(2);
    document.getElementById('leituraAtualEnergia').value = leituraAnteriorEnergia.toFixed(2);

    document.getElementById('totalAgua').textContent = totalAguaLeitura.toFixed(2) + ' m³';
    document.getElementById('totalEnergia').textContent = totalEnergiaLeitura.toFixed(2) + ' kWh';

    // 3. Calcular Média Diária Geral
    let diasTotais = 0;
    ultimaData = new Date();
    if (primeiraData) {
        // Calcula a diferença em milissegundos, divide por (1000 * 60 * 60 * 24) para obter dias
        diasTotais = Math.ceil((ultimaData.getTime() - primeiraData.getTime()) / (1000 * 60 * 60 * 24));
        diasTotais = Math.max(1, diasTotais); // Garante que seja pelo menos 1 dia
    }
    
    const mediaAgua = diasTotais > 0 ? (totalConsumoAgua / diasTotais) : 0;
    const mediaEnergia = diasTotais > 0 ? (totalConsumoEnergia / diasTotais) : 0;

    document.getElementById('mediaDiariaAgua').textContent = mediaAgua.toFixed(2) + ' m³/dia';
    document.getElementById('mediaDiariaEnergia').textContent = mediaEnergia.toFixed(2) + ' kWh/dia';

    // 4. Consumo Hoje (Ajustado para o novo cálculo de consumo diário)
    const consumoHoje = calcularConsumoDiarioPorData(new Date().toISOString().split('T')[0]);
    document.getElementById('consumoHojeAgua').textContent = (consumoHoje.agua || 0).toFixed(2) + ' m³';
    document.getElementById('consumoHojeEnergia').textContent = (consumoHoje.energia || 0).toFixed(2) + ' kWh';

    // 5. Recalcular Consumo (para atualizar o display caso o campo de leitura atual não esteja vazio)
    calcularConsumo('agua');
    calcularConsumo('energia');
}

// Função auxiliar para obter a data no formato AAAA-MM-DD
function toYYYYMMDD(date) {
    const d = new Date(date);
    d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
    return d.toISOString().split('T')[0];
}

// Função que calcula o consumo em um dia específico (o valor da diferença entre a última e a primeira leitura do dia)
function calcularConsumoDiarioPorData(dataString) {
    const registrosDoDia = todosRegistrosOnline
        .filter(r => toYYYYMMDD(r.dataHora) === dataString)
        .sort((a, b) => new Date(a.dataHora) - new Date(b.dataHora));

    let consumoAgua = 0;
    let consumoEnergia = 0;

    const regAgua = registrosDoDia.filter(r => r.tipo === 'agua');
    const regEnergia = registrosDoDia.filter(r => r.tipo === 'energia');

    if (regAgua.length > 0) {
        const primeiraLeitura = parseFloat(regAgua[0].leituraAnterior || 0);
        const ultimaLeitura = parseFloat(regAgua[regAgua.length - 1].leituraAtual || 0);
        consumoAgua = Math.max(0, ultimaLeitura - primeiraLeitura);
    }
    if (regEnergia.length > 0) {
        const primeiraLeitura = parseFloat(regEnergia[0].leituraAnterior || 0);
        const ultimaLeitura = parseFloat(regEnergia[regEnergia.length - 1].leituraAtual || 0);
        consumoEnergia = Math.max(0, ultimaLeitura - primeiraLeitura);
    }

    return { agua: consumoAgua, energia: consumoEnergia };
}

// NOVA FUNÇÃO: Calcula e exibe o consumo diário entre as datas
function calcularConsumoDiario() {
    const dataInicioStr = document.getElementById('dailyDataInicio').value;
    const dataFimStr = document.getElementById('dailyDataFim').value;
    const tbody = document.getElementById('consumoDiarioBody');

    if (!dataInicioStr || !dataFimStr) {
        tbody.innerHTML = `<tr><td colspan="3" style="text-align: center; padding: 20px; color: var(--error);">Selecione as duas datas!</td></tr>`;
        return;
    }

    const dataInicio = new Date(dataInicioStr);
    const dataFim = new Date(dataFimStr);

    if (dataInicio > dataFim) {
        tbody.innerHTML = `<tr><td colspan="3" style="text-align: center; padding: 20px; color: var(--error);">A Data Início não pode ser maior que a Data Fim!</td></tr>`;
        return;
    }
    
    // Adiciona 1 dia (em milissegundos) à Data Fim para incluir o dia final no loop
    const umDia = 1000 * 60 * 60 * 24;
    
    tbody.innerHTML = '';
    let registroEncontrado = false;

    for (let d = dataInicio; d <= dataFim; d.setDate(d.getDate() + 1)) {
        const dataAtualStr = toYYYYMMDD(d);
        const consumo = calcularConsumoDiarioPorData(dataAtualStr);

        if (consumo.agua > 0 || consumo.energia > 0) {
            registroEncontrado = true;
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${new Date(dataAtualStr).toLocaleDateString('pt-BR')}</td>
                <td style="text-align: right;">${consumo.agua.toFixed(2)} m³</td>
                <td style="text-align: right;">${consumo.energia.toFixed(2)} kWh</td>
            `;
        }
    }
    
    // Volta a data para não influenciar o próximo loop de iteração (apenas por segurança)
    dataFim.setDate(dataFim.getDate() - 1); 

    if (!registroEncontrado) {
        tbody.innerHTML = `<tr><td colspan="3" style="text-align: center; padding: 40px; color: #999;">
            Nenhum consumo registrado no período selecionado.
        </td></tr>`;
    }
}
// FUNÇÕES RESTANTES (carregarHistorico, renderizarHistorico, etc.) PERMANECEM IGUAIS

async function carregarHistorico() {
    if (!scriptURL || !sheetID) {
        console.warn('Configuração ausente.');
        document.getElementById('totalRecords').textContent = '0';
        // Ajusta as leituras para zero se não houver configuração
        calcularEstatisticasGerais(); 
        return;
    }
    
    try {
        // Força a buscar todos para o cálculo de estatísticas
        const response = await fetch(`${scriptURL}?action=getHistory&sheetId=${sheetID}&tipo=all`); 
        const data = await response.json();
        
        if (data.status === 'success' && data.registros && data.registros.length > 0) {
            todosRegistrosOnline = data.registros;
            aplicarFiltros();
        } else {
            todosRegistrosOnline = [];
            renderizarHistorico([]);
        }
    } catch (error) {
        console.error('Erro ao carregar histórico:', error);
        document.getElementById('historicoBody').innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; padding: 40px; color: var(--error);">
                    ❌ Erro ao carregar histórico. Verifique a conexão e configuração.
                </td>
            </tr>
        `;
    }
}

function renderizarHistorico(registros) {
    const tbody = document.getElementById('historicoBody');
    
    if (registros.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                    Nenhum registro encontrado com os filtros aplicados.
                </td>
            </tr>
        `;
        document.getElementById('totalRecords').textContent = '0';
        return;
    }
    
    tbody.innerHTML = '';
    registros.forEach(reg => {
        const row = tbody.insertRow();
        const tipo = String(reg.tipo || '').toLowerCase();
        const unit = tipo === 'agua' ? 'm³' : 'kWh';
        
        let dataFormatada = 'Data Inválida';
        if (reg.dataHora) {
            try {
                const d = new Date(reg.dataHora);
                if (!isNaN(d.getTime())) {
                    dataFormatada = d.toLocaleDateString('pt-BR') + ' ' + d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                }
            } catch (e) {
                console.error('Erro ao formatar data:', e);
            }
        }
        
        row.innerHTML = `
            <td><span class="badge badge-${tipo}">${tipo === 'agua' ? '💧 Água' : '⚡ Energia'}</span></td>
            <td>${dataFormatada}</td>
            <td>${String(reg.nome || 'N/A')}</td>
            <td>${String(reg.matricula || 'N/A')}</td>
            <td style="text-align: right;">${parseFloat(reg.leituraAnterior || 0).toFixed(2)} ${unit}</td>
            <td style="text-align: right; font-weight: 600;">${parseFloat(reg.leituraAtual || 0).toFixed(2)} ${unit}</td>
            <td style="text-align: right; color: var(--success); font-weight: 600;">+${parseFloat(reg.consumoTotal || 0).toFixed(2)} ${unit}</td>
        `;
    });
    
    document.getElementById('totalRecords').textContent = registros.length;
}

function toggleCustomDate() {
    const periodo = document.getElementById('filtroPeriodo').value;
    const showCustom = periodo === 'custom';
    
    document.getElementById('dataInicioGroup').style.display = showCustom ? 'block' : 'none';
    document.getElementById('dataFimGroup').style.display = showCustom ? 'block' : 'none';
}

function aplicarFiltros() {
    const tipoFiltro = document.getElementById('filtroTipo').value;
    const periodoFiltro = document.getElementById('filtroPeriodo').value;
    
    let registrosFiltrados = [...todosRegistrosOnline];
    
    if (tipoFiltro !== 'all') {
        registrosFiltrados = registrosFiltrados.filter(r => String(r.tipo).toLowerCase() === tipoFiltro);
    }
    
    if (periodoFiltro === 'today') {
        const hoje = new Date().toISOString().split('T')[0];
        registrosFiltrados = registrosFiltrados.filter(r => {
            if (!r.dataHora) return false;
            const dataReg = new Date(r.dataHora).toISOString().split('T')[0];
            return dataReg === hoje;
        });
    } else if (periodoFiltro === 'custom') {
        const dataInicio = document.getElementById('dataInicio').value;
        const dataFim = document.getElementById('dataFim').value;
        
        if (dataInicio && dataFim) {
            registrosFiltrados = registrosFiltrados.filter(r => {
                if (!r.dataHora) return false;
                const dataReg = new Date(r.dataHora).toISOString().split('T')[0];
                return dataReg >= dataInicio && dataReg <= dataFim;
            });
        }
    }
    
    renderizarHistorico(registrosFiltrados);
}

function limparFiltros() {
    document.getElementById('filtroTipo').value = 'all';
    document.getElementById('filtroPeriodo').value = 'all';
    document.getElementById('dataInicio').value = '';
    document.getElementById('dataFim').value = '';
    toggleCustomDate();
    aplicarFiltros();
}

function calcularConsumo(tipo) {
    const leituraAtualInput = document.getElementById(`leituraAtual${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
    const consumoTotalInput = document.getElementById(`consumoTotal${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
    
    const leituraAtual = parseFloat(leituraAtualInput.value) || 0;
    const leituraAnterior = tipo === 'agua' ? leituraAnteriorAgua : leituraAnteriorEnergia;
    
    const consumo = Math.max(0, leituraAtual - leituraAnterior);
    consumoTotalInput.value = consumo.toFixed(2);
    
    const display = document.getElementById(`consumptionDisplay${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
    const valueDisplay = document.getElementById(`consumptionValue${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
    
    if (consumo > 0) {
        display.style.display = 'block';
        valueDisplay.textContent = consumo.toFixed(2) + (tipo === 'agua' ? ' m³' : ' kWh');
    } else {
        display.style.display = 'none';
    }
}

async function handleSubmit(event, tipo) {
    event.preventDefault();
    
    if (isProcessing) {
        mostrarAlerta(`alert${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`, 'Aguarde o envio anterior ser concluído!', 'error');
        return;
    }
    
    isProcessing = true;
    const form = event.target;
    const btn = form.querySelector('button[type="submit"]');
    const originalHTML = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '<div class="loading"></div> Enviando...';

    const formData = new FormData(form);
    const dataToSend = {
        tipo: tipo,
        nome: formData.get('nome'),
        matricula: formData.get('matricula'),
        dataHora: formData.get('dataHora'),
        leituraAnterior: tipo === 'agua' ? leituraAnteriorAgua.toFixed(2) : leituraAnteriorEnergia.toFixed(2),
        leituraAtual: parseFloat(formData.get('leituraAtual') || 0).toFixed(2),
        consumoTotal: parseFloat(formData.get('consumoTotal') || 0).toFixed(2),
        extra1: formData.get('extra1') || '',
        extra2: formData.get('extra2') || '',
        extra3: formData.get('extra3') || '',
        timestamp: new Date().toISOString()
    };

    localStorage.setItem('ultimoNome', dataToSend.nome);
    localStorage.setItem('ultimaMatricula', dataToSend.matricula);

    let success = false;

    if (scriptURL && sheetID) {
        try {
            const onlineFormData = new FormData();
            onlineFormData.append('action', 'addRecord');
            onlineFormData.append('tipo', tipo);
            onlineFormData.append('sheetId', sheetID);

            for (const key in dataToSend) {
                if (key !== 'tipo' && key !== 'timestamp') {
                    onlineFormData.append(key, dataToSend[key]);
                }
            }
            
            const response = await fetch(scriptURL, {
                method: 'POST',
                body: onlineFormData
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                mostrarAlerta(`alert${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`, '✅ Registro salvo ONLINE com sucesso!', 'success');
                success = true;
            } else {
                throw new Error(result.message || 'Erro ao salvar online, salvando offline...');
            }
        } catch (error) {
            console.error('Falha no envio online. Salvando offline.', error);
            salvarRegistroOffline(dataToSend);
            mostrarAlerta(`alert${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`, `⚠️ Falha no envio ONLINE. Registro salvo OFFLINE. ${error.message}`, 'warning');
        }
    } else {
        salvarRegistroOffline(dataToSend);
        mostrarAlerta(`alert${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`, '⚠️ Sistema não configurado. Registro salvo OFFLINE.', 'warning');
    }
    
    if (success) {
        await carregarDados(); // Recarrega histórico, estatísticas e leituras anteriores
    }
    carregarRegistrosPendentes();
    
    const nome = dataToSend.nome;
    const matricula = dataToSend.matricula;
    form.reset();
    form.querySelector('input[name="nome"]').value = nome;
    form.querySelector('input[name="matricula"]').value = matricula;
    setDataHoraAtual();
    
    document.getElementById(`consumptionDisplay${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`).style.display = 'none';

    isProcessing = false;
    btn.disabled = false;
    btn.innerHTML = originalHTML;

    // A chamada carregarDados() já chama calcularEstatisticasGerais(), que atualiza as leituras.
    // Então, carregarUltimasLeituras() é desnecessário aqui.
    // carregarUltimasLeituras(); 
}

function getRegistrosOffline() {
    const json = localStorage.getItem('registrosOffline');
    return json ? JSON.parse(json) : [];
}

function setRegistrosOffline(registros) {
    localStorage.setItem('registrosOffline', JSON.stringify(registros));
    document.getElementById('pendingRecordsCount').textContent = registros.length;
    carregarRegistrosPendentes();
}

function salvarRegistroOffline(registro) {
    const registros = getRegistrosOffline();
    registros.push(registro);
    setRegistrosOffline(registros);
}

function carregarRegistrosPendentes() {
    todosRegistrosOffline = getRegistrosOffline();
    aplicarFiltrosOffline();
    
    const card = document.getElementById('pendingRecordsCard');
    const badge = document.getElementById('pendingCountBadge');
    
    badge.textContent = todosRegistrosOffline.length;
    card.style.display = todosRegistrosOffline.length > 0 ? 'block' : 'none';
}

function renderizarRegistrosOffline(registros) {
    const tbody = document.getElementById('registrosPendentesBody');
    
    if (registros.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                    Nenhum registro offline encontrado com os filtros aplicados.
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = '';
    registros.forEach((reg, index) => {
        const indexOriginal = todosRegistrosOffline.indexOf(reg);
        const row = tbody.insertRow();
        row.classList.add('offline-row');
        const tipo = String(reg.tipo || '').toLowerCase();
        const unit = tipo === 'agua' ? 'm³' : 'kWh';

        let dataFormatada = 'Data Inválida';
        if (reg.dataHora) {
            try {
                const d = new Date(reg.dataHora);
                if (!isNaN(d.getTime())) {
                    dataFormatada = d.toLocaleDateString('pt-BR') + ' ' + d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                }
            } catch (e) {
                console.error('Erro ao formatar data:', e);
            }
        }
        
        row.innerHTML = `
            <td><span class="badge badge-offline">${tipo === 'agua' ? '💧 Água' : '⚡ Energia'}</span></td>
            <td>${dataFormatada}</td>
            <td>${String(reg.nome || 'N/A')}</td>
            <td>${String(reg.matricula || 'N/A')}</td>
            <td style="text-align: right; font-weight: 600;">${parseFloat(reg.leituraAtual || 0).toFixed(2)} ${unit}</td>
            <td style="text-align: right; color: var(--success); font-weight: 600;">+${parseFloat(reg.consumoTotal || 0).toFixed(2)} ${unit}</td>
            <td>
                <button class="btn btn-edit" onclick="abrirModalEdicao(${indexOriginal})">
                    <span class="material-icons" style="font-size: 14px;">edit</span>
                    Editar
                </button>
                <button class="btn btn-danger" onclick="excluirRegistroOffline(${indexOriginal})">
                    <span class="material-icons" style="font-size: 14px;">delete</span>
                    Excluir
                </button>
            </td>
        `;
    });
}

function toggleCustomDateOffline() {
    const periodo = document.getElementById('filtroPeriodoOffline').value;
    const showCustom = periodo === 'custom';
    
    document.getElementById('dataInicioGroupOffline').style.display = showCustom ? 'block' : 'none';
    document.getElementById('dataFimGroupOffline').style.display = showCustom ? 'block' : 'none';
}

function aplicarFiltrosOffline() {
    const tipoFiltro = document.getElementById('filtroTipoOffline').value;
    const periodoFiltro = document.getElementById('filtroPeriodoOffline').value;
    
    let registrosFiltrados = [...todosRegistrosOffline];
    
    if (tipoFiltro !== 'all') {
        registrosFiltrados = registrosFiltrados.filter(r => String(r.tipo).toLowerCase() === tipoFiltro);
    }
    
    if (periodoFiltro === 'today') {
        const hoje = new Date().toISOString().split('T')[0];
        registrosFiltrados = registrosFiltrados.filter(r => {
            if (!r.dataHora) return false;
            const dataReg = new Date(r.dataHora).toISOString().split('T')[0];
            return dataReg === hoje;
        });
    } else if (periodoFiltro === 'custom') {
        const dataInicio = document.getElementById('dataInicioOffline').value;
        const dataFim = document.getElementById('dataFimOffline').value;
        
        if (dataInicio && dataFim) {
            registrosFiltrados = registrosFiltrados.filter(r => {
                if (!r.dataHora) return false;
                const dataReg = new Date(r.dataHora).toISOString().split('T')[0];
                return dataReg >= dataInicio && dataReg <= dataFim;
            });
        }
    }
    
    renderizarRegistrosOffline(registrosFiltrados);
}

function limparFiltrosOffline() {
    document.getElementById('filtroTipoOffline').value = 'all';
    document.getElementById('filtroPeriodoOffline').value = 'all';
    document.getElementById('dataInicioOffline').value = '';
    document.getElementById('dataFimOffline').value = '';
    toggleCustomDateOffline();
    aplicarFiltrosOffline();
}

function excluirRegistroOffline(index) {
    if (!confirm('Tem certeza de que deseja excluir este registro offline? Esta ação não pode ser desfeita.')) {
        return;
    }
    const registros = getRegistrosOffline();
    registros.splice(index, 1);
    setRegistrosOffline(registros);
    mostrarAlerta('syncAlert', 'Registro excluído com sucesso!', 'success');
}

function limparTodosRegistrosOffline() {
    const registros = getRegistrosOffline();
    
    if (registros.length === 0) {
        mostrarAlerta('syncAlert', 'Não há registros offline para limpar.', 'warning');
        return;
    }
    
    if (!confirm(`⚠️ ATENÇÃO: Você tem CERTEZA ABSOLUTA de que deseja EXCLUIR TODOS os ${registros.length} registros pendentes offline?\n\n❌ Esta ação é IRREVERSÍVEL e os dados serão PERDIDOS PERMANENTEMENTE!\n\n✅ Clique em OK para confirmar a exclusão\n❌ Clique em Cancelar para manter os registros`)) {
        return;
    }
    
    if (!confirm(`🚨 ÚLTIMA CONFIRMAÇÃO!\n\nVocê está prestes a excluir ${registros.length} registro(s) offline.\n\nTem certeza de que deseja continuar?`)) {
        return;
    }
    
    setRegistrosOffline([]);
    mostrarAlerta('syncAlert', `✅ Todos os ${registros.length} registros offline foram excluídos com sucesso.`, 'warning');
}

async function sincronizarRegistrosPendentes() {
    if (isProcessing) {
        mostrarAlerta('syncAlert', 'Aguarde a sincronização anterior ser concluída!', 'error');
        return;
    }

    if (!scriptURL || !sheetID) {
        mostrarAlerta('syncAlert', 'Configure o sistema (URL e ID) primeiro!', 'error');
        return;
    }

    const registros = getRegistrosOffline();
    if (registros.length === 0) {
        mostrarAlerta('syncAlert', 'Não há registros pendentes para sincronizar!', 'warning');
        return;
    }

    isProcessing = true;
    const btn = document.querySelector('.btn-warning');
    const originalHTML = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '<div class="loading"></div> Sincronizando...';

    const payload = registros.map(reg => ({
        tipo: reg.tipo,
        nome: reg.nome,
        matricula: reg.matricula,
        dataHora: reg.dataHora,
        leituraAnterior: reg.leituraAnterior,
        leituraAtual: reg.leituraAtual,
        consumoTotal: reg.consumoTotal,
        extra1: reg.extra1,
        extra2: reg.extra2,
        extra3: reg.extra3,
    }));

    try {
        const response = await fetch(`${scriptURL}?action=addBatchRecords&sheetId=${sheetID}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ records: payload })
        });

        const result = await response.json();

        if (result.status === 'success') {
            setRegistrosOffline([]);
            mostrarAlerta('syncAlert', `✅ ${result.count || registros.length} registros sincronizados com sucesso!`, 'success');
            await carregarDados();
        } else {
            throw new Error(result.message || 'Erro desconhecido ao sincronizar em lote.');
        }

    } catch (error) {
        mostrarAlerta('syncAlert', '❌ Erro na sincronização: ' + error.message, 'error');
        console.error('Erro de sincronização:', error);
    } finally {
        isProcessing = false;
        btn.disabled = false;
        btn.innerHTML = originalHTML;
        carregarRegistrosPendentes();
    }
}

function abrirModalEdicao(index) {
    const registros = getRegistrosOffline();
    const reg = registros[index];
    const tipo = reg.tipo;
    const unit = tipo === 'agua' ? 'm³' : 'kWh';

    document.getElementById('editIndex').value = index;
    document.getElementById('editTipo').value = tipo;
    
    document.getElementById('labelLeituraAnterior').textContent = `Leitura Anterior (${unit})`;
    document.getElementById('labelLeituraAtual').textContent = `Leitura Atual do Medidor (${unit}) *`;
    document.getElementById('labelConsumoTotal').textContent = `Consumo Total Calculado (${unit})`;

    document.getElementById('editNome').value = reg.nome;
    document.getElementById('editMatricula').value = reg.matricula;
    document.getElementById('editDataHora').value = reg.dataHora.slice(0, 16);
    document.getElementById('editLeituraAnterior').value = reg.leituraAnterior;
    document.getElementById('editLeituraAtual').value = reg.leituraAtual;
    document.getElementById('editConsumoTotal').value = reg.consumoTotal;
    document.getElementById('editExtra1').value = reg.extra1;
    document.getElementById('editExtra2').value = reg.extra2;
    document.getElementById('editExtra3').value = reg.extra3;
    
    document.getElementById('editModal').style.display = 'block';
}

function calcularConsumoModal() {
    const leituraAtual = parseFloat(document.getElementById('editLeituraAtual').value) || 0;
    const leituraAnterior = parseFloat(document.getElementById('editLeituraAnterior').value) || 0;
    
    const consumo = Math.max(0, leituraAtual - leituraAnterior);
    document.getElementById('editConsumoTotal').value = consumo.toFixed(2);
}

function salvarEdicao(event) {
    event.preventDefault();

    const index = parseInt(document.getElementById('editIndex').value);
    const tipo = document.getElementById('editTipo').value;
    const registros = getRegistrosOffline();
    
    calcularConsumoModal();

    const registroEditado = {
        tipo: tipo,
        nome: document.getElementById('editNome').value,
        matricula: document.getElementById('editMatricula').value,
        dataHora: document.getElementById('editDataHora').value,
        leituraAnterior: parseFloat(document.getElementById('editLeituraAnterior').value).toFixed(2),
        leituraAtual: parseFloat(document.getElementById('editLeituraAtual').value).toFixed(2),
        consumoTotal: parseFloat(document.getElementById('editConsumoTotal').value).toFixed(2),
        extra1: document.getElementById('editExtra1').value,
        extra2: document.getElementById('editExtra2').value,
        extra3: document.getElementById('editExtra3').value,
        timestamp: registros[index].timestamp
    };

    registros[index] = registroEditado;
    setRegistrosOffline(registros);
    mostrarAlerta('alertEditModal', 'Registro atualizado com sucesso no modo offline!', 'success');
    
    setTimeout(() => {
        fecharModal();
    }, 1500);
}

function fecharModal() {
    document.getElementById('editModal').style.display = 'none';
    document.getElementById('alertEditModal').classList.remove('show');
}

window.onclick = function(event) {
    const modal = document.getElementById('editModal');
    if (event.target === modal) {
        fecharModal();
    }
}

function mostrarAlerta(elementId, mensagem, tipo) {
    const alert = document.getElementById(elementId);
    alert.className = `alert alert-${tipo} show`;
    alert.innerHTML = `
        <span class="material-icons">${tipo === 'success' ? 'check_circle' : (tipo === 'warning' ? 'warning' : 'error')}</span>
        ${mensagem}
    `;
    
    setTimeout(() => {
        alert.classList.remove('show');
    }, 8000);
}
</script>

</body>
</html>
